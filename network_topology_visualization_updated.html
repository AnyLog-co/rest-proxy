<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Topology & Infrastructure Visualization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1900px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #1e3c72;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #1e3c72;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e3c72;
        }
        
        #topology-canvas {
            width: 100%;
            height: 900px;
            background: #f8f9fa;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        #topology-canvas:hover {
            cursor: crosshair;
        }
        
        .canvas-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            white-space: nowrap;
        }
        
        .topology-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .control-button {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .control-button:hover {
            background: #2a5298;
            transform: translateY(-1px);
        }
        
        .control-button.active {
            background: #4CAF50;
        }
        
        .control-button.paused {
            background: #ff9800;
            animation: pulse-warning 2s infinite;
        }
        
        .control-button.paused:hover {
            background: #ff5722;
        }
        
        @keyframes pulse-warning {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
        }
        
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .legend-icon {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
        }
        
        .legend-icon.host {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .legend-icon.nic {
            background: #2196F3;
            color: white;
        }
        
        .legend-icon.switch {
            background: #ff9800;
            color: white;
        }
        
        .legend-icon.container {
            background: #00bcd4;
            color: white;
        }
        
        .legend-icon.status-up {
            background: #4CAF50;
        }
        
        .legend-icon.status-down {
            background: #f44336;
        }
        
        .detail-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 350px;
            max-height: 700px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 15px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .detail-panel.visible {
            display: block;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1e3c72;
        }
        
        .detail-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #1e3c72;
        }
        
        .detail-close {
            cursor: pointer;
            font-size: 1.5em;
            color: #999;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .detail-close:hover {
            background: #f44336;
            color: white;
        }
        
        .detail-section {
            margin-bottom: 15px;
        }
        
        .detail-section-title {
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }
        
        .detail-label {
            color: #666;
        }
        
        .detail-value {
            font-weight: 600;
            color: #333;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-badge.up {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.down {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-badge.running {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-badge.stopped {
            background: #f8d7da;
            color: #721c24;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        
        th {
            background: #1e3c72;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        /* ‚îÄ‚îÄ AnyLog REST Proxy controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .proxy-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 15px;padding:10px 12px;background:#f6f8fa;border:1px solid #e5e7eb;border-radius:8px;}
        .proxy-controls label{font-size:12px;color:#334155;display:flex;gap:6px;align-items:center;}
        .proxy-controls input{padding:6px 8px;border:1px solid #cbd5e1;border-radius:6px;font-size:12px;}
        .proxy-title{font-weight:700;color:#1e3c72;margin-right:6px;}
        .proxy-status{font-size:12px;padding:3px 8px;border-radius:999px;background:#e2e8f0;color:#334155;}
        .proxy-status.ok{background:#dcfce7;color:#166534;}
        .proxy-status.err{background:#fee2e2;color:#991b1b;}

        /* ‚îÄ‚îÄ API Call Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .log-panel{position:fixed;right:16px;bottom:16px;width:560px;max-width:calc(100vw - 32px);background:#0d1117;color:#e6edf3;border:1px solid #30363d;border-radius:10px;box-shadow:0 20px 60px rgba(0,0,0,.5);font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;z-index:9999;}
        .log-header{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;user-select:none;}
        .log-title{font-weight:700;}
        .log-stats{margin-left:auto;display:flex;gap:8px;font-size:11px;opacity:.9;}
        .log-stat{padding:2px 6px;border-radius:999px;background:#161b22;border:1px solid #30363d;}
        .log-stat.ok{background:rgba(35,134,54,.2);border-color:rgba(35,134,54,.4);}
        .log-stat.err{background:rgba(248,81,73,.2);border-color:rgba(248,81,73,.4);}
        .log-caret{opacity:.8;transition:.15s transform;}
        .log-caret.open{transform:rotate(180deg);}
        .log-content{border-top:1px solid #30363d;}
        .log-tools{display:flex;gap:6px;align-items:center;padding:8px 10px;border-bottom:1px solid #30363d;flex-wrap:wrap;}
        #logSearch{flex:1;min-width:160px;background:#0b0f14;color:#e6edf3;border:1px solid #30363d;border-radius:6px;padding:6px 8px;font-size:11px;}
        .log-filter-btn{background:#161b22;color:#e6edf3;border:1px solid #30363d;border-radius:6px;padding:5px 8px;font-size:11px;cursor:pointer;}
        .log-filter-btn.active{border-color:#58a6ff;color:#58a6ff;}
        .log-body{max-height:240px;overflow:auto;}
        .log-placeholder{padding:16px;text-align:center;color:#8b949e;font-size:11px;}
        .log-entry{display:grid;grid-template-columns:72px 52px 54px 62px 1fr 120px 60px;gap:8px;padding:6px 10px;border-bottom:1px solid #21262d;font-size:11px;align-items:center;}
        .log-entry:hover{background:#161b22;}
        .le-method{padding:2px 6px;border-radius:999px;text-align:center;}
        .m-get{background:rgba(88,166,255,.15);border:1px solid rgba(88,166,255,.35);}
        .m-post{background:rgba(163,113,247,.15);border:1px solid rgba(163,113,247,.35);}
        .le-status{padding:2px 6px;border-radius:999px;text-align:center;}
        .s-ok{background:rgba(35,134,54,.2);border:1px solid rgba(35,134,54,.4);}
        .s-err{background:rgba(248,81,73,.2);border:1px solid rgba(248,81,73,.4);}
        .le-path{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .le-detail{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#8b949e;}
        .le-rows{text-align:right;color:#8b949e;}


    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåê Network Topology & Infrastructure Visualization</h1>
            <p style="color: #666; margin-top: 10px;">
                Interactive view of hosts, NICs, switches, and docker containers with real-time status
                <span id="pausedIndicator" style="display: none; margin-left: 15px; color: #ff9800; font-weight: bold;">‚è∏ AUTO-REFRESH PAUSED</span>
            </p>
        </header>
        
        <!-- Statistics Overview -->
        <div class="grid">
            <div class="stat-card">
                <div class="stat-value" id="hostCount">0</div>
                <div class="stat-label">Host Systems</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="nicCount">0</div>
                <div class="stat-label">Network Interfaces</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="switchCount">0</div>
                <div class="stat-label">Switches</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="containerCount">0</div>
                <div class="stat-label">Docker Containers</div>
            </div>
        </div>
        
        <!-- Topology Visualization -->
        <div class="card">
            <h2>üîÄ Interactive Network Topology</h2>

            <div class="proxy-controls">
                <div class="proxy-title">üîå AnyLog REST Proxy</div>
                <label>Host <input id="cfgHost" placeholder="localhost" style="width:140px;"></label>
                <label>Port <input id="cfgPort" placeholder="8080" style="width:90px;"></label>
                <label>DBMS <input id="cfgDbms" placeholder="database_name" style="width:160px;"></label>
                <button class="control-button" onclick="connectProxy()">Connect</button>
                <button class="control-button" onclick="refreshLiveData(true)">Refresh</button>
                <span id="proxyStatus" class="proxy-status">not connected</span>
            </div>

            <div class="topology-controls">
                <button class="control-button" onclick="togglePause()" id="pauseButton">
                    ‚è∏ Pause Auto-Refresh
                </button>

                <div class="control-group" style="display:inline-flex; align-items:center; gap:8px; margin-left:12px;">
                    <label style="font-size:12px; color:#555;">History (min):</label>
                    <input id="historyMinutesInput" type="number" min="1" step="1" value="60" style="width:90px; padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
                    <label style="font-size:12px; color:#555; margin-left:6px;">Refresh (sec):</label>
                    <input id="refreshSecondsInput" type="number" min="2" step="1" value="30" style="width:80px; padding:6px 8px; border:1px solid #ddd; border-radius:6px;">
                    <button class="control-button" onclick="applyRefreshSettings()">Apply</button>
                </div>
    
                <button class="control-button active" onclick="setView('topology')" id="view-topology">
                    Topology View
                </button>
                <button class="control-button" onclick="setView('hierarchy')" id="view-hierarchy">
                    Hierarchy View
                </button>
                <button class="control-button" onclick="toggleLabels()">
                    Toggle Labels
                </button>
                <button class="control-button" onclick="toggleConnectionLabels()">
                    Show Connection Info
                </button>
                <button class="control-button" onclick="resetZoom()">
                    Reset View
                </button>
                <button class="control-button" onclick="zoomIn()">
                    Zoom In +
                </button>
                <button class="control-button" onclick="zoomOut()">
                    Zoom Out -
                </button>
                <button class="control-button" onclick="exportTopology()">
                    Export PNG
                </button>
            </div>
            
            <canvas id="topology-canvas"></canvas>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-icon host">üñ•Ô∏è</div>
                    <span>Host System</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon nic">üîå</div>
                    <span>Network Interface</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon switch">üîÄ</div>
                    <span>Switch</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon container">üê≥</div>
                    <span>Docker Container</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon status-up"></div>
                    <span>Active/Running</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon status-down"></div>
                    <span>Inactive/Stopped</span>
                </div>
            </div>
            
            <!-- Detail Panel -->
            <div class="detail-panel" id="detailPanel">
                <div class="detail-header">
                    <div class="detail-title" id="detailTitle">Details</div>
                    <div class="detail-close" onclick="closeDetailPanel()">√ó</div>
                </div>
                <div id="detailContent"></div>
            </div>
        </div>
        
        <!-- Host Systems Details -->
        <div class="card">
            <h2>üñ•Ô∏è Host Systems & Docker Containers</h2>
            <table>
                <thead>
                    <tr>
                        <th>Host System</th>
                        <th>IP Address</th>
                        <th>NICs</th>
                        <th>Containers</th>
                        <th>Container Status</th>
                        <th>CPU %</th>
                        <th>Memory Usage</th>
                    </tr>
                </thead>
                <tbody id="hostTable">
                    <tr><td colspan="7" style="text-align: center;">Loading host data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- NIC to Switch Mapping -->
        <div class="card">
            <h2>üîå NIC to Switch Connection Mapping</h2>
            <table>
                <thead>
                    <tr>
                        <th>NIC</th>
                        <th>Host</th>
                        <th>IP Address</th>
                        <th>Status</th>
                        <th>Connected to Switch</th>
                        <th>Switch Port</th>
                        <th>Containers Using</th>
                    </tr>
                </thead>
                <tbody id="nicMappingTable">
                    <tr><td colspan="7" style="text-align: center;">Loading NIC mapping...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Docker Container Details -->
        <div class="card">
            <h2>üê≥ Docker Container Infrastructure</h2>
            <table>
                <thead>
                    <tr>
                        <th>Container Name</th>
                        <th>Host System</th>
                        <th>Status</th>
                        <th>Image</th>
                        <th>Ports</th>
                        <th>Network Mode</th>
                        <th>CPU %</th>
                        <th>Memory</th>
                    </tr>
                </thead>
                <tbody id="containerTable">
                    <tr><td colspan="8" style="text-align: center;">Loading container data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>

// ‚îÄ‚îÄ REST PROXY CONFIG (AnyLog REST Proxy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function base() {
  const h = (document.getElementById('cfgHost')?.value || localStorage.getItem('anylog_proxy_host') || 'localhost').trim();
  const p = (document.getElementById('cfgPort')?.value || localStorage.getItem('anylog_proxy_port') || '8080').trim();
  localStorage.setItem('anylog_proxy_host', h);
  localStorage.setItem('anylog_proxy_port', p);
  return `http://${h}:${p}`;
}
function dbms() {
  const v = (document.getElementById('cfgDbms')?.value || localStorage.getItem('anylog_proxy_dbms') || '').trim();
  localStorage.setItem('anylog_proxy_dbms', v);
  return v;
}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function rows(data){
  if(!data) return [];
  if(Array.isArray(data)) return data;
  for(const key of ['Query','rows','data','result']){
    if(data[key]?.rows) return data[key].rows;
    if(Array.isArray(data[key])) return data[key];
  }
  for(const v of Object.values(data)){
    if(Array.isArray(v) && v.length && typeof v[0]==='object') return v;
  }
  return [];
}
function extractTableFromSQL(sql){
  if(!sql) return '';
  const m = sql.match(/FROM\s+(\w+)/i);
  return m ? m[1] : '';
}
function buildAnyLogCmd(proxyPath, body){
  if(!body) return proxyPath;
  if(proxyPath.includes('/query/increment') && body.table){
    const proj = (body.projections||[]).join(', ');
    return `sql ${body.dbms||dbms()} SELECT increment(${body.timeUnit}, ${body.intervalLength}, ${body.timeColumn}, ${proj}) FROM ${body.table} WHERE ${body.timeColumn} >= '${body.startTime}' AND ${body.timeColumn} <= '${body.endTime}'`;
  }
  if(proxyPath.includes('/query') && body.sql){
    return `sql ${body.dbms||dbms()} ${body.sql}`;
  }
  return proxyPath;
}

// ‚îÄ‚îÄ API CALL LOG (ported from enterprise_c_dashboard) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const callLog=[]; let logStats={total:0, ok:0, err:0, rows:0}; let nextLogId=0;
let logOpen=false, logFilter='all';
function setText2(id,val){ const el=document.getElementById(id); if(el) el.textContent=val; }
function updateLogStats(){
  setText2('log-total', `${logStats.total} call${logStats.total!==1?'s':''}`);
  setText2('log-ok', `${logStats.ok} ok`);
  setText2('log-err', `${logStats.err} err`);
  setText2('log-rows', `${logStats.rows} rows`);
}
function logCall(entry){
  const id=nextLogId++;
  const ok=!entry.error && entry.status>=200 && entry.status<300;
  const rec={id, ts:new Date(), ok, ...entry};
  callLog.unshift(rec); if(callLog.length>500) callLog.pop();
  logStats.total++; if(ok) logStats.ok++; else logStats.err++;
  logStats.rows += rec.rowCnt||0;
  updateLogStats();
  if(logOpen) prependLogRow(rec);
  // Always log to console (even if panel not present)
  const msg = `${rec.method} ${rec.path} [${rec.ok?rec.status:'ERR'}] ${Math.round(rec.dur)}ms`;
  if(rec.ok) console.debug(msg, rec); else console.warn(msg, rec.error||rec);
}
function buildLogEntryHTML(rec){
  const time=rec.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const mCls=rec.method==='GET'?'m-get':'m-post';
  const sCls=rec.ok?'s-ok':'s-err';
  const eStat=rec.ok?(rec.status||'200'):(rec.status||'ERR');
  const dur=rec.dur<1000?`${Math.round(rec.dur)}ms`:`${(rec.dur/1000).toFixed(1)}s`;
  const rowTxt=rec.rowCnt>0?rec.rowCnt.toLocaleString():(rec.ok?'0':'‚Äî');
  const detail=(rec.detail||'').length>140?(rec.detail||'').slice(0,140)+'‚Ä¶':(rec.detail||'');
  const tbl=rec.table||'‚Äî';
  return `<div class="log-entry ${rec.ok?'log-ok':'log-err'}" data-method="${rec.method.toLowerCase()}"
               data-ok="${rec.ok}" data-search="${(rec.path+' '+(rec.detail||'')+' '+tbl).toLowerCase()}"
               title="${escHtml(rec.detail||rec.path)}">
      <span class="le-time">${time}</span>
      <span class="le-method ${mCls}">${rec.method}</span>
      <span class="le-status ${sCls}">${eStat}</span>
      <span class="le-dur">${dur}</span>
      <span class="le-path">${escHtml(detail||rec.path)}</span>
      <span class="le-detail">${escHtml(tbl)}</span>
      <span class="le-rows">${rowTxt}</span>
  </div>`;
}
function prependLogRow(rec){
  const body=document.getElementById('logBody'); if(!body) return;
  const ph=body.querySelector('.log-placeholder'); if(ph) ph.remove();
  const tmp=document.createElement('div'); tmp.innerHTML=buildLogEntryHTML(rec);
  body.insertBefore(tmp.firstElementChild, body.firstChild);
  filterLog();
}
function rebuildLogBody(){
  const body=document.getElementById('logBody'); if(!body) return;
  body.innerHTML = callLog.length ? callLog.map(buildLogEntryHTML).join('') :
    '<div class="log-placeholder">‚Äî No API calls yet. ‚Äî</div>';
  filterLog();
}
function toggleLog(){
  logOpen=!logOpen;
  const content=document.getElementById('logContent');
  const caret=document.getElementById('logCaret');
  if(content) content.style.display=logOpen?'block':'none';
  if(caret) caret.classList.toggle('open', logOpen);
  if(logOpen) rebuildLogBody();
}
function clearLog(){ callLog.length=0; logStats={total:0,ok:0,err:0,rows:0}; nextLogId=0; updateLogStats(); rebuildLogBody(); }
function filterLog(){
  const q=(document.getElementById('logSearch')?.value||'').toLowerCase();
  const entries=[...document.querySelectorAll('#logBody .log-entry')];
  for(const el of entries){
    const hay=el.dataset.search||'';
    const okFlag=el.dataset.ok==='true';
    const method=el.dataset.method;
    let vis=true;
    if(logFilter==='error') vis = !okFlag;
    else if(logFilter==='get') vis = method==='get';
    else if(logFilter==='post') vis = method==='post';
    if(vis && q) vis = hay.includes(q);
    el.style.display = vis ? 'grid' : 'none';
  }
}
function setLogFilter(f, btn){
  logFilter=f;
  document.querySelectorAll('.log-filter-btn').forEach(b=>b.classList.remove('active'));
  btn?.classList.add('active');
  filterLog();
}

// ‚îÄ‚îÄ HTTP WRAPPERS (all requests logged) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function GET(path){
  const t0=performance.now(); let status=0, data=null, err=null;
  try{
    const r=await fetch(base()+path, {method:'GET', signal:AbortSignal.timeout(20000)});
    status=r.status;
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    data=await r.json();
    return data;
  }catch(e){ err=e; throw e;
  }finally{
    const dur=performance.now()-t0; const rowCnt=data?rows(data).length:0;
    logCall({method:'GET', path, status: err?(status||0):status, dur, rowCnt, type:'get', detail:path, table:'' , error:err});
  }
}
async function POST(path, body){
  const t0=performance.now(); let status=0, data=null, err=null;
  try{
    const r=await fetch(base()+path,{method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify(body), signal:AbortSignal.timeout(30000)});
    status=r.status;
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    data=await r.json();
    return data;
  }catch(e){ err=e; throw e;
  }finally{
    const dur=performance.now()-t0; const rowCnt=data?rows(data).length:0;
    const sql=body?.sql||''; const tbl=body?.table||extractTableFromSQL(sql);
    logCall({method:'POST', path, status: err?(status||0):status, dur, rowCnt, type:'post',
        detail: buildAnyLogCmd(path, body) || sql || path, table: tbl, error:err});
  }
}


// ‚îÄ‚îÄ LIVE DATA LOADER (uses README.md REST API endpoints) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let proxyConnected = false;
async function connectProxy(){
  const st=document.getElementById('proxyStatus');
  if(st){st.textContent='connecting‚Ä¶'; st.className='proxy-status';}
  try{
    const h=await GET('/health');
    proxyConnected = (h.status||'').toLowerCase()==='healthy' || h.connection==='established' || (h.status||'').toLowerCase()==='ok';
    if(!proxyConnected) throw new Error('Proxy not healthy');
    if(st){st.textContent='connected'; st.className='proxy-status ok';}
    await refreshLiveData(true);
  }catch(e){
    proxyConnected=false;
    if(st){st.textContent='error'; st.className='proxy-status err';}
    console.warn('Proxy connect failed', e);
  }
}


        function withHistoryFilter(sql){
            // Adds a time filter using AnyLog SQL syntax: timestamp >= NOW() - <N> minutes
            const mins = Math.max(1, parseInt(historyMinutes || 60, 10));
            const col = (timeColumn || 'timestamp').trim();
            // If the SQL already has a WHERE, append with AND; otherwise add WHERE
            if (/where/i.test(sql)) return `${sql} AND ${col} >= NOW() - ${mins} minutes`;
            return `${sql} WHERE ${col} >= NOW() - ${mins} minutes`;
        }
        
        async function refreshLiveData(renderNow=false){
  if(!dbms()) { console.warn('DBMS not set'); if(renderNow) renderAll(); return; }
  try{
    const [dockerRes, nicRes, swRes, nodeRes] = await Promise.allSettled([
      POST('/api/query', {dbms: dbms(), sql: withHistoryFilter('SELECT * FROM docker_insight LIMIT 500')}),
      POST('/api/query', {dbms: dbms(), sql: withHistoryFilter('SELECT * FROM nic_info LIMIT 500')}),
      POST('/api/query', {dbms: dbms(), sql: withHistoryFilter('SELECT * FROM switch LIMIT 200')}),
      POST('/api/query', {dbms: dbms(), sql: withHistoryFilter('SELECT * FROM node_insight LIMIT 500')}),
    ]);
    const docker = dockerRes.status==='fulfilled' ? rows(dockerRes.value) : [];
    const nics   = nicRes.status==='fulfilled'    ? rows(nicRes.value)    : [];
    const sws    = swRes.status==='fulfilled'     ? rows(swRes.value)     : [];
    const nodes  = nodeRes.status==='fulfilled'   ? rows(nodeRes.value)   : [];

    if(!docker.length && !nics.length && !sws.length && !nodes.length) {
      // keep mock
      window.__liveTopologyData = null;
    } else {
      window.__liveTopologyData = normalizeTopologyData(docker, nics, sws, nodes);
    }
  } catch(e){
    console.warn('Live refresh failed; keeping existing data', e);
  } finally {
    if(renderNow) renderAll();
  }
}

function num(v){ const n = Number(v); return Number.isFinite(n)?n:0; }
function normalizeTopologyData(dockerRows, nicRows, switchRows, nodeRows){
  // Build containers with tolerant field matching
  const containers = dockerRows.map(r=>({
    container_id: r.container_id||r.id||r.container||'',
    container_name: r.container_name||r.name||r.container_name_||r.container||'',
    host_name: r.host_name||r.host||r.node||r.hostname||'',
    host_ip: r.host_ip||r.ip||r.hostip||'',
    status: r.status||r.state||'',
    image: r.image||'',
    created: r.created||r.created_at||'',
    started: r.started||r.started_at||'',
    ports: r.ports||r.port||'',
    network_mode: r.network_mode||r.net_mode||r.network||'',
    cpu_percent: num(r.cpu_percent||r.cpu||r.cpu_pct),
    memory_usage: r.memory_usage||r.mem_usage||r.mem||'',
    memory_limit: r.memory_limit||r.mem_limit||'',
    memory_percent: num(r.memory_percent||r.mem_percent||r.mem_pct),
    block_read: r.block_read||'',
    block_write: r.block_write||'',
    network_rx: r.network_rx||r.net_rx||'',
    network_tx: r.network_tx||r.net_tx||'',
    pids: num(r.pids||r.pid_count),
    uptime: r.uptime||'',
    restart_count: num(r.restart_count||r.restarts),
    health_status: r.health_status||r.health||''
  })).filter(c=>c.host_name);

  const hosts = {};
  for(const c of containers){
    if(!hosts[c.host_name]) hosts[c.host_name]={
      id:c.host_name.toLowerCase().replace(/[^a-z0-9]/g,''),
      name:c.host_name, ip:c.host_ip, nics:[], containers:[], cpu:0, memory:'', total_containers:0, running_containers:0
    };
    hosts[c.host_name].containers.push(c.container_name);
    hosts[c.host_name].total_containers++;
    if((c.status||'').toLowerCase()==='running') hosts[c.host_name].running_containers++;
  }

  const nics = nicRows.map(r=>({
    name: r.name||r.nic||r.interface||'',
    host: r.host||r.host_name||r.node||r.hostname||'',
    ip: r.ip||r.host_ip||r.address||null,
    mac: r.mac||r.mac_address||'',
    status: (r.status||r.state||'').toLowerCase()||'',
    speed: r.speed||r.link_speed||null,
    switch: r.switch||r.switch_name||r.connected_switch||null,
    port: r.port||r.switch_port||null
  })).filter(n=>n.host && n.name);

  for(const nic of nics){
    const containersOnNic = containers.filter(c=>c.host_name===nic.host && (c.network_mode||'').toLowerCase()==='bridge').map(c=>c.container_name);
    nic.containers = containersOnNic;
    if(hosts[nic.host]) hosts[nic.host].nics.push(nic.name);
  }

  // node_insight metrics
  for(const r of nodeRows){
    const hn = r.host_name||r.host||r.node||r.hostname;
    if(!hn || !hosts[hn]) continue;
    const cpu = num(r.cpu_percent||r.cpu||r.cpu_pct);
    const memUsed = r.memory_used||r.mem_used||r.used_memory||r.mem_usage;
    const memTot  = r.memory_total||r.mem_total||r.total_memory||r.mem_limit;
    if(cpu) hosts[hn].cpu = cpu;
    if(memUsed || memTot) hosts[hn].memory = `${memUsed||'‚Äî'} / ${memTot||'‚Äî'}`;
  }

  const switches = switchRows.map(r=>({
    name: r.name||r.switch||r.switch_name||'',
    ip: r.ip||r.switch_ip||'',
    model: r.model||r.hw_model||'',
    ports: num(r.ports||r.total_ports||r.port_count||0),
    connected: (String(r.connected||r.online||r.status||'').toLowerCase()==='true') || (String(r.status||'').toLowerCase()==='connected'),
    activeports: num(r.activeports||r.active_ports||r.active||0)
  })).filter(s=>s.name);

  return { hosts:Object.values(hosts), nics, switches, containers };
}

function renderAll(){
  const data = generateMockData();
  drawTopology(data);
  renderStatistics(data);
  renderHostTable(data);
  renderNICMapping(data);
  renderContainerTable(data);
}


        // Canvas setup
        const canvas = document.getElementById('topology-canvas');
        const ctx = canvas.getContext('2d');
        let currentView = 'topology';
        let showLabels = true;
        let showConnectionLabels = false;
        let selectedNode = null;
        let zoomLevel = 1.0;
        let panX = 0;
        let panY = 0;
        let isPaused = false;
        let autoRefreshInterval = null;
        let refreshSeconds = 30;
        let historyMinutes = 60;
        let timeColumn = "timestamp";
        
        // Mock data - replace with real queries from docker_insight, node_insight, nic_info, switch tables
        function generateMockData() {
            if (window.__liveTopologyData) return window.__liveTopologyData;

            // This simulates data from docker_insight table
            const dockerInsightData = [
                {
                    container_id: '1a2b3c4d',
                    container_name: 'anylog-operator',
                    host_name: 'AnyLog-Node-253',
                    host_ip: '172.79.89.2',
                    status: 'running',
                    image: 'anylogco/anylog-network:latest',
                    created: '2026-01-15T08:30:00Z',
                    started: '2026-01-15T08:30:15Z',
                    ports: '32148:32148/tcp, 32149:32149/tcp, 32348:32348/tcp',
                    network_mode: 'bridge',
                    cpu_percent: 8.2,
                    memory_usage: '1.2GB',
                    memory_limit: '4GB',
                    memory_percent: 30,
                    block_read: '125MB',
                    block_write: '89MB',
                    network_rx: '1.2GB',
                    network_tx: '890MB',
                    pids: 45,
                    uptime: '25 days',
                    restart_count: 0,
                    health_status: 'healthy'
                },
                {
                    container_id: '2b3c4d5e',
                    container_name: 'anylog-query',
                    host_name: 'AnyLog-Node-253',
                    host_ip: '172.79.89.2',
                    status: 'running',
                    image: 'anylogco/anylog-network:latest',
                    created: '2026-01-15T08:31:00Z',
                    started: '2026-01-15T08:31:10Z',
                    ports: '32248:32248/tcp, 32249:32249/tcp',
                    network_mode: 'bridge',
                    cpu_percent: 3.5,
                    memory_usage: '800MB',
                    memory_limit: '2GB',
                    memory_percent: 40,
                    block_read: '45MB',
                    block_write: '28MB',
                    network_rx: '450MB',
                    network_tx: '320MB',
                    pids: 32,
                    uptime: '25 days',
                    restart_count: 0,
                    health_status: 'healthy'
                },
                {
                    container_id: '3c4d5e6f',
                    container_name: 'nginx-proxy',
                    host_name: 'AnyLog-Node-253',
                    host_ip: '172.79.89.2',
                    status: 'running',
                    image: 'nginx:1.25-alpine',
                    created: '2026-01-15T08:29:00Z',
                    started: '2026-01-15T08:29:05Z',
                    ports: '80:80/tcp, 443:443/tcp',
                    network_mode: 'host',
                    cpu_percent: 1.2,
                    memory_usage: '45MB',
                    memory_limit: '512MB',
                    memory_percent: 8.8,
                    block_read: '12MB',
                    block_write: '8MB',
                    network_rx: '2.1GB',
                    network_tx: '5.6GB',
                    pids: 5,
                    uptime: '25 days',
                    restart_count: 0,
                    health_status: 'healthy'
                },
                {
                    container_id: '4d5e6f7g',
                    container_name: 'anylog-operator',
                    host_name: 'AnyLog-Node-201',
                    host_ip: '172.79.89.201',
                    status: 'running',
                    image: 'anylogco/anylog-network:latest',
                    created: '2026-01-15T08:30:00Z',
                    started: '2026-01-15T08:30:20Z',
                    ports: '32148:32148/tcp, 32149:32149/tcp',
                    network_mode: 'bridge',
                    cpu_percent: 15.8,
                    memory_usage: '2.1GB',
                    memory_limit: '8GB',
                    memory_percent: 26.3,
                    block_read: '2.4GB',
                    block_write: '1.8GB',
                    network_rx: '12GB',
                    network_tx: '8.5GB',
                    pids: 67,
                    uptime: '25 days',
                    restart_count: 1,
                    health_status: 'healthy'
                },
                {
                    container_id: '5e6f7g8h',
                    container_name: 'postgres-db',
                    host_name: 'AnyLog-Node-201',
                    host_ip: '172.79.89.201',
                    status: 'running',
                    image: 'postgres:14.10-alpine',
                    created: '2026-01-15T08:28:00Z',
                    started: '2026-01-15T08:28:30Z',
                    ports: '5432:5432/tcp',
                    network_mode: 'bridge',
                    cpu_percent: 22.3,
                    memory_usage: '4.5GB',
                    memory_limit: '16GB',
                    memory_percent: 28.1,
                    block_read: '45GB',
                    block_write: '38GB',
                    network_rx: '8.2GB',
                    network_tx: '12.4GB',
                    pids: 89,
                    uptime: '25 days',
                    restart_count: 0,
                    health_status: 'healthy'
                },
                {
                    container_id: '6f7g8h9i',
                    container_name: 'anylog-operator',
                    host_name: 'AnyLog-Node-202',
                    host_ip: '172.79.89.202',
                    status: 'running',
                    image: 'anylogco/anylog-network:latest',
                    created: '2026-01-15T08:30:00Z',
                    started: '2026-01-15T08:30:25Z',
                    ports: '32148:32148/tcp, 32149:32149/tcp',
                    network_mode: 'bridge',
                    cpu_percent: 45.2,
                    memory_usage: '3.8GB',
                    memory_limit: '8GB',
                    memory_percent: 47.5,
                    block_read: '5.6GB',
                    block_write: '4.2GB',
                    network_rx: '18GB',
                    network_tx: '14GB',
                    pids: 92,
                    uptime: '25 days',
                    restart_count: 2,
                    health_status: 'degraded'
                },
                {
                    container_id: '7g8h9i0j',
                    container_name: 'grafana',
                    host_name: 'AnyLog-Node-201',
                    host_ip: '172.79.89.201',
                    status: 'running',
                    image: 'grafana/grafana:latest',
                    created: '2026-01-20T10:15:00Z',
                    started: '2026-01-20T10:15:20Z',
                    ports: '3000:3000/tcp',
                    network_mode: 'bridge',
                    cpu_percent: 2.8,
                    memory_usage: '320MB',
                    memory_limit: '1GB',
                    memory_percent: 32,
                    block_read: '180MB',
                    block_write: '95MB',
                    network_rx: '1.4GB',
                    network_tx: '3.2GB',
                    pids: 28,
                    uptime: '20 days',
                    restart_count: 0,
                    health_status: 'healthy'
                }
            ];
            
            // Aggregate by host
            const hosts = {};
            dockerInsightData.forEach(container => {
                if (!hosts[container.host_name]) {
                    hosts[container.host_name] = {
                        id: container.host_name.toLowerCase().replace(/[^a-z0-9]/g, ''),
                        name: container.host_name,
                        ip: container.host_ip,
                        nics: [],
                        containers: [],
                        cpu: 0,
                        memory: '',
                        total_containers: 0,
                        running_containers: 0
                    };
                }
                hosts[container.host_name].containers.push(container.container_name);
                hosts[container.host_name].total_containers++;
                if (container.status === 'running') {
                    hosts[container.host_name].running_containers++;
                }
            });
            
            // Add NIC data (from nic_info table)
            const nicData = [
                { name: 'eno1', host: 'AnyLog-Node-253', ip: '172.79.89.2', mac: '00:1a:2b:3c:4d:5e', status: 'up', speed: '1000Mbps', switch: 'Switch 2', port: 1 },
                { name: 'enp2s0', host: 'AnyLog-Node-253', ip: '192.168.200.2', mac: '00:1a:2b:3c:4d:5f', status: 'up', speed: '1000Mbps', switch: 'Switch 3', port: 3 },
                { name: 'enp5s0', host: 'AnyLog-Node-253', ip: null, mac: '00:1a:2b:3c:4d:60', status: 'down', speed: null, switch: null, port: null },
                { name: 'eno1', host: 'AnyLog-Node-201', ip: '172.79.89.201', mac: '00:1a:2b:3c:4d:61', status: 'up', speed: '1000Mbps', switch: 'Switch 2', port: 2 },
                { name: 'enp1s0', host: 'AnyLog-Node-201', ip: '10.0.1.201', mac: '00:1a:2b:3c:4d:62', status: 'up', speed: '1000Mbps', switch: 'Switch 4', port: 5 },
                { name: 'eno1', host: 'AnyLog-Node-202', ip: '172.79.89.202', mac: '00:1a:2b:3c:4d:63', status: 'up', speed: '1000Mbps', switch: 'Switch 2', port: 4 }
            ];
            
            // Map NICs to containers
            nicData.forEach(nic => {
                const containersOnNic = dockerInsightData
                    .filter(c => c.host_name === nic.host && c.network_mode === 'bridge')
                    .map(c => c.container_name);
                nic.containers = containersOnNic;
                
                if (hosts[nic.host]) {
                    hosts[nic.host].nics.push(nic.name);
                }
            });
            
            // Add host system metrics (from node_insight)
            hosts['AnyLog-Node-253'].cpu = 15.3;
            hosts['AnyLog-Node-253'].memory = '8.5GB / 16GB';
            hosts['AnyLog-Node-201'].cpu = 42.1;
            hosts['AnyLog-Node-201'].memory = '12.2GB / 32GB';
            hosts['AnyLog-Node-202'].cpu = 87.3;
            hosts['AnyLog-Node-202'].memory = '28.4GB / 32GB';
            
            // Switch data (from switch table)
            const switches = [
                { name: 'Switch 2', ip: '172.79.89.10', model: 'ETH2-DN0802XXD1-01G', ports: 8, connected: true, activeports: 3 },
                { name: 'Switch 3', ip: '172.79.89.20', model: 'ETH2-DN0802XXD1-01G', ports: 8, connected: true, activeports: 1 },
                { name: 'Switch 4', ip: '172.79.89.30', model: 'ETH2-DN1604XXD1-01G', ports: 16, connected: false, activeports: 0 },
                { name: 'Switch 5', ip: '172.79.89.40', model: 'ETH2-1U082404D1-10G', ports: 24, connected: true, activeports: 0 }
            ];
            
            return {
                hosts: Object.values(hosts),
                nics: nicData,
                switches: switches,
                containers: dockerInsightData
            };
        }
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = 900;
        }
        
        function drawTopology(data) {
            resizeCanvas();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Apply zoom and pan transformations
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.scale(zoomLevel, zoomLevel);
            ctx.translate(-canvas.width / 2 + panX, -canvas.height / 2 + panY);
            
            if (currentView === 'topology') {
                drawTopologyView(data);
            } else {
                drawHierarchyView(data);
            }
            
            ctx.restore();
        }
        
        function drawTopologyView(data) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Draw gateway/router at center
            drawNode(centerX, centerY, 40, 'üåê', 'Gateway\n172.79.89.1', '#667eea');
            
            // Draw switches in a circle around gateway with increased radius
            const switchRadius = 180;
            const switchAngleStep = (2 * Math.PI) / data.switches.length;
            
            data.switches.forEach((sw, i) => {
                const angle = i * switchAngleStep - Math.PI / 2; // Start from top
                const x = centerX + switchRadius * Math.cos(angle);
                const y = centerY + switchRadius * Math.sin(angle);
                
                const color = sw.connected ? '#ff9800' : '#f44336';
                drawNode(x, y, 35, 'üîÄ', sw.name, color);
                
                // Draw line to gateway
                drawConnection(centerX, centerY, x, y, sw.connected ? '#4CAF50' : '#f44336', 0.3);
                
                // Store position for host connections
                sw.x = x;
                sw.y = y;
            });
            
            // Calculate host positions in outer ring with more spacing
            const hostRadius = 380;
            const hostAngleStep = (2 * Math.PI) / data.hosts.length;
            
            data.hosts.forEach((host, hostIdx) => {
                const angle = hostIdx * hostAngleStep - Math.PI / 2;
                const x = centerX + hostRadius * Math.cos(angle);
                const y = centerY + hostRadius * Math.sin(angle);
                
                // Draw host
                drawNode(x, y, 45, 'üñ•Ô∏è', host.name, '#2196F3');
                host.x = x;
                host.y = y;
                
                // Calculate NIC positions around host in a semi-circle facing outward
                const nicCount = host.nics.length;
                const nicDistance = 90;
                
                host.nics.forEach((nicName, nicIdx) => {
                    const nic = data.nics.find(n => n.name === nicName && n.host === host.name);
                    if (nic) {
                        // Spread NICs in an arc facing away from center
                        const nicAngleOffset = ((nicIdx - (nicCount - 1) / 2) * 0.5);
                        const nicAngle = angle + nicAngleOffset;
                        const nicX = x + nicDistance * Math.cos(nicAngle);
                        const nicY = y + nicDistance * Math.sin(nicAngle);
                        
                        const nicColor = nic.status === 'up' ? '#4CAF50' : '#f44336';
                        drawNode(nicX, nicY, 22, 'üîå', '', nicColor, 1.0);
                        
                        // Draw label below NIC (not overlapping)
                        if (showLabels) {
                            ctx.font = '11px Arial';
                            ctx.fillStyle = '#333';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'top';
                            ctx.fillText(nic.name, nicX, nicY + 28);
                        }
                        
                        // Connect NIC to host with thin line
                        drawConnection(x, y, nicX, nicY, nicColor, 0.4, 1);
                        
                        // Connect NIC to switch with curved line if connected
                        if (nic.switch) {
                            const sw = data.switches.find(s => s.name === nic.switch);
                            if (sw && sw.x && sw.y) {
                                const portLabel = `Port ${nic.port}`;
                                drawCurvedConnection(nicX, nicY, sw.x, sw.y, nicColor, 0.5, 1.5, portLabel);
                            }
                        }
                        
                        nic.x = nicX;
                        nic.y = nicY;
                    }
                });
                
                // Draw containers on the opposite side (facing inward)
                const hostContainers = data.containers.filter(c => c.host_name === host.name);
                const containerDistance = 95;
                const containerCount = hostContainers.length;
                
                hostContainers.forEach((container, cIdx) => {
                    // Position containers on inner side of host (toward center)
                    const cAngleOffset = ((cIdx - (containerCount - 1) / 2) * 0.4);
                    const cAngle = angle + Math.PI + cAngleOffset; // Opposite side
                    const cX = x + containerDistance * Math.cos(cAngle);
                    const cY = y + containerDistance * Math.sin(cAngle);
                    
                    const cColor = container.status === 'running' ? '#00bcd4' : '#9e9e9e';
                    const healthColor = container.health_status === 'healthy' ? '#4CAF50' : '#ff9800';
                    
                    // Draw health ring
                    ctx.strokeStyle = healthColor;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(cX, cY, 21, 0, 2 * Math.PI);
                    ctx.stroke();
                    
                    drawNode(cX, cY, 18, 'üê≥', '', cColor, 1.0);
                    
                    // Draw label below container (not overlapping)
                    if (showLabels) {
                        ctx.font = '10px Arial';
                        ctx.fillStyle = '#333';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'top';
                        const shortName = container.container_name.length > 12 ? 
                            container.container_name.substring(0, 10) + '..' : 
                            container.container_name;
                        ctx.fillText(shortName, cX, cY + 26);
                    }
                    
                    // Connect container to host with thin line
                    drawConnection(x, y, cX, cY, cColor, 0.3, 1);
                    
                    // Store position for click detection
                    container.x = cX;
                    container.y = cY;
                });
            });
        }
        
        function drawHierarchyView(data) {
            const startY = 50;
            const levelHeight = 150;
            
            // Level 1: Gateway
            const centerX = canvas.width / 2;
            drawNode(centerX, startY, 40, 'üåê', 'Gateway', '#667eea');
            
            // Level 2: Switches
            const switchSpacing = canvas.width / (data.switches.length + 1);
            data.switches.forEach((sw, i) => {
                const x = switchSpacing * (i + 1);
                const y = startY + levelHeight;
                const color = sw.connected ? '#ff9800' : '#f44336';
                drawNode(x, y, 35, 'üîÄ', sw.name, color);
                drawConnection(centerX, startY, x, y, sw.connected ? '#4CAF50' : '#f44336');
                sw.x = x;
                sw.y = y;
            });
            
            // Level 3: Hosts and NICs
            let xOffset = 100;
            data.hosts.forEach(host => {
                const y = startY + levelHeight * 2;
                drawNode(xOffset, y, 40, 'üñ•Ô∏è', host.name, '#2196F3');
                host.x = xOffset;
                host.y = y;
                
                // NICs below host
                host.nics.forEach((nicName, idx) => {
                    const nic = data.nics.find(n => n.name === nicName && n.host === host.name);
                    if (nic) {
                        const nicX = xOffset + (idx - host.nics.length / 2) * 60;
                        const nicY = y + 80;
                        const nicColor = nic.status === 'up' ? '#4CAF50' : '#f44336';
                        drawNode(nicX, nicY, 20, 'üîå', nic.name, nicColor, 0.9);
                        drawConnection(xOffset, y, nicX, nicY, nicColor, 1);
                        
                        // Connect to switch
                        if (nic.switch) {
                            const sw = data.switches.find(s => s.name === nic.switch);
                            if (sw) {
                                drawConnection(nicX, nicY, sw.x, sw.y, nicColor, 1);
                            }
                        }
                    }
                });
                
                xOffset += 250;
            });
        }
        
        function drawNode(x, y, radius, icon, label, color, opacity = 1) {
            // Shadow
            ctx.shadowColor = 'rgba(0,0,0,0.2)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            // Circle
            ctx.globalAlpha = opacity;
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, 2 * Math.PI);
            ctx.fill();
            
            // Border
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.shadowColor = 'transparent';
            
            // Icon
            ctx.font = `${radius * 0.8}px Arial`;
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(icon, x, y);
            
            // Label - only for gateway and switches (not NICs/containers)
            if (showLabels && label) {
                ctx.font = '12px Arial';
                ctx.fillStyle = '#333';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                const lines = label.split('\n');
                lines.forEach((line, i) => {
                    ctx.fillText(line, x, y + radius + 8 + i * 14);
                });
            }
            
            ctx.globalAlpha = 1;
        }
        
        function drawConnection(x1, y1, x2, y2, color, opacity = 1, lineWidth = 2) {
            ctx.globalAlpha = opacity;
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            ctx.globalAlpha = 1;
        }
        
        function drawCurvedConnection(x1, y1, x2, y2, color, opacity = 1, lineWidth = 2, label = '') {
            ctx.globalAlpha = opacity;
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            
            // Calculate control point for quadratic curve
            const midX = (x1 + x2) / 2;
            const midY = (y1 + y2) / 2;
            
            // Offset control point perpendicular to the line
            const dx = x2 - x1;
            const dy = y2 - y1;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const curvature = dist * 0.15; // Curve intensity
            
            const controlX = midX - (dy / dist) * curvature;
            const controlY = midY + (dx / dist) * curvature;
            
            ctx.quadraticCurveTo(controlX, controlY, x2, y2);
            ctx.stroke();
            
            // Draw label at midpoint if enabled
            if (showConnectionLabels && label) {
                ctx.globalAlpha = 1;
                ctx.font = '10px Arial';
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(label, controlX, controlY);
                ctx.fillText(label, controlX, controlY);
            }
            
            ctx.globalAlpha = 1;
        }
        
        function togglePause() {
            isPaused = !isPaused;
            
            const pauseButton = document.getElementById('pauseButton');
            const pausedIndicator = document.getElementById('pausedIndicator');
            
            if (isPaused) {
                // Pause state
                pauseButton.textContent = '‚ñ∂ Resume Auto-Refresh';
                pauseButton.classList.add('paused');
                pausedIndicator.style.display = 'inline';
                
                // Clear the interval
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            } else {
                // Resume state
                pauseButton.textContent = '‚è∏ Pause Auto-Refresh';
                pauseButton.classList.remove('paused');
                pausedIndicator.style.display = 'none';
                
                // Refresh immediately
                const data = generateMockData();
                drawTopology(data);
                renderStatistics(data);
                renderHostTable(data);
                renderNICMapping(data);
                renderContainerTable(data);
                
                // Restart the interval
                autoRefreshInterval = setInterval(() => {
                    if (!isPaused) {
                        const data = generateMockData();
                        drawTopology(data);
                        renderStatistics(data);
                        renderHostTable(data);
                        renderNICMapping(data);
                        renderContainerTable(data);
                    }
                }, 30000);
            }
        }



        function applyRefreshSettings(){
            const r = document.getElementById('refreshSecondsInput');
            const h = document.getElementById('historyMinutesInput');
            const rs = Math.max(2, parseInt(r?.value || refreshSeconds, 10));
            const hm = Math.max(1, parseInt(h?.value || historyMinutes, 10));
            refreshSeconds = rs;
            historyMinutes = hm;

            // restart interval if not paused
            if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; }
            autoRefreshInterval = setInterval(() => {
                if (!isPaused) {
                    refreshLiveData(true).catch(()=>{});
                }
            }, refreshSeconds * 1000);

            // refresh immediately
            refreshLiveData(true).catch(()=>{});
        }
                
        function toggleConnectionLabels() {
            showConnectionLabels = !showConnectionLabels;
            const data = generateMockData();
            drawTopology(data);
        }
        
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 3.0);
            const data = generateMockData();
            drawTopology(data);
        }
        
        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.5);
            const data = generateMockData();
            drawTopology(data);
        }
        
        function setView(view) {
            currentView = view;
            document.getElementById('view-topology').classList.toggle('active', view === 'topology');
            document.getElementById('view-hierarchy').classList.toggle('active', view === 'hierarchy');
            
            const data = generateMockData();
            drawTopology(data);
        }
        
        function toggleLabels() {
            showLabels = !showLabels;
            const data = generateMockData();
            drawTopology(data);
        }
        
        function resetZoom() {
            zoomLevel = 1.0;
            panX = 0;
            panY = 0;
            const data = generateMockData();
            drawTopology(data);
        }
        
        function exportTopology() {
            const link = document.createElement('a');
            link.download = 'network-topology.png';
            link.href = canvas.toDataURL();
            link.click();
        }
        
        function showDetail(type, item, data) {
            const panel = document.getElementById('detailPanel');
            const title = document.getElementById('detailTitle');
            const content = document.getElementById('detailContent');
            
            let html = '';
            
            if (type === 'Host') {
                title.textContent = `üñ•Ô∏è Host: ${item.name}`;
                const hostContainers = data.containers.filter(c => c.host_name === item.name);
                
                html = `
                    <div class="detail-section">
                        <div class="detail-section-title">System Information</div>
                        <div class="detail-row">
                            <span class="detail-label">IP Address:</span>
                            <span class="detail-value">${item.ip}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">CPU Usage:</span>
                            <span class="detail-value" style="color: ${item.cpu > 80 ? '#f44336' : '#4CAF50'};">${item.cpu}%</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Memory:</span>
                            <span class="detail-value">${item.memory}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Containers:</span>
                            <span class="detail-value">${item.running_containers} / ${item.total_containers} Running</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Network Interfaces (${item.nics.length})</div>
                        ${data.nics.filter(n => n.host === item.name).map(n => `
                            <div class="detail-row">
                                <span class="detail-label">${n.name}:</span>
                                <span class="detail-value">
                                    ${n.ip || 'No IP'} 
                                    <span class="status-badge ${n.status}">${n.status}</span>
                                </span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Docker Containers (${hostContainers.length})</div>
                        ${hostContainers.map(c => `
                            <div style="background: #f8f9fa; padding: 10px; margin: 8px 0; border-radius: 4px;">
                                <div style="font-weight: bold; margin-bottom: 5px;">
                                    ${c.container_name}
                                    <span class="status-badge ${c.status}">${c.status}</span>
                                </div>
                                <div style="font-size: 0.85em; color: #666;">
                                    CPU: ${c.cpu_percent}% | Mem: ${c.memory_usage} (${c.memory_percent}%)<br>
                                    Uptime: ${c.uptime} | PIDs: ${c.pids}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (type === 'NIC') {
                title.textContent = `üîå NIC: ${item.name} (${item.host})`;
                
                html = `
                    <div class="detail-section">
                        <div class="detail-section-title">Interface Information</div>
                        <div class="detail-row">
                            <span class="detail-label">Host:</span>
                            <span class="detail-value">${item.host}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">IP Address:</span>
                            <span class="detail-value">${item.ip || 'Not Assigned'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">MAC Address:</span>
                            <span class="detail-value">${item.mac}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value">
                                <span class="status-badge ${item.status}">${item.status.toUpperCase()}</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Speed:</span>
                            <span class="detail-value">${item.speed || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Switch Connection</div>
                        <div class="detail-row">
                            <span class="detail-label">Switch:</span>
                            <span class="detail-value">${item.switch || 'Not Connected'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Port:</span>
                            <span class="detail-value">${item.port || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Containers Using This NIC (${item.containers.length})</div>
                        ${item.containers.length > 0 ? 
                            item.containers.map(c => `<div class="detail-row"><span>${c}</span></div>`).join('') :
                            '<div style="text-align: center; color: #999; padding: 10px;">No containers using this interface</div>'
                        }
                    </div>
                `;
            } else if (type === 'Switch') {
                title.textContent = `üîÄ Switch: ${item.name}`;
                const connectedNICs = data.nics.filter(n => n.switch === item.name);
                
                html = `
                    <div class="detail-section">
                        <div class="detail-section-title">Switch Information</div>
                        <div class="detail-row">
                            <span class="detail-label">IP Address:</span>
                            <span class="detail-value">${item.ip}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Model:</span>
                            <span class="detail-value">${item.model}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Total Ports:</span>
                            <span class="detail-value">${item.ports}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Active Ports:</span>
                            <span class="detail-value">${item.activeports}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value">
                                <span class="status-badge ${item.connected ? 'up' : 'down'}">
                                    ${item.connected ? 'CONNECTED' : 'DISCONNECTED'}
                                </span>
                            </span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Connected NICs (${connectedNICs.length})</div>
                        ${connectedNICs.map(n => `
                            <div class="detail-row">
                                <span class="detail-label">Port ${n.port}:</span>
                                <span class="detail-value">${n.host} - ${n.name} (${n.ip})</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (type === 'Container') {
                title.textContent = `üê≥ Container: ${item.container_name}`;
                
                html = `
                    <div class="detail-section">
                        <div class="detail-section-title">Container Information</div>
                        <div class="detail-row">
                            <span class="detail-label">Container ID:</span>
                            <span class="detail-value" style="font-family: monospace; font-size: 0.85em;">${item.container_id}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Host:</span>
                            <span class="detail-value">${item.host_name}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value">
                                <span class="status-badge ${item.status}">${item.status.toUpperCase()}</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Health:</span>
                            <span class="detail-value">
                                <span class="status-badge ${item.health_status === 'healthy' ? 'up' : 'down'}">
                                    ${item.health_status.toUpperCase()}
                                </span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Image:</span>
                            <span class="detail-value" style="font-size: 0.85em;">${item.image}</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Resource Usage</div>
                        <div class="detail-row">
                            <span class="detail-label">CPU:</span>
                            <span class="detail-value" style="color: ${item.cpu_percent > 50 ? '#f44336' : '#4CAF50'};">${item.cpu_percent}%</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Memory:</span>
                            <span class="detail-value">${item.memory_usage} / ${item.memory_limit} (${item.memory_percent}%)</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">PIDs:</span>
                            <span class="detail-value">${item.pids}</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Network</div>
                        <div class="detail-row">
                            <span class="detail-label">Network Mode:</span>
                            <span class="detail-value">${item.network_mode}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Ports:</span>
                            <span class="detail-value" style="font-size: 0.85em;">${item.ports}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">RX:</span>
                            <span class="detail-value">${item.network_rx}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">TX:</span>
                            <span class="detail-value">${item.network_tx}</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Disk I/O</div>
                        <div class="detail-row">
                            <span class="detail-label">Block Read:</span>
                            <span class="detail-value">${item.block_read}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Block Write:</span>
                            <span class="detail-value">${item.block_write}</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="detail-section-title">Runtime</div>
                        <div class="detail-row">
                            <span class="detail-label">Created:</span>
                            <span class="detail-value">${new Date(item.created).toLocaleString()}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Started:</span>
                            <span class="detail-value">${new Date(item.started).toLocaleString()}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Uptime:</span>
                            <span class="detail-value">${item.uptime}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Restart Count:</span>
                            <span class="detail-value">${item.restart_count}</span>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            panel.classList.add('visible');
        }
        
        function closeDetailPanel() {
            document.getElementById('detailPanel').classList.remove('visible');
        }
        
        function renderStatistics(data) {
            document.getElementById('hostCount').textContent = data.hosts.length;
            document.getElementById('nicCount').textContent = data.nics.length;
            document.getElementById('switchCount').textContent = data.switches.length;
            document.getElementById('containerCount').textContent = data.containers.length;
        }
        
        function renderHostTable(data) {
            const tbody = document.getElementById('hostTable');
            
            tbody.innerHTML = data.hosts.map(host => {
                const containers = data.containers.filter(c => c.host_name === host.name);
                const runningCount = containers.filter(c => c.status === 'running').length;
                const healthyCount = containers.filter(c => c.health_status === 'healthy').length;
                
                return `
                    <tr style="cursor: pointer;" onclick='showDetail("Host", ${JSON.stringify(host).replace(/'/g, "&apos;")}, ${JSON.stringify(data).replace(/'/g, "&apos;")})'>
                        <td><strong>${host.name}</strong></td>
                        <td>${host.ip}</td>
                        <td>${host.nics.join(', ')}</td>
                        <td>${containers.length}</td>
                        <td>
                            <span class="status-badge running">${runningCount} Running</span>
                            ${containers.length - runningCount > 0 ? `<span class="status-badge stopped">${containers.length - runningCount} Stopped</span>` : ''}
                            ${healthyCount < containers.length ? `<br><small style="color: #ff9800;">${containers.length - healthyCount} degraded</small>` : ''}
                        </td>
                        <td style="color: ${parseFloat(host.cpu) > 80 ? '#f44336' : '#4CAF50'};">${host.cpu}%</td>
                        <td>${host.memory}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderNICMapping(data) {
            const tbody = document.getElementById('nicMappingTable');
            
            tbody.innerHTML = data.nics.map(nic => `
                <tr style="cursor: pointer;" onclick='showDetail("NIC", ${JSON.stringify(nic).replace(/'/g, "&apos;")}, ${JSON.stringify(data).replace(/'/g, "&apos;")})'>
                    <td><strong>${nic.name}</strong><br><small style="color: #999;">${nic.mac}</small></td>
                    <td>${nic.host}</td>
                    <td>${nic.ip || '<span style="color: #999;">Not Assigned</span>'}</td>
                    <td><span class="status-badge ${nic.status}">${nic.status.toUpperCase()}</span></td>
                    <td>${nic.switch || '<span style="color: #999;">Not Connected</span>'}</td>
                    <td>${nic.port || 'N/A'}</td>
                    <td>${nic.containers.length > 0 ? nic.containers.join(', ') : '<span style="color: #999;">None</span>'}</td>
                </tr>
            `).join('');
        }
        
        function renderContainerTable(data) {
            const tbody = document.getElementById('containerTable');
            
            tbody.innerHTML = data.containers.map(container => `
                <tr style="cursor: pointer;" onclick='showDetail("Container", ${JSON.stringify(container).replace(/'/g, "&apos;")}, ${JSON.stringify(data).replace(/'/g, "&apos;")})'>
                    <td><strong>${container.container_name}</strong></td>
                    <td>${container.host_name}</td>
                    <td>
                        <span class="status-badge ${container.status}">${container.status.toUpperCase()}</span>
                        <span class="status-badge ${container.health_status === 'healthy' ? 'up' : 'down'}" style="font-size: 0.75em;">${container.health_status}</span>
                    </td>
                    <td style="font-size: 0.85em;">${container.image}</td>
                    <td style="font-size: 0.8em;">${container.ports}</td>
                    <td>${container.network_mode}</td>
                    <td style="color: ${parseFloat(container.cpu_percent) > 50 ? '#f44336' : '#4CAF50'};">${container.cpu_percent}%</td>
                    <td>${container.memory_usage} (${container.memory_percent}%)</td>
                </tr>
            `).join('');
        }
        
        function initialize() {
            // Load saved proxy settings
            const h=localStorage.getItem('anylog_proxy_host')||'localhost';
            const p=localStorage.getItem('anylog_proxy_port')||'8080';
            const d=localStorage.getItem('anylog_proxy_dbms')||'';
            if(document.getElementById('cfgHost')) document.getElementById('cfgHost').value=h;
            if(document.getElementById('cfgPort')) document.getElementById('cfgPort').value=p;
            if(document.getElementById('cfgDbms')) document.getElementById('cfgDbms').value=d;

            renderAll();
            // Kick off live refresh (non-blocking)
            refreshLiveData(false).then(()=>renderAll());
            // Periodic live refresh
            setInterval(()=>{ if(!isPaused) refreshLiveData(true); }, 30000);

            
            drawTopology(data);
            renderStatistics(data);
            renderHostTable(data);
            renderNICMapping(data);
            renderContainerTable(data);
            
            // Canvas click handler
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if click is on a host node
                data.hosts.forEach(host => {
                    if (host.x && host.y) {
                        const dist = Math.sqrt((x - host.x) ** 2 + (y - host.y) ** 2);
                        if (dist < 40) {
                            showDetail('Host', host, data);
                        
            // start configurable auto-refresh
            applyRefreshSettings();
        }
                    }
                });
                
                // Check if click is on a NIC node
                data.nics.forEach(nic => {
                    if (nic.x && nic.y) {
                        const dist = Math.sqrt((x - nic.x) ** 2 + (y - nic.y) ** 2);
                        if (dist < 20) {
                            showDetail('NIC', nic, data);
                        }
                    }
                });
                
                // Check if click is on a switch node
                data.switches.forEach(sw => {
                    if (sw.x && sw.y) {
                        const dist = Math.sqrt((x - sw.x) ** 2 + (y - sw.y) ** 2);
                        if (dist < 35) {
                            showDetail('Switch', sw, data);
                        }
                    }
                });
                
                // Check if click is on a container node
                data.containers.forEach(container => {
                    if (container.x && container.y) {
                        const dist = Math.sqrt((x - container.x) ** 2 + (y - container.y) ** 2);
                        if (dist < 18) {
                            showDetail('Container', container, data);
                        }
                    }
                });
            });
        }
        
        // Initialize on load
        window.addEventListener('load', initialize);
        window.addEventListener('resize', () => {
            const data = generateMockData();
            drawTopology(data);
        });
        
        // Auto-refresh (configurable)
        // NOTE: interval is (re)started by applyRefreshSettings()
                drawTopology(data);
                renderStatistics(data);
                renderHostTable(data);
                renderNICMapping(data);
                renderContainerTable(data);
            }
        }, 30000);
    </script>

<!-- API CALL LOG (shared with enterprise_c_dashboard) -->
<div class="log-panel" id="logPanel">
  <div class="log-header" onclick="toggleLog()">
    <span style="font-size:14px;">üñ•Ô∏è</span>
    <span class="log-title">API Call Log</span>
    <div class="log-stats">
      <span class="log-stat" id="log-total">0 calls</span>
      <span class="log-stat ok" id="log-ok">0 ok</span>
      <span class="log-stat err" id="log-err">0 err</span>
      <span class="log-stat" id="log-rows">0 rows</span>
    </div>
    <span class="log-caret" id="logCaret">‚ñæ</span>
  </div>
  <div class="log-content" id="logContent" style="display:none;">
    <div class="log-tools">
      <input id="logSearch" placeholder="search‚Ä¶" oninput="filterLog()" />
      <button class="log-filter-btn active" onclick="setLogFilter('all', this)">All</button>
      <button class="log-filter-btn" onclick="setLogFilter('error', this)">Errors</button>
      <button class="log-filter-btn" onclick="setLogFilter('get', this)">GET</button>
      <button class="log-filter-btn" onclick="setLogFilter('post', this)">POST</button>
      <button class="log-filter-btn" onclick="clearLog()">Clear</button>
    </div>
    <div class="log-body" id="logBody"><div class="log-placeholder">‚Äî No API calls yet. ‚Äî</div></div>
  </div>
</div>


</body>
</html>
