<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enterprise B ‚Äî OEE Live Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
    --green:#4CAF50;
    --amber:#FF9800;
    --red:#f44336;
    --muted:#bdbdbd;
}

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        /* remove scanlines from the old theme */
        body::after { display: none !important; }

        /* page width similar to Enterprise C */
        main, .stat-strip { max-width: 1900px; margin: 0 auto; }
        main { padding: 0; display: flex; flex-direction: column; gap: 12px; }

        /* ‚îÄ‚îÄ Header (Enterprise C card style) ‚îÄ‚îÄ */
        header {
            background: #fff;
            padding: 18px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.10);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: auto;
            position: static;
            border: none;
        }

        .diamond { display: none; }
        .hdr-left { gap: 0; }
        .hdr-title {
            color: #2c3e50;
            font-size: 22px;
            letter-spacing: 0;
            text-transform: none;
            font-weight: 700;
        }
        .hdr-title span { color: #3498db; }
        .hdr-sub { color: #888; font-size: 12px; letter-spacing: .03em; margin-top: 4px; font-family: inherit; }

        .status-chip {
            background: transparent;
            border: none;
            padding: 0;
            color: #666;
            font-size: 12px;
            font-family: inherit;
        }
        .dot { width: 11px; height: 11px; border-radius: 50%; background: #9e9e9e; }
        .dot.live { background: #4CAF50; box-shadow: 0 0 0 rgba(0,0,0,0); animation: pulse 2s infinite; }
        .dot.err  { background: #f44336; box-shadow: 0 0 0 rgba(0,0,0,0); animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

        #ts { color: #888; font-size: 12px; font-family: inherit; }

        /* ‚îÄ‚îÄ Control bar (Proxy config bar feel) ‚îÄ‚îÄ */
        .ctrl-bar{
            background: #1a252f;
            padding: 10px 18px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            border: none;
        }
        .cl { color: #aaa; font-size: 12px; text-transform: none; letter-spacing: 0; font-family: inherit; }
        .ci{
            padding: 5px 9px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #2c3e50;
            color: #eee;
            font-size: 12px;
            font-family: inherit;
        }
        .ci-url { width: 220px; }
        .ci-num { width: 70px; }
        .ci-sel { width: 140px; }

        .btn{
            padding: 7px 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0;
            text-transform: none;
            line-height: 1;
        }
        .btn-apply{ background: #2196F3; color: #fff; }
        .btn-apply:hover{ background:#1976D2; filter:none; box-shadow:none; }
        .btn-pause{ background:#f5f5f5; color:#2c3e50; border:1px solid #ddd; }
        .btn-pause:hover, .btn-pause.paused{ background:#e0e0e0; }
        .countdown{
            background: rgba(255,255,255,.12);
            border: 1px solid rgba(255,255,255,.18);
            color: #fff;
            border-radius: 12px;
            padding: 4px 11px;
            font-size: 11px;
            font-weight: 700;
            min-width: 88px;
            text-align: center;
        }

        /* ‚îÄ‚îÄ Section headers like Enterprise C (subtle, clean) ‚îÄ‚îÄ */
        .sh { display:flex; align-items:center; gap:10px; margin: 6px 0 0; }
        .sh-title{
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            letter-spacing: .02em;
            text-transform: none;
            font-family: inherit;
        }
        .sh-line{ flex:1; height:1px; background: rgba(255,255,255,.25); }
        .sh-tag{
            font-size: 11px;
            font-weight: 700;
            background: rgba(255,255,255,.18);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 4px 11px;
            letter-spacing: 0;
            text-transform: none;
            font-family: inherit;
        }

        /* layout */
        .ent-row { display:grid; grid-template-columns: 360px 1fr; gap: 12px; }

        /* ‚îÄ‚îÄ White card system ‚îÄ‚îÄ */
        .hero, .site-card, .proc-wrap, .issues-panel, .log-panel, .log-wrap{
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.10);
            border: none;
        }

        /* Hero */
        .hero { padding: 20px 24px; align-items: flex-start; justify-content: center; }
        .hero::before { display:none; }
        .hero-lbl { font-size: 11px; color: #777; letter-spacing: .5px; text-transform: uppercase; }
        .hero-val { font-size: 64px; font-weight: 900; color: #3498db; }
        .hero-sub { gap: 18px; }
        .hm-val { color:#2c3e50; }
        .hm-lbl { color:#888; }

        /* site cards */
        .site-grid { gap: 12px; }
        .sc-head{
            background: #f7f7f7;
            border-bottom: 1px solid #eee;
            padding: 12px 14px;
        }
        .sc-name{ color:#2c3e50; font-size:16px; letter-spacing: .02em; text-transform:none; }
        .sc-oee{ color:#3498db; font-size: 32px; }
        .sc-body{ padding: 12px 14px; }
        .ape-cell{
            background: #f7f7f7;
            border: 1px solid #eee;
            border-radius: 7px;
            padding: 8px 6px;
        }
        .ape-v{ color:#2c3e50; }
        .ape-l{ color:#999; }

        /* process containers */
        .proc-site-hdr{
            background: #f7f7f7;
            border-bottom: 1px solid #eee;
            padding: 10px 14px;
        }
        .psh-name{ color:#1565C0; font-size: 12px; text-transform: uppercase; letter-spacing: .08em; }
        .proc-grid{
            background: transparent;
            gap: 12px;
            grid-template-columns: repeat(4, 1fr);
            padding: 12px;
        }
        .pc{
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border: 1px solid #eee;
            padding: 14px 14px;
        }
        .pc:hover{ transform: translateY(-2px); transition: transform .2s; background: #fff; }
        .pc-name{ color:#777; font-size: 10px; }
        .pc-name::before{ background:#3498db; }
        .pc-oee{ color:#2c3e50; font-size: 28px; }
        .pc-bar-wrap{ background:#eee; height:5px; border-radius: 3px; margin-bottom:10px; }
        .pc-bar{ height:100%; border-radius:3px; background: linear-gradient(90deg,#3498db,#2c3e50); }
        .pcm-v{ color:#2c3e50; }
        .pcm-l{ color:#999; }

        /* neutralize old color classes; keep semantics but match C feel */
        .c-ex{ color: var(--green); }
        .c-gd{ color: #43a047; }
        .c-ok{ color: var(--amber); }
        .c-po{ color: var(--red); }
        .c-na{ color: var(--muted); }
        .sk{ background: #eee; color: transparent !important; animation: none; }

        /* issues panel */
        .issues-hdr{
            background: #f7f7f7;
            border-bottom: 1px solid #eee;
            padding: 12px 16px;
        }
        .issues-title{ color:#2c3e50; font-weight: 600; }
        .issues-body{ padding: 12px 16px; }
        .issue-row{ border-radius: 7px; }
        .issue-row.issue-err{ background:#ffebee; border-left: 5px solid #f44336; }
        .issue-row.issue-warn{ background:#fff8e1; border-left: 5px solid #FF9800; }
        .issue-row.issue-info{ background:#e3f2fd; border-left: 5px solid #2196F3; }
        .issue-row.issue-ok{ background:#e8f5e9; border-left: 5px solid #4CAF50; }
        .issue-detail{ color:#666; }
        .issues-legend{ color:#888; }

        .clickable:hover{ box-shadow: 0 0 0 1px rgba(0,0,0,.04), 0 0 0 3px rgba(52,152,219,.18); }

        /* stats strip as cards */
        .stat-strip{
            padding: 0;
            display: grid;
            grid-template-columns: repeat(5, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        .stat-chip{
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.10);
            border: none;
            padding: 14px 16px;
            font-size: 11px;
            color: #888;
        }
        .stat-chip strong{ color:#3498db; font-size: 18px; }
        .stat-chip.err strong{ color:#f44336; }

        /* ‚îÄ‚îÄ API Call Log (Enterprise C style) ‚îÄ‚îÄ */
        .log-panel{
            background: #0d1117;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.30);
        }
        .log-header{
            display:flex; align-items:center; gap:12px;
            padding:10px 16px;
            cursor:pointer;
            background:#161b22;
            border-bottom: 1px solid #30363d;
            user-select:none;
        }
        .log-header:hover{ background:#1c2128; }
        .log-title{ color:#e6edf3; font-size:13px; font-weight:600; flex:1; }
        .log-stat{ font-size:11px; font-weight:700; padding:2px 8px; border-radius:10px; }
        .ls-total{ background:#21262d; color:#8b949e; }
        .ls-ok{ background:#1a3a1a; color:#3fb950; }
        .ls-err{ background:#3a1a1a; color:#f85149; }
        .ls-rows{ background:#1a2a3a; color:#58a6ff; }
        .log-caret{ color:#8b949e; font-size:12px; transition: transform .2s; }
        .log-caret.open{ transform: rotate(180deg); }

        .log-toolbar{
            display:flex; gap:8px; align-items:center;
            padding:8px 16px;
            background:#161b22;
            border-bottom: 1px solid #30363d;
        }
        .log-toolbar input{
            flex:1;
            padding:4px 8px;
            border-radius:4px;
            border:1px solid #30363d;
            background:#0d1117;
            color:#e6edf3;
            font-size:11px;
            font-family: 'Cascadia Code','Consolas','Courier New',monospace;
        }
        .log-filter-btn{
            padding:3px 9px;
            border:none;
            border-radius:4px;
            font-size:11px;
            font-weight:600;
            cursor:pointer;
            background:#21262d;
            color:#8b949e;
            transition:.15s;
        }
        .log-filter-btn.active{ background:#1f6feb; color:#fff; }
        .log-filter-btn:hover:not(.active){ background:#30363d; }
        .log-clear{
            padding:3px 9px; border:none; border-radius:4px;
            font-size:11px; cursor:pointer;
            background:#3a1a1a; color:#f85149;
        }
        .log-clear:hover{ background:#5a2020; }

        .log-body{
            max-height: 380px;
            overflow-y: auto;
            font-family: 'Cascadia Code','Consolas','Courier New',monospace;
        }
        .log-entry{
            display:grid;
            grid-template-columns: 68px 45px 55px 85px 1fr 70px 60px;
            align-items:center;
            padding:4px 0;
            border-bottom: 1px solid #161b22;
            font-size:11px;
        }
        .log-entry:hover{ background:#161b22; }
        .log-entry.hidden{ display:none; }
        .log-entry.log-err{ border-left: 3px solid #f85149; }
        .log-entry.log-ok{ border-left: 3px solid transparent; }

        .le-time{ color:#8b949e; padding-left:12px; white-space:nowrap; }
        .le-method{ font-weight:700; text-align:center; }
        .le-method.m-get{ color:#3fb950; }
        .le-method.m-post{ color:#58a6ff; }
        .le-status{ text-align:center; }
        .le-status.s-ok{ color:#3fb950; }
        .le-status.s-err{ color:#f85149; font-weight:700; }
        .le-dur{ color:#e3b341; text-align:right; padding-right:8px; }
        .le-path{ color:#79c0ff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding: 0 6px; }
        .le-detail{ color:#8b949e; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:10px; }
        .le-rows{ color:#a5d6ff; text-align:right; padding-right:14px; white-space:nowrap; font-size:10px; }

        .log-col-header{
            display:grid;
            grid-template-columns: 68px 45px 55px 85px 1fr 70px 60px;
            padding:5px 0;
            background:#161b22;
            font-size:10px;
            color:#484f58;
            font-family: 'Cascadia Code','Consolas','Courier New',monospace;
            border-bottom: 1px solid #30363d;
            text-transform: uppercase;
            letter-spacing: .5px;
        }
        .log-col-header span:first-child{ padding-left:12px; }
        .log-col-header span:nth-child(6){ text-align:right; padding-right:8px; }
        .log-col-header span:last-child{ text-align:right; padding-right:14px; }

        .row-summary{
            border-top: 1px solid #30363d;
            padding: 10px 16px;
            display:flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .row-summary-title{
            color:#484f58; font-size:10px;
            text-transform: uppercase; letter-spacing: .5px;
            white-space: nowrap;
        }
        .row-tbl{ display:flex; align-items:center; gap:6px; font-family: monospace; font-size:11px; }
        .row-tbl-name{ color:#79c0ff; }
        .row-tbl-cnt{ color:#3fb950; font-weight:700; }
        .row-tbl-sep{ color:#30363d; }

        /* responsive tweaks */
        @media (max-width: 1100px){
            .ent-row{ grid-template-columns: 1fr; }
            .site-grid{ grid-template-columns: 1fr; }
            .stat-strip{ grid-template-columns: repeat(2, 1fr); }
            .proc-grid{ grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px){
            .stat-strip{ grid-template-columns: 1fr; }
            .proc-grid{ grid-template-columns: 1fr; }
        }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header>
  <div class="hdr-left">
    <div class="diamond"></div>
    <div>
      <div class="hdr-title"><span>Enterprise B</span> ‚Äî OEE Live</div>
      <div class="hdr-sub">BOTTLE FACTORY ¬∑ ANYLOG DISTRIBUTED HISTORIAN ¬∑ UNS-AWARE</div>
    </div>
  </div>
  <div class="hdr-right">
    <div class="status-chip"><div class="dot" id="dot"></div><span id="conn-lbl">CONNECTING</span></div>
    <span id="ts">‚Äî</span>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTROL BAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="ctrl-bar">
  <div class="cg">
    <span class="cl">Proxy URL</span>
    <input id="proxy-url" class="ci ci-url" type="text" value="http://localhost:5001"
           placeholder="http://host:port">
    <button class="btn btn-apply" onclick="applyConfig()">Apply</button>
  </div>
  <div class="cg">
    <span class="cl">Interval (s)</span>
    <input id="interval" class="ci ci-num" type="number" value="30" min="5" max="600">
  </div>
  <div class="cg">
    <span class="cl">Lookback</span>
    <select id="lookback" class="ci ci-sel">
      <option value="1 hour">1 Hour</option>
      <option value="4 hours" selected>4 Hours</option>
      <option value="8 hours">8 Hours</option>
      <option value="1 day">1 Day</option>
    </select>
  </div>
  <button class="btn btn-pause" id="pause-btn" onclick="togglePause()">‚è∏ Pause</button>
  <div class="countdown" id="cd">‚Äî</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STAT STRIP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="stat-strip">
  <div class="stat-chip">Proxy calls <strong id="s-proxy">0</strong></div>
  <div class="stat-chip">AnyLog SQL calls <strong id="s-anylog">0</strong></div>
  <div class="stat-chip">Rows fetched <strong id="s-rows">0</strong></div>
  <div class="stat-chip err">Errors <strong id="s-err">0</strong></div>
  <div class="stat-chip">Avg latency <strong id="s-lat">‚Äî</strong></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<main>

  <!-- Enterprise overview -->
  <section id="enterprise-section">
    <div class="sh">
      <span class="sh-title">Enterprise Overall OEE</span>
      <div class="sh-line"></div>
      <span class="sh-tag">Enterprise_B ¬∑ bottle_factory</span>
    </div>
    <div class="ent-row">
      <div class="hero">
        <div class="hero-lbl">Enterprise OEE</div>
        <div class="hero-val sk c-na" id="e-oee">‚Äî ‚Äî</div>
        <div class="hero-sub">
          <div class="hm"><div class="hm-val sk" id="e-avail">‚Äî</div><div class="hm-lbl">Availability</div></div>
          <div class="hm"><div class="hm-val sk" id="e-perf">‚Äî</div><div class="hm-lbl">Performance</div></div>
          <div class="hm"><div class="hm-val sk" id="e-qual">‚Äî</div><div class="hm-lbl">Quality</div></div>
        </div>
      </div>
      <div class="site-grid" id="site-grid"></div>
    </div>
  </section>

  <!-- Process OEE per site -->
  <section id="proc-matrix-section">
    <div class="sh">
      <span class="sh-title">Process OEE by Site</span>
      <div class="sh-line"></div>
      <span class="sh-tag">UNS-derived ¬∑ 4 processes √ó 3 sites</span>
    </div>
    <div id="proc-container" style="display:flex;flex-direction:column;gap:12px;"></div>
  </section>

  <!-- Drilldown -->
  <section id="drill-section" style="display:none;">
    <div class="sh">
      <span class="sh-title" id="drill-title">Drilldown</span>
      <div class="sh-line"></div>
      <span class="sh-tag" id="drill-subtitle">Click into sites ‚Üí processes ‚Üí subprocesses</span>
    </div>
    <div id="breadcrumbs" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;"></div>
    <div id="drill-hero" class="hero" style="margin-bottom:12px;"></div>
    <div id="drill-grid" class="proc-grid"></div>
    <div id="drill-details" style="margin-top:12px;"></div>
  </section>

<!-- Log -->
  <section>
    <div class="log-panel" id="logPanel">
        <div class="log-header" onclick="toggleLog()">
            <span style="font-size:14px;">üñ•Ô∏è</span>
            <span class="log-title">API Call Log</span>
            <div class="log-stats">
                <span class="log-stat ls-total" id="log-total">0 calls</span>
                <span class="log-stat ls-ok"    id="log-ok">0 ok</span>
                <span class="log-stat ls-err"   id="log-err">0 err</span>
                <span class="log-stat ls-rows"  id="log-rows">0 rows</span>
            </div>
            <span class="log-caret" id="logCaret">‚ñº</span>
        </div>
        <div id="logContent" style="display:none;">
            <div class="log-toolbar">
                <input id="logSearch" type="text" placeholder="Filter by path, table, SQL‚Ä¶" oninput="filterLog()" />
                <button class="log-filter-btn active" onclick="setLogFilter('all',this)">All</button>
                <button class="log-filter-btn"        onclick="setLogFilter('get',this)">GET</button>
                <button class="log-filter-btn"        onclick="setLogFilter('post',this)">POST</button>
                <button class="log-filter-btn"        onclick="setLogFilter('error',this)">Errors</button>
                <button class="log-filter-btn"        onclick="setLogFilter('schema',this)">Schema</button>
                <button class="log-filter-btn"        onclick="setLogFilter('query',this)">Query</button>
                <button class="log-filter-btn"        onclick="setLogFilter('trend',this)">Trend</button>
                <button class="log-clear" onclick="clearLog()">Clear</button>
            </div>
            <div class="log-col-header">
                <span>Time</span>
                <span style="text-align:center;">Method</span>
                <span style="text-align:center;">Status</span>
                <span style="text-align:right;padding-right:8px;">Duration</span>
                <span style="padding-left:6px;">Proxy Endpoint ‚Üí AnyLog Command / SQL</span>
                <span style="text-align:right;padding-right:8px;">Table</span>
                <span style="text-align:right;padding-right:14px;">Rows</span>
            </div>
            <div class="log-body" id="logBody">
                <div style="padding:20px;text-align:center;color:#484f58;font-family:monospace;font-size:12px;">
                    ‚Äî No API calls yet. Connect to the proxy to begin logging. ‚Äî
                </div>
            </div>
            <div class="row-summary" id="rowSummary">
                <span class="row-summary-title">Rows returned by table:</span>
                <span id="rowSumContent" style="color:#484f58;font-size:11px;font-family:monospace;">‚Äî No data yet ‚Äî</span>
            </div>
        </div>
    </div>
  </section>

</main>

<script>
"use strict";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNS MAP  ‚Äî sourced from anylog-proveit MCP blockchain query
// Every 'metric' node = OEE for that level.
// workorder/lotnumber/item included where present in UNS.
// Last synced: 2026-02-15 via anylog-proveit MCP (listPolicies uns)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const UNS = {
  // ‚îÄ‚îÄ Enterprise level
  enterprise: {  // Enterprise_B
    metric: { dbms: 'bottle_factory', table: 'metric_64' },  // Enterprise_B/Metric
  },

  sites: {
    // ‚îÄ‚îÄ Site1
    Site1: {
      metric: { dbms: 'bottle_factory', table: 'metric_11' },  // Enterprise_B/Site1/metric
      processes: {
        // ‚îÄ‚îÄ Site1/fillerproduction
        fillerproduction: {
          metric: { dbms: 'bottle_factory', table: 'metric_52' },  // Enterprise_B/Site1/fillerproduction/metric
          assets: {
            // Enterprise_B/Site1/fillerproduction/fillingline01
            fillingline01: {
              metric: { dbms: 'bottle_factory', table: 'metric_28' },  // Enterprise_B/Site1/fillerproduction/fillingline01/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_1' },  // Enterprise_B/Site1/fillerproduction/fillingline01/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_1' },  // Enterprise_B/Site1/fillerproduction/fillingline01/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_1' },  // Enterprise_B/Site1/fillerproduction/fillingline01/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site1/fillerproduction/fillingline01/caploader
                caploader: {
                  metric: { dbms: 'bottle_factory', table: 'metric_60' },  // Enterprise_B/Site1/fillerproduction/fillingline01/caploader/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_43' },  // Enterprise_B/Site1/fillerproduction/fillingline01/caploader/processdata
                },
                // Enterprise_B/Site1/fillerproduction/fillingline01/filler
                filler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_10' },  // Enterprise_B/Site1/fillerproduction/fillingline01/filler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_29' },  // Enterprise_B/Site1/fillerproduction/fillingline01/filler/processdata
                },
                // Enterprise_B/Site1/fillerproduction/fillingline01/washer
                washer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_62' },  // Enterprise_B/Site1/fillerproduction/fillingline01/washer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_28' },  // Enterprise_B/Site1/fillerproduction/fillingline01/washer/processdata
                },
              },
            },
            // Enterprise_B/Site1/fillerproduction/fillingline02
            fillingline02: {
              metric: { dbms: 'bottle_factory', table: 'metric_55' },  // Enterprise_B/Site1/fillerproduction/fillingline02/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_4' },  // Enterprise_B/Site1/fillerproduction/fillingline02/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_5' },  // Enterprise_B/Site1/fillerproduction/fillingline02/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_4' },  // Enterprise_B/Site1/fillerproduction/fillingline02/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site1/fillerproduction/fillingline02/caploader
                caploader: {
                  metric: { dbms: 'bottle_factory', table: 'metric_45' },  // Enterprise_B/Site1/fillerproduction/fillingline02/caploader/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_23' },  // Enterprise_B/Site1/fillerproduction/fillingline02/caploader/processdata
                },
                // Enterprise_B/Site1/fillerproduction/fillingline02/filler
                filler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_53' },  // Enterprise_B/Site1/fillerproduction/fillingline02/filler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_33' },  // Enterprise_B/Site1/fillerproduction/fillingline02/filler/processdata
                },
                // Enterprise_B/Site1/fillerproduction/fillingline02/washer
                washer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_32' },  // Enterprise_B/Site1/fillerproduction/fillingline02/washer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_14' },  // Enterprise_B/Site1/fillerproduction/fillingline02/washer/processdata
                },
              },
            },
            // Enterprise_B/Site1/fillerproduction/fillingline03
            fillingline03: {
              metric: { dbms: 'bottle_factory', table: 'metric_1' },  // Enterprise_B/Site1/fillerproduction/fillingline03/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_6' },  // Enterprise_B/Site1/fillerproduction/fillingline03/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_8' },  // Enterprise_B/Site1/fillerproduction/fillingline03/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_8' },  // Enterprise_B/Site1/fillerproduction/fillingline03/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site1/fillerproduction/fillingline03/caploader
                caploader: {
                  metric: { dbms: 'bottle_factory', table: 'metric_12' },  // Enterprise_B/Site1/fillerproduction/fillingline03/caploader/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_40' },  // Enterprise_B/Site1/fillerproduction/fillingline03/caploader/processdata
                },
                // Enterprise_B/Site1/fillerproduction/fillingline03/filler
                filler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_49' },  // Enterprise_B/Site1/fillerproduction/fillingline03/filler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_6' },  // Enterprise_B/Site1/fillerproduction/fillingline03/filler/processdata
                },
                // Enterprise_B/Site1/fillerproduction/fillingline03/washer
                washer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_57' },  // Enterprise_B/Site1/fillerproduction/fillingline03/washer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_39' },  // Enterprise_B/Site1/fillerproduction/fillingline03/washer/processdata
                },
              },
            },
          },
        },
        // ‚îÄ‚îÄ Site1/liquidprocessing
        liquidprocessing: {
          metric: { dbms: 'bottle_factory', table: 'metric_9' },  // Enterprise_B/Site1/liquidprocessing/metric
          assets: {
            // Enterprise_B/Site1/liquidprocessing/mixroom01
            mixroom01: {
              metric: { dbms: 'bottle_factory', table: 'metric_17' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/metric
              assets: {
                // Enterprise_B/Site1/liquidprocessing/mixroom01/vat01
                vat01: {
                  metric: { dbms: 'bottle_factory', table: 'metric_3' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat01/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_25' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat01/processdata
                  workorder: { dbms: 'bottle_factory', table: 'workorder_3' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat01/workorder
                  workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_4' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat01/workorder/lotnumber
                  workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_3' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat01/workorder/lotnumber/item
                },
                // Enterprise_B/Site1/liquidprocessing/mixroom01/vat02
                vat02: {
                  metric: { dbms: 'bottle_factory', table: 'metric_6' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat02/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_16' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat02/processdata
                  workorder: { dbms: 'bottle_factory', table: 'workorder_5' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat02/workorder
                  workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_6' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat02/workorder/lotnumber
                  workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_5' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat02/workorder/lotnumber/item
                },
                // Enterprise_B/Site1/liquidprocessing/mixroom01/vat03
                vat03: {
                  metric: { dbms: 'bottle_factory', table: 'metric_41' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat03/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_26' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat03/processdata
                  workorder: { dbms: 'bottle_factory', table: 'workorder_9' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat03/workorder
                  workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_14' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat03/workorder/lotnumber
                  workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_14' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat03/workorder/lotnumber/item
                },
                // Enterprise_B/Site1/liquidprocessing/mixroom01/vat04
                vat04: {
                  metric: { dbms: 'bottle_factory', table: 'metric_4' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat04/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_24' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat04/processdata
                  workorder: { dbms: 'bottle_factory', table: 'workorder_2' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat04/workorder
                  workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_2' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat04/workorder/lotnumber
                  workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_2' },  // Enterprise_B/Site1/liquidprocessing/mixroom01/vat04/workorder/lotnumber/item
                },
              },
            },
            // Enterprise_B/Site1/liquidprocessing/tankstorage01
            tankstorage01: {
              metric: { dbms: 'bottle_factory', table: 'metric_15' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/metric
              assets: {
                // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank01
                tank01: {
                  metric: { dbms: 'bottle_factory', table: 'metric_35' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank01/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_11' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank01/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_10' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank01/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_10' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank01/lotnumber/item
                },
                // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank02
                tank02: {
                  metric: { dbms: 'bottle_factory', table: 'metric_31' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank02/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_37' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank02/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_3' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank02/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_6' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank02/lotnumber/item
                },
                // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank03
                tank03: {
                  metric: { dbms: 'bottle_factory', table: 'metric_47' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank03/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_9' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank03/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_7' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank03/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_7' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank03/lotnumber/item
                },
                // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank04
                tank04: {
                  metric: { dbms: 'bottle_factory', table: 'metric_36' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank04/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_31' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank04/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_11' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank04/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_11' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank04/lotnumber/item
                },
                // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank05
                tank05: {
                  metric: { dbms: 'bottle_factory', table: 'metric_14' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank05/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_3' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank05/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_12' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank05/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_12' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank05/lotnumber/item
                },
                // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank06
                tank06: {
                  metric: { dbms: 'bottle_factory', table: 'metric_37' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank06/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_2' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank06/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_16' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank06/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_17' },  // Enterprise_B/Site1/liquidprocessing/tankstorage01/tank06/lotnumber/item
                },
              },
            },
          },
        },
        // ‚îÄ‚îÄ Site1/packaging
        packaging: {
          metric: { dbms: 'bottle_factory', table: 'metric_27' },  // Enterprise_B/Site1/packaging/metric
          assets: {
            // Enterprise_B/Site1/packaging/labelerline01
            labelerline01: {
              metric: { dbms: 'bottle_factory', table: 'metric_23' },  // Enterprise_B/Site1/packaging/labelerline01/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_11' },  // Enterprise_B/Site1/packaging/labelerline01/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_17' },  // Enterprise_B/Site1/packaging/labelerline01/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_16' },  // Enterprise_B/Site1/packaging/labelerline01/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site1/packaging/labelerline01/labeler
                labeler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_2' },  // Enterprise_B/Site1/packaging/labelerline01/labeler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_36' },  // Enterprise_B/Site1/packaging/labelerline01/labeler/processdata
                },
                // Enterprise_B/Site1/packaging/labelerline01/packager
                packager: {
                  metric: { dbms: 'bottle_factory', table: 'metric_38' },  // Enterprise_B/Site1/packaging/labelerline01/packager/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_5' },  // Enterprise_B/Site1/packaging/labelerline01/packager/processdata
                },
                // Enterprise_B/Site1/packaging/labelerline01/sealer
                sealer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_16' },  // Enterprise_B/Site1/packaging/labelerline01/sealer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_42' },  // Enterprise_B/Site1/packaging/labelerline01/sealer/processdata
                },
              },
            },
            // Enterprise_B/Site1/packaging/labelerline02
            labelerline02: {
              metric: { dbms: 'bottle_factory', table: 'metric_63' },  // Enterprise_B/Site1/packaging/labelerline02/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_10' },  // Enterprise_B/Site1/packaging/labelerline02/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_15' },  // Enterprise_B/Site1/packaging/labelerline02/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_15' },  // Enterprise_B/Site1/packaging/labelerline02/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site1/packaging/labelerline02/labeler
                labeler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_48' },  // Enterprise_B/Site1/packaging/labelerline02/labeler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_17' },  // Enterprise_B/Site1/packaging/labelerline02/labeler/processdata
                },
                // Enterprise_B/Site1/packaging/labelerline02/packager
                packager: {
                  metric: { dbms: 'bottle_factory', table: 'metric_18' },  // Enterprise_B/Site1/packaging/labelerline02/packager/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_12' },  // Enterprise_B/Site1/packaging/labelerline02/packager/processdata
                },
                // Enterprise_B/Site1/packaging/labelerline02/sealer
                sealer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_22' },  // Enterprise_B/Site1/packaging/labelerline02/sealer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_15' },  // Enterprise_B/Site1/packaging/labelerline02/sealer/processdata
                },
              },
            },
            // Enterprise_B/Site1/packaging/labelerline03
            labelerline03: {
              metric: { dbms: 'bottle_factory', table: 'metric_33' },  // Enterprise_B/Site1/packaging/labelerline03/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_7' },  // Enterprise_B/Site1/packaging/labelerline03/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_9' },  // Enterprise_B/Site1/packaging/labelerline03/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_9' },  // Enterprise_B/Site1/packaging/labelerline03/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site1/packaging/labelerline03/labeler
                labeler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_5' },  // Enterprise_B/Site1/packaging/labelerline03/labeler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_41' },  // Enterprise_B/Site1/packaging/labelerline03/labeler/processdata
                },
                // Enterprise_B/Site1/packaging/labelerline03/packager
                packager: {
                  metric: { dbms: 'bottle_factory', table: 'metric_26' },  // Enterprise_B/Site1/packaging/labelerline03/packager/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_30' },  // Enterprise_B/Site1/packaging/labelerline03/packager/processdata
                },
                // Enterprise_B/Site1/packaging/labelerline03/sealer
                sealer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_8' },  // Enterprise_B/Site1/packaging/labelerline03/sealer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_18' },  // Enterprise_B/Site1/packaging/labelerline03/sealer/processdata
                },
              },
            },
            // Enterprise_B/Site1/packaging/labelerline04
            labelerline04: {
              metric: { dbms: 'bottle_factory', table: 'metric_34' },  // Enterprise_B/Site1/packaging/labelerline04/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_8' },  // Enterprise_B/Site1/packaging/labelerline04/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_13' },  // Enterprise_B/Site1/packaging/labelerline04/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_13' },  // Enterprise_B/Site1/packaging/labelerline04/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site1/packaging/labelerline04/labeler
                labeler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_50' },  // Enterprise_B/Site1/packaging/labelerline04/labeler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_34' },  // Enterprise_B/Site1/packaging/labelerline04/labeler/processdata
                },
                // Enterprise_B/Site1/packaging/labelerline04/packager
                packager: {
                  metric: { dbms: 'bottle_factory', table: 'metric_40' },  // Enterprise_B/Site1/packaging/labelerline04/packager/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_35' },  // Enterprise_B/Site1/packaging/labelerline04/packager/processdata
                },
                // Enterprise_B/Site1/packaging/labelerline04/sealer
                sealer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_54' },  // Enterprise_B/Site1/packaging/labelerline04/sealer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_27' },  // Enterprise_B/Site1/packaging/labelerline04/sealer/processdata
                },
              },
            },
          },
        },
        // ‚îÄ‚îÄ Site1/palletizing
        palletizing: {
          metric: { dbms: 'bottle_factory', table: 'metric_20' },  // Enterprise_B/Site1/palletizing/metric
          assets: {
            // Enterprise_B/Site1/palletizing/palletizer01
            palletizer01: {
              metric: { dbms: 'bottle_factory', table: 'metric_39' },  // Enterprise_B/Site1/palletizing/palletizer01/metric
              assets: {
                // Enterprise_B/Site1/palletizing/palletizer01/pallet01
                pallet01: {
                  metric: { dbms: 'bottle_factory', table: 'metric_42' },  // Enterprise_B/Site1/palletizing/palletizer01/pallet01/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_20' },  // Enterprise_B/Site1/palletizing/palletizer01/pallet01/processdata
                },
                // Enterprise_B/Site1/palletizing/palletizer01/pallet02
                pallet02: {
                  metric: { dbms: 'bottle_factory', table: 'metric_44' },  // Enterprise_B/Site1/palletizing/palletizer01/pallet02/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_4' },  // Enterprise_B/Site1/palletizing/palletizer01/pallet02/processdata
                },
                // Enterprise_B/Site1/palletizing/palletizer01/robot
                robot: {
                  metric: { dbms: 'bottle_factory', table: 'metric_59' },  // Enterprise_B/Site1/palletizing/palletizer01/robot/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_19' },  // Enterprise_B/Site1/palletizing/palletizer01/robot/processdata
                },
                // Enterprise_B/Site1/palletizing/palletizer01/wrapper
                wrapper: {
                  metric: { dbms: 'bottle_factory', table: 'metric_19' },  // Enterprise_B/Site1/palletizing/palletizer01/wrapper/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_22' },  // Enterprise_B/Site1/palletizing/palletizer01/wrapper/processdata
                },
              },
            },
            // Enterprise_B/Site1/palletizing/palletizer02
            palletizer02: {
              metric: { dbms: 'bottle_factory', table: 'metric_46' },  // Enterprise_B/Site1/palletizing/palletizer02/metric
              assets: {
                // Enterprise_B/Site1/palletizing/palletizer02/pallet01
                pallet01: {
                  metric: { dbms: 'bottle_factory', table: 'metric_30' },  // Enterprise_B/Site1/palletizing/palletizer02/pallet01/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_1' },  // Enterprise_B/Site1/palletizing/palletizer02/pallet01/processdata
                },
                // Enterprise_B/Site1/palletizing/palletizer02/pallet02
                pallet02: {
                  metric: { dbms: 'bottle_factory', table: 'metric_25' },  // Enterprise_B/Site1/palletizing/palletizer02/pallet02/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_21' },  // Enterprise_B/Site1/palletizing/palletizer02/pallet02/processdata
                },
                // Enterprise_B/Site1/palletizing/palletizer02/robot
                robot: {
                  metric: { dbms: 'bottle_factory', table: 'metric_7' },  // Enterprise_B/Site1/palletizing/palletizer02/robot/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_8' },  // Enterprise_B/Site1/palletizing/palletizer02/robot/processdata
                },
                // Enterprise_B/Site1/palletizing/palletizer02/wrapper
                wrapper: {
                  metric: { dbms: 'bottle_factory', table: 'metric_43' },  // Enterprise_B/Site1/palletizing/palletizer02/wrapper/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_38' },  // Enterprise_B/Site1/palletizing/palletizer02/wrapper/processdata
                },
              },
            },
            // Enterprise_B/Site1/palletizing/palletizermanual01
            palletizermanual01: {
              metric: { dbms: 'bottle_factory', table: 'metric_24' },  // Enterprise_B/Site1/palletizing/palletizermanual01/metric
              assets: {
                // Enterprise_B/Site1/palletizing/palletizermanual01/workstation
                workstation: {
                  metric: { dbms: 'bottle_factory', table: 'metric_13' },  // Enterprise_B/Site1/palletizing/palletizermanual01/workstation/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_32' },  // Enterprise_B/Site1/palletizing/palletizermanual01/workstation/processdata
                },
              },
            },
            // Enterprise_B/Site1/palletizing/palletizermanual02
            palletizermanual02: {
              metric: { dbms: 'bottle_factory', table: 'metric_58' },  // Enterprise_B/Site1/palletizing/palletizermanual02/metric
              assets: {
                // Enterprise_B/Site1/palletizing/palletizermanual02/workstation
                workstation: {
                  metric: { dbms: 'bottle_factory', table: 'metric_61' },  // Enterprise_B/Site1/palletizing/palletizermanual02/workstation/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_10' },  // Enterprise_B/Site1/palletizing/palletizermanual02/workstation/processdata
                },
              },
            },
            // Enterprise_B/Site1/palletizing/palletizermanual03
            palletizermanual03: {
              metric: { dbms: 'bottle_factory', table: 'metric_56' },  // Enterprise_B/Site1/palletizing/palletizermanual03/metric
              assets: {
                // Enterprise_B/Site1/palletizing/palletizermanual03/workstation
                workstation: {
                  metric: { dbms: 'bottle_factory', table: 'metric_21' },  // Enterprise_B/Site1/palletizing/palletizermanual03/workstation/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_7' },  // Enterprise_B/Site1/palletizing/palletizermanual03/workstation/processdata
                },
              },
            },
            // Enterprise_B/Site1/palletizing/palletizermanual04
            palletizermanual04: {
              metric: { dbms: 'bottle_factory', table: 'metric_51' },  // Enterprise_B/Site1/palletizing/palletizermanual04/metric
              assets: {
                // Enterprise_B/Site1/palletizing/palletizermanual04/workstation
                workstation: {
                  metric: { dbms: 'bottle_factory', table: 'metric_29' },  // Enterprise_B/Site1/palletizing/palletizermanual04/workstation/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_13' },  // Enterprise_B/Site1/palletizing/palletizermanual04/workstation/processdata
                },
              },
            },
          },
        },
      },
    },
    // ‚îÄ‚îÄ Site2
    Site2: {
      metric: { dbms: 'bottle_factory', table: 'metric_77' },  // Enterprise_B/Site2/metric
      processes: {
        // ‚îÄ‚îÄ Site2/fillerproduction
        fillerproduction: {
          metric: { dbms: 'bottle_factory', table: 'metric_76' },  // Enterprise_B/Site2/fillerproduction/metric
          assets: {
            // Enterprise_B/Site2/fillerproduction/fillingline01
            fillingline01: {
              metric: { dbms: 'bottle_factory', table: 'metric_90' },  // Enterprise_B/Site2/fillerproduction/fillingline01/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_13' },  // Enterprise_B/Site2/fillerproduction/fillingline01/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_19' },  // Enterprise_B/Site2/fillerproduction/fillingline01/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_19' },  // Enterprise_B/Site2/fillerproduction/fillingline01/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site2/fillerproduction/fillingline01/caploader
                caploader: {
                  metric: { dbms: 'bottle_factory', table: 'metric_95' },  // Enterprise_B/Site2/fillerproduction/fillingline01/caploader/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_57' },  // Enterprise_B/Site2/fillerproduction/fillingline01/caploader/processdata
                },
                // Enterprise_B/Site2/fillerproduction/fillingline01/filler
                filler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_65' },  // Enterprise_B/Site2/fillerproduction/fillingline01/filler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_46' },  // Enterprise_B/Site2/fillerproduction/fillingline01/filler/processdata
                },
                // Enterprise_B/Site2/fillerproduction/fillingline01/washer
                washer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_97' },  // Enterprise_B/Site2/fillerproduction/fillingline01/washer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_51' },  // Enterprise_B/Site2/fillerproduction/fillingline01/washer/processdata
                },
              },
            },
            // Enterprise_B/Site2/fillerproduction/fillingline02
            fillingline02: {
              metric: { dbms: 'bottle_factory', table: 'metric_66' },  // Enterprise_B/Site2/fillerproduction/fillingline02/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_15' },  // Enterprise_B/Site2/fillerproduction/fillingline02/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_22' },  // Enterprise_B/Site2/fillerproduction/fillingline02/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_22' },  // Enterprise_B/Site2/fillerproduction/fillingline02/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site2/fillerproduction/fillingline02/caploader
                caploader: {
                  metric: { dbms: 'bottle_factory', table: 'metric_85' },  // Enterprise_B/Site2/fillerproduction/fillingline02/caploader/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_63' },  // Enterprise_B/Site2/fillerproduction/fillingline02/caploader/processdata
                },
                // Enterprise_B/Site2/fillerproduction/fillingline02/filler
                filler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_94' },  // Enterprise_B/Site2/fillerproduction/fillingline02/filler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_59' },  // Enterprise_B/Site2/fillerproduction/fillingline02/filler/processdata
                },
                // Enterprise_B/Site2/fillerproduction/fillingline02/washer
                washer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_100' },  // Enterprise_B/Site2/fillerproduction/fillingline02/washer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_50' },  // Enterprise_B/Site2/fillerproduction/fillingline02/washer/processdata
                },
              },
            },
          },
        },
        // ‚îÄ‚îÄ Site2/liquidprocessing
        liquidprocessing: {
          metric: { dbms: 'bottle_factory', table: 'metric_82' },  // Enterprise_B/Site2/liquidprocessing/metric
          assets: {
            // Enterprise_B/Site2/liquidprocessing/mixroom01
            mixroom01: {
              metric: { dbms: 'bottle_factory', table: 'metric_91' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/metric
              assets: {
                // Enterprise_B/Site2/liquidprocessing/mixroom01/vat01
                vat01: {
                  metric: { dbms: 'bottle_factory', table: 'metric_69' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat01/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_64' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat01/processdata
                  workorder: { dbms: 'bottle_factory', table: 'workorder_16' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat01/workorder
                  workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_24' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat01/workorder/lotnumber
                  workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_23' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat01/workorder/lotnumber/item
                },
                // Enterprise_B/Site2/liquidprocessing/mixroom01/vat02
                vat02: {
                  metric: { dbms: 'bottle_factory', table: 'metric_99' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat02/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_49' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat02/processdata
                  workorder: { dbms: 'bottle_factory', table: 'workorder_17' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat02/workorder
                  workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_26' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat02/workorder/lotnumber
                  workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_25' },  // Enterprise_B/Site2/liquidprocessing/mixroom01/vat02/workorder/lotnumber/item
                },
              },
            },
            // Enterprise_B/Site2/liquidprocessing/tankstorage01
            tankstorage01: {
              metric: { dbms: 'bottle_factory', table: 'metric_79' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/metric
              assets: {
                // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank01
                tank01: {
                  metric: { dbms: 'bottle_factory', table: 'metric_67' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank01/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_45' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank01/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_25' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank01/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_24' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank01/lotnumber/item
                },
                // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank02
                tank02: {
                  metric: { dbms: 'bottle_factory', table: 'metric_86' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank02/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_55' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank02/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_20' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank02/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_20' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank02/lotnumber/item
                },
                // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank03
                tank03: {
                  metric: { dbms: 'bottle_factory', table: 'metric_78' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank03/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_61' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank03/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_23' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank03/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_21' },  // Enterprise_B/Site2/liquidprocessing/tankstorage01/tank03/lotnumber/item
                },
              },
            },
          },
        },
        // ‚îÄ‚îÄ Site2/packaging
        packaging: {
          metric: { dbms: 'bottle_factory', table: 'metric_80' },  // Enterprise_B/Site2/packaging/metric
          assets: {
            // Enterprise_B/Site2/packaging/labelerline01
            labelerline01: {
              metric: { dbms: 'bottle_factory', table: 'metric_96' },  // Enterprise_B/Site2/packaging/labelerline01/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_14' },  // Enterprise_B/Site2/packaging/labelerline01/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_21' },  // Enterprise_B/Site2/packaging/labelerline01/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_26' },  // Enterprise_B/Site2/packaging/labelerline01/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site2/packaging/labelerline01/labeler
                labeler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_92' },  // Enterprise_B/Site2/packaging/labelerline01/labeler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_52' },  // Enterprise_B/Site2/packaging/labelerline01/labeler/processdata
                },
                // Enterprise_B/Site2/packaging/labelerline01/packager
                packager: {
                  metric: { dbms: 'bottle_factory', table: 'metric_70' },  // Enterprise_B/Site2/packaging/labelerline01/packager/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_58' },  // Enterprise_B/Site2/packaging/labelerline01/packager/processdata
                },
                // Enterprise_B/Site2/packaging/labelerline01/sealer
                sealer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_68' },  // Enterprise_B/Site2/packaging/labelerline01/sealer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_48' },  // Enterprise_B/Site2/packaging/labelerline01/sealer/processdata
                },
              },
            },
            // Enterprise_B/Site2/packaging/labelerline02
            labelerline02: {
              metric: { dbms: 'bottle_factory', table: 'metric_88' },  // Enterprise_B/Site2/packaging/labelerline02/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_12' },  // Enterprise_B/Site2/packaging/labelerline02/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_18' },  // Enterprise_B/Site2/packaging/labelerline02/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_18' },  // Enterprise_B/Site2/packaging/labelerline02/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site2/packaging/labelerline02/labeler
                labeler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_71' },  // Enterprise_B/Site2/packaging/labelerline02/labeler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_53' },  // Enterprise_B/Site2/packaging/labelerline02/labeler/processdata
                },
                // Enterprise_B/Site2/packaging/labelerline02/packager
                packager: {
                  metric: { dbms: 'bottle_factory', table: 'metric_73' },  // Enterprise_B/Site2/packaging/labelerline02/packager/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_62' },  // Enterprise_B/Site2/packaging/labelerline02/packager/processdata
                },
                // Enterprise_B/Site2/packaging/labelerline02/sealer
                sealer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_87' },  // Enterprise_B/Site2/packaging/labelerline02/sealer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_60' },  // Enterprise_B/Site2/packaging/labelerline02/sealer/processdata
                },
              },
            },
          },
        },
        // ‚îÄ‚îÄ Site2/palletizing
        palletizing: {
          metric: { dbms: 'bottle_factory', table: 'metric_83' },  // Enterprise_B/Site2/palletizing/metric
          assets: {
            // Enterprise_B/Site2/palletizing/palletizer01
            palletizer01: {
              metric: { dbms: 'bottle_factory', table: 'metric_98' },  // Enterprise_B/Site2/palletizing/palletizer01/metric
              assets: {
                // Enterprise_B/Site2/palletizing/palletizer01/pallet01
                pallet01: {
                  metric: { dbms: 'bottle_factory', table: 'metric_72' },  // Enterprise_B/Site2/palletizing/palletizer01/pallet01/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_56' },  // Enterprise_B/Site2/palletizing/palletizer01/pallet01/processdata
                },
                // Enterprise_B/Site2/palletizing/palletizer01/pallet02
                pallet02: {
                  metric: { dbms: 'bottle_factory', table: 'metric_93' },  // Enterprise_B/Site2/palletizing/palletizer01/pallet02/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_66' },  // Enterprise_B/Site2/palletizing/palletizer01/pallet02/processdata
                },
                // Enterprise_B/Site2/palletizing/palletizer01/robot
                robot: {
                  metric: { dbms: 'bottle_factory', table: 'metric_81' },  // Enterprise_B/Site2/palletizing/palletizer01/robot/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_65' },  // Enterprise_B/Site2/palletizing/palletizer01/robot/processdata
                },
                // Enterprise_B/Site2/palletizing/palletizer01/wrapper
                wrapper: {
                  metric: { dbms: 'bottle_factory', table: 'metric_89' },  // Enterprise_B/Site2/palletizing/palletizer01/wrapper/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_44' },  // Enterprise_B/Site2/palletizing/palletizer01/wrapper/processdata
                },
              },
            },
            // Enterprise_B/Site2/palletizing/palletizermanual01
            palletizermanual01: {
              metric: { dbms: 'bottle_factory', table: 'metric_75' },  // Enterprise_B/Site2/palletizing/palletizermanual01/metric
              assets: {
                // Enterprise_B/Site2/palletizing/palletizermanual01/workstation
                workstation: {
                  metric: { dbms: 'bottle_factory', table: 'metric_84' },  // Enterprise_B/Site2/palletizing/palletizermanual01/workstation/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_54' },  // Enterprise_B/Site2/palletizing/palletizermanual01/workstation/processdata
                },
              },
            },
            // Enterprise_B/Site2/palletizing/palletizermanual02
            palletizermanual02: {
              metric: { dbms: 'bottle_factory', table: 'metric_101' },  // Enterprise_B/Site2/palletizing/palletizermanual02/metric
              assets: {
                // Enterprise_B/Site2/palletizing/palletizermanual02/workstation
                workstation: {
                  metric: { dbms: 'bottle_factory', table: 'metric_74' },  // Enterprise_B/Site2/palletizing/palletizermanual02/workstation/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_47' },  // Enterprise_B/Site2/palletizing/palletizermanual02/workstation/processdata
                },
              },
            },
          },
        },
      },
    },
    // ‚îÄ‚îÄ Site3
    Site3: {
      metric: { dbms: 'bottle_factory', table: 'metric_104' },  // Enterprise_B/Site3/metric
      processes: {
        // ‚îÄ‚îÄ Site3/fillerproduction
        fillerproduction: {
          metric: { dbms: 'bottle_factory', table: 'metric_115' },  // Enterprise_B/Site3/fillerproduction/metric
          assets: {
            // Enterprise_B/Site3/fillerproduction/fillingline01
            fillingline01: {
              metric: { dbms: 'bottle_factory', table: 'metric_117' },  // Enterprise_B/Site3/fillerproduction/fillingline01/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_20' },  // Enterprise_B/Site3/fillerproduction/fillingline01/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_30' },  // Enterprise_B/Site3/fillerproduction/fillingline01/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_30' },  // Enterprise_B/Site3/fillerproduction/fillingline01/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site3/fillerproduction/fillingline01/caploader
                caploader: {
                  metric: { dbms: 'bottle_factory', table: 'metric_114' },  // Enterprise_B/Site3/fillerproduction/fillingline01/caploader/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_70' },  // Enterprise_B/Site3/fillerproduction/fillingline01/caploader/processdata
                },
                // Enterprise_B/Site3/fillerproduction/fillingline01/filler
                filler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_103' },  // Enterprise_B/Site3/fillerproduction/fillingline01/filler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_76' },  // Enterprise_B/Site3/fillerproduction/fillingline01/filler/processdata
                },
                // Enterprise_B/Site3/fillerproduction/fillingline01/washer
                washer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_119' },  // Enterprise_B/Site3/fillerproduction/fillingline01/washer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_71' },  // Enterprise_B/Site3/fillerproduction/fillingline01/washer/processdata
                },
              },
            },
          },
        },
        // ‚îÄ‚îÄ Site3/liquidprocessing
        liquidprocessing: {
          metric: { dbms: 'bottle_factory', table: 'metric_121' },  // Enterprise_B/Site3/liquidprocessing/metric
          assets: {
            // Enterprise_B/Site3/liquidprocessing/mixroom01
            mixroom01: {
              metric: { dbms: 'bottle_factory', table: 'metric_110' },  // Enterprise_B/Site3/liquidprocessing/mixroom01/metric
              assets: {
                // Enterprise_B/Site3/liquidprocessing/mixroom01/vat01
                vat01: {
                  metric: { dbms: 'bottle_factory', table: 'metric_112' },  // Enterprise_B/Site3/liquidprocessing/mixroom01/vat01/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_67' },  // Enterprise_B/Site3/liquidprocessing/mixroom01/vat01/processdata
                  workorder: { dbms: 'bottle_factory', table: 'workorder_19' },  // Enterprise_B/Site3/liquidprocessing/mixroom01/vat01/workorder
                  workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_28' },  // Enterprise_B/Site3/liquidprocessing/mixroom01/vat01/workorder/lotnumber
                  workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_28' },  // Enterprise_B/Site3/liquidprocessing/mixroom01/vat01/workorder/lotnumber/item
                },
              },
            },
            // Enterprise_B/Site3/liquidprocessing/tankstorage01
            tankstorage01: {
              metric: { dbms: 'bottle_factory', table: 'metric_105' },  // Enterprise_B/Site3/liquidprocessing/tankstorage01/metric
              assets: {
                // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank01
                tank01: {
                  metric: { dbms: 'bottle_factory', table: 'metric_109' },  // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank01/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_69' },  // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank01/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_31' },  // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank01/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_31' },  // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank01/lotnumber/item
                },
                // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank02
                tank02: {
                  metric: { dbms: 'bottle_factory', table: 'metric_107' },  // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank02/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_72' },  // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank02/processdata
                  lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_29' },  // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank02/lotnumber
                  lotnumber_item: { dbms: 'bottle_factory', table: 'item_29' },  // Enterprise_B/Site3/liquidprocessing/tankstorage01/tank02/lotnumber/item
                },
              },
            },
          },
        },
        // ‚îÄ‚îÄ Site3/packaging
        packaging: {
          metric: { dbms: 'bottle_factory', table: 'metric_106' },  // Enterprise_B/Site3/packaging/metric
          assets: {
            // Enterprise_B/Site3/packaging/labelerline01
            labelerline01: {
              metric: { dbms: 'bottle_factory', table: 'metric_108' },  // Enterprise_B/Site3/packaging/labelerline01/metric
              workorder: { dbms: 'bottle_factory', table: 'workorder_18' },  // Enterprise_B/Site3/packaging/labelerline01/workorder
              workorder_lotnumber: { dbms: 'bottle_factory', table: 'lotnumber_27' },  // Enterprise_B/Site3/packaging/labelerline01/workorder/lotnumber
              workorder_lotnumber_item: { dbms: 'bottle_factory', table: 'item_27' },  // Enterprise_B/Site3/packaging/labelerline01/workorder/lotnumber/item
              assets: {
                // Enterprise_B/Site3/packaging/labelerline01/labeler
                labeler: {
                  metric: { dbms: 'bottle_factory', table: 'metric_120' },  // Enterprise_B/Site3/packaging/labelerline01/labeler/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_75' },  // Enterprise_B/Site3/packaging/labelerline01/labeler/processdata
                },
                // Enterprise_B/Site3/packaging/labelerline01/packager
                packager: {
                  metric: { dbms: 'bottle_factory', table: 'metric_111' },  // Enterprise_B/Site3/packaging/labelerline01/packager/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_73' },  // Enterprise_B/Site3/packaging/labelerline01/packager/processdata
                },
                // Enterprise_B/Site3/packaging/labelerline01/sealer
                sealer: {
                  metric: { dbms: 'bottle_factory', table: 'metric_118' },  // Enterprise_B/Site3/packaging/labelerline01/sealer/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_68' },  // Enterprise_B/Site3/packaging/labelerline01/sealer/processdata
                },
              },
            },
          },
        },
        // ‚îÄ‚îÄ Site3/palletizing
        palletizing: {
          metric: { dbms: 'bottle_factory', table: 'metric_102' },  // Enterprise_B/Site3/palletizing/metric
          assets: {
            // Enterprise_B/Site3/palletizing/palletizermanual01
            palletizermanual01: {
              metric: { dbms: 'bottle_factory', table: 'metric_116' },  // Enterprise_B/Site3/palletizing/palletizermanual01/metric
              assets: {
                // Enterprise_B/Site3/palletizing/palletizermanual01/workstation
                workstation: {
                  metric: { dbms: 'bottle_factory', table: 'metric_113' },  // Enterprise_B/Site3/palletizing/palletizermanual01/workstation/metric
                  processdata: { dbms: 'bottle_factory', table: 'processdata_74' },  // Enterprise_B/Site3/palletizing/palletizermanual01/workstation/processdata
                },
              },
            },
          },
        },
      },
    },
  }
};  // end UNS


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Drilldown UNS index (loaded from REST proxy /api/uns)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let UNS_INDEX = [];     // [{namespace, dbms, table, name}]
let UNS_METRIC = [];    // subset: namespace endsWith('/metric')

// Navigation state
let VIEW = { level: 'enterprise', site: null, process: null, asset: null, leafNs: null };

async function loadUnsIndex() {
  const t0 = performance.now();
  let status = 0;
  let outLen = 0;
  try {
    const res = await fetch(`${proxyBase}/api/uns`, { cache: 'no-store' });
    status = res.status;
    if (!res.ok) throw new Error(`api/uns fetch failed: ${res.status}`);
    const payload = await res.json();

    // Supported payloads:
    // - { policies:[{uns:{...}}, ...] }
    // - { raw:"..."} where raw is a JSON array string OR a JSON-stringified JSON array
    // - { data:[...] } or plain [...]
    let raw = [];

    if (payload && Array.isArray(payload.policies)) raw = payload.policies;
    else if (Array.isArray(payload)) raw = payload;
    else if (payload && Array.isArray(payload.data)) raw = payload.data;
    else if (payload && typeof payload.raw === 'string') {
      let s = payload.raw;
      // Some proxies return payload.raw as a JSON-stringified string (double-encoded). Try up to 2 parses.
      for (let i=0;i<2;i++){
        try {
          const parsed = JSON.parse(s);
          if (Array.isArray(parsed)) { raw = parsed; break; }
          if (typeof parsed === 'string') { s = parsed; continue; }
          // Sometimes parsed is an object with policies.
          if (parsed && Array.isArray(parsed.policies)) { raw = parsed.policies; break; }
        } catch (_) {}
      }
      // Fallback: if raw still empty and looks like it contains many {"uns":...} objects, try to wrap.
      if (!raw.length && typeof s === 'string' && s.includes('"uns"') && s.trim().startsWith('{') === false) {
        try { raw = JSON.parse(`[${s}]`); } catch (_) {}
      }
    }

    UNS_INDEX = (raw || [])
      .map(x => x && (x.uns || x))
      .filter(u => u && u.namespace && u.dbms && u.table)
      .map(u => ({
        namespace: String(u.namespace || '').replace(/^\/+/, '').replace(/\/+$/,''),
        name: u.name || '',
        dbms: u.dbms,
        table: u.table
      }));

    // Metric nodes: keep namespaces that END with '/metric' (case-insensitive), after trimming.
    UNS_METRIC = UNS_INDEX.filter(r => {
      const ns = (r.namespace || '').replace(/\/+$/,'');
      const nsL = ns.toLowerCase();
      const isMetric = nsL.endsWith('/metric');
      return isMetric && !nsL.includes('/metric/input') && !nsL.includes('/workorder/');
    });
    outLen = UNS_INDEX.length;


    addLog('info', `UNS index loaded: ${UNS_INDEX.length} records (${UNS_METRIC.length} metric nodes)`);

    // Helpful debug counts by site/process (so blank drilldowns are obvious)
    const dbg = {};
    for (const s of SITES) {
      for (const p of Object.keys(UNS.sites[s].processes)) {
        const pref = `enterprise_b/${s.toLowerCase()}/${p.toLowerCase()}/`;
        const n = UNS_METRIC.filter(r => afterEnterprise(nsParts(r.namespace)).join('/').toLowerCase().startsWith(pref)).length;
        dbg[`${s}.${p}`] = n;
      }
    }
    addLog('info', `Metric nodes by scope: ${Object.entries(dbg).map(([k,v])=>`${k}:${v}`).join(' ¬∑ ')}`);
  } catch (e) {
    UNS_INDEX = [];
    UNS_METRIC = [];
    addLog('warn', `UNS index not loaded from /api/uns. Drilldown will be limited. ${e.message}`);
  } finally {
    const dur = performance.now() - t0;
    // This is a schema-ish fetch
    logCall({ method:'GET', path:'/api/uns', status: status||0, dur, rowCnt: outLen, type:'schema', detail:'/api/uns' });
  }
}

function nsParts(ns){ return (ns || '').replace(/^\/+/, '').split('/').filter(Boolean); }

function afterEnterprise(parts){
  const i = parts.findIndex(p => p.toLowerCase() === 'enterprise_b');
  return i >= 0 ? parts.slice(i) : parts;
}

// Normalize a namespace: lowercase, strip leading/trailing slashes
function nsNorm(ns) {
  return (ns || '').toLowerCase().replace(/^\/+/, '').replace(/\/+$/, '');
}
// Find the enterprise_b segment index in a parts array (case-insensitive)
function entBase(parts) {
  return parts.findIndex(p => p.toLowerCase() === 'enterprise_b');
}

function deriveAssets(site, process){
  // Returns [{name, directMetric, metricRow, leafNodes}]
  const scopePrefix = nsNorm(`enterprise_b/${site}/${process}/`);

  const metrics = UNS_METRIC.filter(r => {
    const n = nsNorm(r.namespace);
    return n.startsWith(scopePrefix) && n.endsWith('/metric') && !n.includes('/metric/input');
  });

  const groups = new Map();

  for (const r of metrics){
    const parts = nsParts(r.namespace);
    const base = entBase(parts);
    if (base < 0) continue;
    if (parts.length <= base + 3) continue; // need at least enterprise_b/site/process/asset
    if (parts[base+1].toLowerCase() !== site.toLowerCase()) continue;
    if (parts[base+2].toLowerCase() !== process.toLowerCase()) continue;
    const assetDisplay = parts[base+3];
    const key = assetDisplay.toLowerCase();
    if (!groups.has(key)) groups.set(key, { displayName: assetDisplay, rows: [] });
    groups.get(key).rows.push(r);
  }

  const out = [];
  for (const [, {displayName, rows}] of groups.entries()){
    const directNsTarget = nsNorm(`enterprise_b/${site}/${process}/${displayName}/metric`);
    const metricRow = rows.find(x => nsNorm(x.namespace) === directNsTarget) || null;
    if (metricRow){
      out.push({ name: displayName, directMetric: true, metricRow, leafNodes: [] });
    } else {
      out.push({ name: displayName, directMetric: false, metricRow: null, leafNodes: rows });
    }
  }

  out.sort((a,b)=>a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
  return out;
}

function deriveLeafMetricsUnder(site, process) {
  const prefix = nsNorm(`enterprise_b/${site}/${process}/`);
  const rollup = nsNorm(`enterprise_b/${site}/${process}/metric`);
  return UNS_METRIC.filter(r => {
    const n = nsNorm(r.namespace);
    return n.startsWith(prefix) && n !== rollup;
  });
}

function setView(next) {
  VIEW = { ...VIEW, ...next };
  renderView();
  // refresh cards visible in the new view immediately
  refreshCycle(true);
}

function crumbs() {
  const bc = [];
  bc.push({label:'Enterprise', on:()=>setView({level:'enterprise', site:null, process:null, asset:null, leafNs:null})});
  if (VIEW.site) bc.push({label:VIEW.site, on:()=>setView({level:'site', process:null, asset:null, leafNs:null})});
  if (VIEW.process) bc.push({label:PROC_LABEL[VIEW.process]||VIEW.process, on:()=>setView({level:'process', asset:null, leafNs:null})});
  if (VIEW.asset) bc.push({label:VIEW.asset, on:()=>setView({level:'asset', leafNs:null})});
  if (VIEW.leafNs) bc.push({label:'Leaf', on:()=>{}});
  return bc;
}

function renderBreadcrumbs() {
  const el = document.getElementById('breadcrumbs');
  if (!el) return;
  const items = crumbs();
  el.innerHTML = items.map((c,i)=>`
    <span class="tag clickable" data-crumb="${i}" style="padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);font-family:var(--mono);font-size:11px;">
      ${c.label}
    </span>
  `).join('') + `<span style="color:var(--dim);font-size:12px;">${VIEW.level.toUpperCase()}</span>`;
  // bind
  [...el.querySelectorAll('[data-crumb]')].forEach(n=>{
    const i = parseInt(n.getAttribute('data-crumb'),10);
    n.onclick = items[i].on;
  });
}

function showEnterpriseLayout(show) {
  const ent = document.getElementById('enterprise-section');
  const pm  = document.getElementById('proc-matrix-section');
  // Per spec: show only the NEXT level below the current level.
  // At enterprise level, that's Sites (no process matrix).
  if (ent) ent.style.display = show ? '' : 'none';
  if (pm)  pm.style.display  = 'none';
}

function showDrill(show) {
  document.getElementById('drill-section').style.display = show ? '' : 'none';
}

function renderView() {
  renderBreadcrumbs();
  if (VIEW.level === 'enterprise') {
    showEnterpriseLayout(true);
    showDrill(false);
    return;
  }
  showEnterpriseLayout(false);
  showDrill(true);

  const titleEl = document.getElementById('drill-title');
  const subEl = document.getElementById('drill-subtitle');
  const grid = document.getElementById('drill-grid');
  const hero = document.getElementById('drill-hero');
  const details = document.getElementById('drill-details');
  grid.innerHTML = '';
  hero.innerHTML = '';
  details.innerHTML = '';

  if (VIEW.level === 'site') {
    titleEl.textContent = `${VIEW.site} ‚Äî Site View`;
    subEl.textContent = `Click a process to drill down`;
    // Build process cards for this site
    const procs = Object.keys(UNS.sites[VIEW.site].processes);
    grid.innerHTML = procs.map(p=>{
      const id = `${VIEW.site}-${p}-dr`;
      return `
        <div class="pc clickable" data-process="${p}">
          <div class="pc-name">${PROC_LABEL[p] || p}</div>
          <div class="pc-oee sk c-na" id="po-${id}">‚Äî%</div>
          <div class="pc-bar-wrap"><div class="pc-bar" id="pb-${id}" style="width:0;background:var(--muted)"></div></div>
          <div class="pc-ape">
            <div class="pcm"><span class="pcm-v sk" id="pa-${id}">‚Äî</span><span class="pcm-l">Avail</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pp-${id}">‚Äî</span><span class="pcm-l">Perf</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pq-${id}">‚Äî</span><span class="pcm-l">Qual</span></div>
          </div>
          <div class="pc-delta" id="dl-${id}">Œî Site: ‚Äî ¬∑ Œî Ent: ‚Äî</div>
        </div>`; 
    }).join('');
    // bind process click ‚Äî use inline loop (bindClicks targets [data-site][data-process] in main matrix only)
    [...grid.querySelectorAll('[data-process]')].forEach(el => {
      el.onclick = () => setView({ level:'process', site: VIEW.site, process: el.getAttribute('data-process'), asset:null, leafNs:null });
    });
    return;
  }

  if (VIEW.level === 'process') {
    titleEl.textContent = `${VIEW.site} ‚Äî ${PROC_LABEL[VIEW.process]||VIEW.process}`;
    subEl.textContent = `Click an asset (auto-discovered from /api/uns)`;
    const subs = deriveAssets(VIEW.site, VIEW.process);
    if (!subs.length) {
      // Fallback: show leaf metric nodes directly under the process
      const leaves = deriveLeafMetricsUnder(VIEW.site, VIEW.process);
      if (!leaves.length) {
        details.innerHTML = `<div class="tag" style="padding:10px;background:rgba(255,255,255,.04);border-radius:12px;">No asset or leaf metric nodes found for this process in the UNS index.</div>`;
        return;
      }
      subEl.textContent = `No asset groups found ‚Äî showing leaf assets/components instead`;
      grid.innerHTML = leaves.map(r=>{
      const id = r.table; // unique enough for leaf cards
      const name = r.display || r.asset || r.name || r.table;
      return `
        <div class="pc clickable" data-leafns="${r.namespace.replace(/\/metric$/,'')}">
          <div class="pc-name">${name}</div>
          <div class="pc-oee sk c-na" id="po-${id}">‚Äî%</div>
          <div class="pc-bar-wrap"><div class="pc-bar" id="pb-${id}" style="width:0;background:var(--muted)"></div></div>
          <div class="pc-ape">
            <div class="pcm"><span class="pcm-v sk" id="pa-${id}">‚Äî</span><span class="pcm-l">Avail</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pp-${id}">‚Äî</span><span class="pcm-l">Perf</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pq-${id}">‚Äî</span><span class="pcm-l">Qual</span></div>
          </div>
          <div class="pc-delta" id="dl-${id}">Œî Sub: ‚Äî ¬∑ Œî Proc: ‚Äî ¬∑ Œî Site: ‚Äî ¬∑ Œî Ent: ‚Äî</div>
          <div style="margin-top:6px;color:var(--dim);font-size:10px;font-family:var(--mono);">${r.table}</div>
        </div>`; 
    }).join('');
      [...grid.querySelectorAll('[data-leafns]')].forEach(el=>{
        el.onclick = ()=> setView({ level:'leaf', site: VIEW.site, process: VIEW.process, leafNs: el.getAttribute('data-leafns') });
      });
      return;
    }
    // Render asset cards
    grid.innerHTML = subs.map(sp=>{
      const id = `${VIEW.site}-${VIEW.process}-${sp.name}-sp`;
      return `
        <div class="pc clickable" data-asset="${sp.name}">
          <div class="pc-name">${sp.name}</div>
          <div class="pc-oee sk c-na" id="po-${id}">‚Äî%</div>
          <div class="pc-bar-wrap"><div class="pc-bar" id="pb-${id}" style="width:0;background:var(--muted)"></div></div>
          <div class="pc-ape">
            <div class="pcm"><span class="pcm-v sk" id="pa-${id}">‚Äî</span><span class="pcm-l">Avail</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pp-${id}">‚Äî</span><span class="pcm-l">Perf</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pq-${id}">‚Äî</span><span class="pcm-l">Qual</span></div>
          </div>
          <div class="pc-delta" id="dl-${id}">Œî Proc: ‚Äî ¬∑ Œî Site: ‚Äî ¬∑ Œî Ent: ‚Äî</div>
          <div style="margin-top:6px;color:var(--dim);font-size:10px;font-family:var(--mono);">
            ${sp.directMetric ? 'direct metric' : `${sp.leafNodes.length} leaf metrics`}
          </div>
        </div>`; 
    }).join('');
    // bind asset click
    [...grid.querySelectorAll('[data-asset]')].forEach(el=>{
      el.onclick = ()=> setView({ level:'asset', site: VIEW.site, process: VIEW.process, asset: el.getAttribute('data-asset'), leafNs:null });
    });
    return;
  }

  if (VIEW.level === 'asset') {
    titleEl.textContent = `${VIEW.site} ‚Äî ${PROC_LABEL[VIEW.process]||VIEW.process} ‚Äî ${VIEW.asset}`;
    subEl.textContent = `Click a leaf asset/component to see all metrics for that card`;
    const subs = deriveAssets(VIEW.site, VIEW.process).find(x=>x.name===VIEW.asset);
    if (!subs) { details.innerHTML = `<div class="tag" style="padding:10px;background:rgba(255,255,255,.04);border-radius:12px;">Asset not found.</div>`; return; }
    const leaves = (subs.directMetric ? [subs.metricRow] : subs.leafNodes);

    grid.innerHTML = leaves.map(r=>{
      const id = r.table; // stable DOM id
      const leafLabel = r.namespace.split('/').slice(-2, -1)[0] || r.name || r.table;
      return `
        <div class="pc clickable" data-leafns="${r.namespace.replace(/\/metric$/i,'')}">
          <div class="pc-name">${leafLabel}</div>
          <div class="pc-oee sk c-na" id="po-${id}">‚Äî%</div>
          <div class="pc-bar-wrap"><div class="pc-bar" id="pb-${id}" style="width:0;background:var(--muted)"></div></div>
          <div class="pc-ape">
            <div class="pcm"><span class="pcm-v sk" id="pa-${id}">‚Äî</span><span class="pcm-l">Avail</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pp-${id}">‚Äî</span><span class="pcm-l">Perf</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pq-${id}">‚Äî</span><span class="pcm-l">Qual</span></div>
          </div>
          <div class="pc-delta" id="dl-${id}">Œî Sub: ‚Äî ¬∑ Œî Proc: ‚Äî ¬∑ Œî Site: ‚Äî ¬∑ Œî Ent: ‚Äî</div>
          <div style="margin-top:6px;color:var(--dim);font-size:10px;font-family:var(--mono);">${r.table}</div>
        </div>`;
    }).join('');

    [...grid.querySelectorAll('[data-leafns]')].forEach(el=>{
      el.onclick = ()=> setView({ level:'leaf', leafNs: el.getAttribute('data-leafns') });
    });
    return;
  }

  if (VIEW.level === 'leaf') {
    titleEl.textContent = `All metrics ‚Äî ${VIEW.leafNs}`;
    subEl.textContent = `Shows /metric plus sibling /metric/input and /processdata tables when present`;
    details.innerHTML = `<div class="tag" style="padding:10px;background:rgba(255,255,255,.04);border-radius:12px;">Leaf detail rendering: wire your metric + processdata queries here (static placeholder).</div>`;
    return;
  }
}

function bindClicks() {
  // Site card click
  document.querySelectorAll('.site-card[data-site]').forEach(el=>{
    el.onclick = () => setView({ level:'site', site: el.getAttribute('data-site'), process:null, asset:null, leafNs:null });
  });
  // Process card click (in main enterprise layout)
  document.querySelectorAll('.pc[data-site][data-process]').forEach(el=>{
    el.onclick = () => setView({ level:'process', site: el.getAttribute('data-site'), process: el.getAttribute('data-process'), asset:null, leafNs:null });
  });
}


const PROC_LABEL = {
  fillerproduction: 'Filler Production',
  liquidprocessing: 'Liquid Processing',
  packaging:        'Packaging',
  palletizing:      'Palletizing',
};

const SITES = ['Site1', 'Site2', 'Site3'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// State
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let proxyBase  = 'http://localhost:5001';
let refreshSec = 30;
let paused     = false;
let timerR     = null;   // refresh setInterval
let timerC     = null;   // countdown setInterval
let cdVal      = 0;

const ST = { proxy: 0, anylog: 0, rows: 0, errors: 0, lats: [] };
let logLines = [];

// Cached rollups to avoid extra queries outside scan cadence
let LAST = { entOee: null, siteOee: {} };

// ‚îÄ‚îÄ Query pacing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Small gap between sequential queries to avoid overwhelming
// memory-constrained AnyLog operator nodes.
const QUERY_GAP_MS = 250;            // ms pause between back-to-back queries
const sleep = ms => new Promise(r => setTimeout(r, ms));

// Workorder queries are expensive (lotnumber + item per pair).
// Only run them every WO_CADENCE refresh cycles to reduce load.
const WO_CADENCE = 4;                // run workorder fetch every 4th cycle
let   woCycleCount = 0;              // incremented each refreshCycle call

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Formatting helpers
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const pct  = v => (v == null || isNaN(+v)) ? '‚Äî' : (+v * 100).toFixed(1) + '%';
const pctS = v => (v == null || isNaN(+v)) ? '‚Äî%': (+v * 100).toFixed(1) + '%';

function oeeClass(v) {
  if (v == null || isNaN(+v)) return 'c-na';
  const p = +v * 100;
  if (p >= 85) return 'c-ex';
  if (p >= 70) return 'c-gd';
  if (p >= 50) return 'c-ok';
  return 'c-po';
}

function oeeBarCol(v) {
  if (v == null || isNaN(+v)) return 'var(--muted)';
  const p = +v * 100;
  if (p >= 85) return 'var(--green)';
  if (p >= 70) return '#69e080';
  if (p >= 50) return 'var(--amber)';
  return 'var(--red)';
}

function fmtPP(x){
  if (x == null || isNaN(+x)) return '‚Äî';
  const v = +x;
  return (v>=0?'+':'') + v.toFixed(2) + 'pp';
}
function setDelta(id, txtVal){
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = txtVal;
}


const nowTs = () => new Date().toLocaleTimeString('en-US', { hour12: false });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Logging (Enterprise C configuration)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function setText2(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}
// Normalise various AnyLog response shapes into a plain array of row objects
function rows(data) {
  if (!data) return [];
  if (Array.isArray(data)) return data;
  for (const key of ['Query','rows','data','result']) {
    if (data[key]?.rows) return data[key].rows;
    if (Array.isArray(data[key])) return data[key];
  }
  for (const v of Object.values(data)) {
    if (Array.isArray(v) && v.length && typeof v[0]==='object') return v;
  }
  return [];
}
function extractTableFromSQL(sql) {
  if (!sql) return '';
  const m = sql.match(/FROM\s+(\w+)/i);
  return m ? m[1] : '';
}
function buildAnyLogCmd(proxyPath, body) {
  if (!body) return proxyPath;
  // Enterprise B primarily uses /api/query
  if (proxyPath.includes('/api/query') && body.sql) {
    return `sql ${body.dbms||''} ${body.sql}`.trim();
  }
  return proxyPath;
}

// ‚îÄ‚îÄ LOG ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const callLog   = [];          // { id, ts, method, path, status, dur, rowCnt, type, detail, table, error, ok }
let   logStats  = { total:0, ok:0, err:0, rows:0 };
const rowsByTable = {};        // table ‚Üí cumulative rows returned
let   logOpen   = false;
let   logFilter = 'all';
let   nextLogId = 0;

function logCall(entry) {
  const id = nextLogId++;
  const status = entry.status || 0;
  const ok = !entry.error && status >= 200 && status < 300;
  const rec = { id, ts: new Date(), ok, ...entry, status };

  callLog.unshift(rec);        // newest first
  if (callLog.length > 500) callLog.pop();

  logStats.total++;
  if (ok) logStats.ok++; else logStats.err++;
  logStats.rows += (rec.rowCnt || 0);

  if (rec.table && rec.rowCnt > 0) {
    rowsByTable[rec.table] = (rowsByTable[rec.table] || 0) + rec.rowCnt;
  }

  updateLogStats();
  if (logOpen) prependLogRow(rec);
  updateRowSummary();
}

function updateLogStats() {
  setText2('log-total', `${logStats.total} call${logStats.total!==1?'s':''}`);
  setText2('log-ok',    `${logStats.ok} ok`);
  setText2('log-err',   `${logStats.err} err`);
  setText2('log-rows',  `${logStats.rows} rows`);
}

function updateRowSummary() {
  const el = document.getElementById('rowSumContent');
  if (!el) return;
  const entries = Object.entries(rowsByTable);
  if (!entries.length) { el.innerHTML = '<span style="color:#484f58;">‚Äî No data yet ‚Äî</span>'; return; }
  el.innerHTML = entries
    .sort((a,b) => b[1]-a[1])
    .map(([tbl,cnt]) =>
      `<span class="row-tbl">
          <span class="row-tbl-name">${escHtml(tbl)}</span>
          <span class="row-tbl-sep">‚Üí</span>
          <span class="row-tbl-cnt">${cnt.toLocaleString()}</span>
       </span>`
    ).join('<span class="row-tbl-sep" style="margin:0 4px;">|</span>');
}

function buildLogEntryHTML(rec) {
  const time   = rec.ts.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const mCls   = rec.method==='GET' ? 'm-get' : 'm-post';
  const sCls   = rec.ok ? 's-ok' : 's-err';
  const eStat  = rec.ok ? (rec.status || '200') : (rec.status || 'ERR');
  const dur    = (rec.dur||0) < 1000 ? `${Math.round(rec.dur||0)}ms` : `${((rec.dur||0)/1000).toFixed(1)}s`;
  const rowTxt = rec.rowCnt > 0 ? rec.rowCnt.toLocaleString() : rec.ok ? '0' : '‚Äî';
  const typeCls= `type-${rec.type||'other'}`;
  const errCls = rec.ok ? 'log-ok' : 'log-err';
  const detail = (rec.detail||'').length > 120 ? rec.detail.slice(0,120)+'‚Ä¶' : (rec.detail||'');
  const tbl    = rec.table || '‚Äî';

  return `<div class="log-entry ${errCls} ${typeCls}" data-method="${String(rec.method||'').toLowerCase()}"
               data-type="${rec.type||''}" data-ok="${rec.ok}" data-search="${(String(rec.path||'')+' '+String(rec.detail||'')+' '+tbl).toLowerCase()}"
               title="${escHtml(rec.detail||'')}">
      <span class="le-time">${time}</span>
      <span class="le-method ${mCls}">${escHtml(rec.method||'')}</span>
      <span class="le-status ${sCls}">${escHtml(eStat)}</span>
      <span class="le-dur">${dur}</span>
      <span class="le-path">${escHtml(detail)}</span>
      <span class="le-detail">${escHtml(tbl)}</span>
      <span class="le-rows">${rowTxt}</span>
  </div>`;
}

function prependLogRow(rec) {
  const body = document.getElementById('logBody');
  if (!body) return;
  const ph = body.querySelector('div[style*="padding:20px"]');
  if (ph) ph.remove();
  const tmp = document.createElement('div');
  tmp.innerHTML = buildLogEntryHTML(rec);
  body.insertBefore(tmp.firstElementChild, body.firstChild);
  applyLogFilters();
}

function rebuildLogBody() {
  const body = document.getElementById('logBody');
  if (!body) return;
  if (!callLog.length) {
    body.innerHTML = '<div style="padding:20px;text-align:center;color:#484f58;font-family:monospace;font-size:12px;">‚Äî Log cleared ‚Äî</div>';
    return;
  }
  body.innerHTML = callLog.map(buildLogEntryHTML).join('');
  applyLogFilters();
}

function toggleLog() {
  logOpen = !logOpen;
  const content = document.getElementById('logContent');
  const caret   = document.getElementById('logCaret');
  if (content) content.style.display = logOpen ? 'block' : 'none';
  if (caret)   caret.classList.toggle('open', logOpen);
  if (logOpen && callLog.length) rebuildLogBody();
}

function clearLog() {
  callLog.length = 0;
  logStats = { total:0, ok:0, err:0, rows:0 };
  Object.keys(rowsByTable).forEach(k => delete rowsByTable[k]);
  updateLogStats();
  updateRowSummary();
  rebuildLogBody();
}

function setLogFilter(f, btn) {
  logFilter = f;
  document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  applyLogFilters();
}
function filterLog() { applyLogFilters(); }

function applyLogFilters() {
  const search = (document.getElementById('logSearch')?.value||'').toLowerCase();
  document.querySelectorAll('#logBody .log-entry').forEach(el => {
    const method  = el.dataset.method  || '';
    const type    = el.dataset.type    || '';
    const ok      = el.dataset.ok;
    const srchTxt = el.dataset.search  || '';

    let visible = true;
    if (logFilter === 'get')    visible = method === 'get';
    else if (logFilter === 'post')   visible = method === 'post';
    else if (logFilter === 'error')  visible = ok === 'false';
    else if (logFilter === 'schema') visible = type === 'schema';
    else if (logFilter === 'query')  visible = type === 'latest' || type === 'count' || type === 'alarm';
    else if (logFilter === 'trend')  visible = type === 'trend';

    if (visible && search) visible = srchTxt.includes(search);
    el.classList.toggle('hidden', !visible);
  });
}

// Backwards-compatible lightweight logger for non-HTTP events
function addLog(type, msg) {
  const isErr = (type === 'err');
  logCall({
    method: 'LOG',
    path: type,
    status: isErr ? 500 : 200,
    dur: 0,
    rowCnt: 0,
    type: 'other',
    detail: msg || '',
    table: '',
    error: isErr ? new Error(msg || 'error') : null
  });
}




function updateStats() {
  document.getElementById('s-proxy').textContent  = ST.proxy;
  document.getElementById('s-anylog').textContent = ST.anylog;
  document.getElementById('s-rows').textContent   = ST.rows.toLocaleString();
  document.getElementById('s-err').textContent    = ST.errors;
  document.getElementById('s-lat').textContent    =
    ST.lats.length ? Math.round(ST.lats.reduce((a,b)=>a+b,0)/ST.lats.length) + 'ms' : '‚Äî';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Proxy HTTP call  ‚Üí  POST /api/query
// Per README_REST.md the proxy endpoint is /api/query
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function queryProxy(dbms, table, lookback) {
  const sql  = `SELECT avg(oee) as oee, avg(availability) as availability, avg(performance) as performance, avg(quality) as quality FROM ${table} WHERE insert_timestamp >= NOW() - ${lookback}`;
  const urlPath = '/api/query';
  const url  = `${proxyBase}${urlPath}`;
  const body = { dbms, sql };

  ST.proxy++;
  ST.anylog++;

  const t0 = performance.now();
  let status = 0;
  let data = null;
  let err = null;

  try {
    const resp = await fetch(url, {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(body),
      signal:  AbortSignal.timeout(20000),
    });

    status = resp.status;

    const ms = Math.round(performance.now() - t0);
    ST.lats.push(ms);
    if (ST.lats.length > 50) ST.lats.shift();

    if (!resp.ok) {
      const txt = await resp.text();
      ST.errors++;
      err = new Error(`HTTP ${resp.status}`);
      addLog('err', `HTTP ${resp.status} from proxy for ${table} ‚Äî ${txt.slice(0, 120)}`);
      return null;
    }

    data = await resp.json();

    if (data && data.error) {
      ST.errors++;
      err = new Error(data.error);
      addLog('err', `${table}: ${data.error}${data.details ? ' ‚Äî ' + data.details.slice(0,100) : ''}`);
      return null;
    }

    const rws = rows(data);
    ST.rows += rws.length;

    addLog('ok', `${table}: ${rws.length} row(s) | OEE=${pctS(rws[0]?.oee)} | ${Math.round(performance.now() - t0)}ms`);
    return rws[0] || null;

  } catch (e) {
    ST.errors++;
    err = e;
    addLog('err', `${table}: ${e.message}`);
    return null;
  } finally {
    const dur    = performance.now() - t0;
    const rowCnt = data ? rows(data).length : 0;
    const detail = buildAnyLogCmd(urlPath, body) || sql || urlPath;
    logCall({ method:'POST', path: urlPath, status: err ? (status||0) : (status||200),
              dur, rowCnt, type:'latest', detail, table, error: err });
    updateStats();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOM helpers
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function unsk(el) { if (el) el.classList.remove('sk'); }

function setOee(id, val) {
  const el = document.getElementById(id);
  if (!el) return;
  unsk(el);
  el.className = el.className.replace(/\bc-\w+/g, '') + ' ' + oeeClass(val);
  el.textContent = pct(val);
}

function setTxt(id, val) {
  const el = document.getElementById(id);
  if (!el) return;
  unsk(el);
  el.textContent = pct(val);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Static DOM build
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDOM() {
  // Site cards
  const sg = document.getElementById('site-grid');
  sg.innerHTML = SITES.map(s => `
    <div class="site-card clickable" data-site="${s}">
      <div class="sc-head">
        <span class="sc-name">${s}</span>
        <span class="sc-oee sk c-na" id="s-oee-${s}">‚Äî%</span>
      </div>
      <div class="sc-body">
        <div class="ape-row">
          <div class="ape-cell"><span class="ape-v sk" id="s-a-${s}">‚Äî</span><span class="ape-l">Avail</span></div>
          <div class="ape-cell"><span class="ape-v sk" id="s-p-${s}">‚Äî</span><span class="ape-l">Perf</span></div>
          <div class="ape-cell"><span class="ape-v sk" id="s-q-${s}">‚Äî</span><span class="ape-l">Qual</span></div>
        </div>
        <div class="pc-delta" id="dl-s-${s}">Œî Ent: ‚Äî</div>
      </div>
    </div>`).join('');

  // Process grids
  const pc = document.getElementById('proc-container');
  pc.innerHTML = SITES.map(s => {
    const cells = Object.keys(UNS.sites[s].processes).map(p => {
      const id = `${s}-${p}`;
      return `
        <div class="pc clickable" data-site="${s}" data-process="${p}">
          <div class="pc-name">${PROC_LABEL[p]}</div>
          <div class="pc-oee sk c-na" id="po-${id}">‚Äî%</div>
          <div class="pc-bar-wrap"><div class="pc-bar" id="pb-${id}" style="width:0;background:var(--muted)"></div></div>
          <div class="pc-ape">
            <div class="pcm"><span class="pcm-v sk" id="pa-<div class="pc-ape">
            <div class="pcm"><span class="pcm-v sk" id="pa-${id}">‚Äî</span><span class="pcm-l">Avail</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pp-${id}">‚Äî</span><span class="pcm-l">Perf</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pq-${id}">‚Äî</span><span class="pcm-l">Qual</span></div>
          </div>
          <div class="pc-delta" id="dl-${id}">Œî Site: ‚Äî ¬∑ Œî Ent: ‚Äî</div>
        </div>`;
    }).join('');
    return `
      <div class="proc-wrap">
        <div class="proc-site-hdr">
          <span class="psh-name">${s} ‚Äî Process Breakdown</span>
          <span style="font-family:var(--mono);font-size:9px;color:var(--dim)">${Object.keys(UNS.sites[s].processes).length} processes</span>
        </div>
        <div class="proc-grid">${cells}</div>
      </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Refresh model
//   - Enterprise + Site rollups: always queried every scan rate
//   - Everything else: queried only when visible (based on VIEW.level)
//   - On click: immediate refresh, then continues at scan rate while visible
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function queryLatestRow(dbms, table, limit=1) {
  const urlPath = '/api/query';
  const url = `${proxyBase}${urlPath}`;

  async function run(sql, labelType='latest') {
    const body = { dbms, sql };
    ST.proxy++; ST.anylog++;

    const t0 = performance.now();
    let status = 0, data = null, err = null;
    try {
      const resp = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body),
        signal: AbortSignal.timeout(20000),
      });
      status = resp.status;
      data = await resp.json().catch(()=>null);
      if (!resp.ok) throw new Error((data && data.error) ? data.error : `HTTP ${resp.status}`);

      const rws = rows(data);
      ST.rows += rws.length;
      return rws;
    } catch (e) {
      err = e;
      throw e;
    } finally {
      const dur    = performance.now() - t0;
      const rowCnt = data ? rows(data).length : 0;
      const detail = buildAnyLogCmd(urlPath, body) || sql || urlPath;
      logCall({ method:'POST', path:urlPath, status: err ? (status||0) : (status||200),
                dur, rowCnt, type: labelType, detail, table, error: err });
      updateStats();
    }
  }

  try {
    const sql1 = `SELECT * FROM ${table} ORDER BY insert_timestamp DESC LIMIT ${limit}`;
    return await run(sql1, 'latest');
  } catch (e) {
    // fallback without ORDER BY in case table lacks insert_timestamp
    addLog('warn', `Latest-row query fallback (no insert_timestamp?) on ${table}: ${e.message}`);
    try {
      const sql2 = `SELECT * FROM ${table} LIMIT ${limit}`;
      return await run(sql2, 'latest');
    } catch (e2) {
      ST.errors++;
      addLog('err', `Latest-row query failed ${dbms}.${table}: ${e2.message}`);
      return [];
    }
  }
}

function oeeFrom(d){ return (d && d.oee!=null) ? (+d.oee||0) : null; }

function impactEqualWeight(children, parentOee) {
  const vals = children.map(d=>oeeFrom(d)).filter(v=>v!=null && !isNaN(v));
  const n = vals.length;
  if (!n) return { parentCalc:null, items:[] };
  const parentCalc = (parentOee!=null && !isNaN(parentOee)) ? (+parentOee||0) : (vals.reduce((a,b)=>a+b,0)/n);
  const items = vals.map(v=>{
    const contribPP = (v/n)*100;
    const deltaPP   = ((v-parentCalc)/n)*100;
    return { oee:v, contribPP, deltaPP, parentCalc:parentCalc };
  });
  return { parentCalc, items };
}

function setWorkorderText(elId, lots) {
  const el = document.getElementById(elId);
  if (!el) return;
  if (!lots || !lots.length) { el.textContent = 'Workorder: ‚Äî'; return; }
  el.textContent = `Workorder: ${lots.join(' ¬∑ ')}`;
}

function pickWorkorderTablesForScope(scopePrefix) {
  // Find lotnumber + item tables within a scope; return unique pairs by common prefix
  const lot = UNS_INDEX.filter(r => r.namespace.startsWith(scopePrefix) && r.namespace.endsWith('/workorder/lotnumber'));
  const item = UNS_INDEX.filter(r => r.namespace.startsWith(scopePrefix) && r.namespace.endsWith('/workorder/lotnumber/item'));
  // map by the part before /workorder
  const byBase = new Map();
  for (const r of lot) {
    const base = r.namespace.split('/workorder/')[0];
    if (!byBase.has(base)) byBase.set(base, { base, lot:r, item:null });
    else byBase.get(base).lot = r;
  }
  for (const r of item) {
    const base = r.namespace.split('/workorder/')[0];
    if (!byBase.has(base)) byBase.set(base, { base, lot:null, item:r });
    else byBase.get(base).item = r;
  }
  return Array.from(byBase.values());
}

function extractWorkorderValue(row, preferKeys) {
  if (!row) return null;

  // 1) direct key match (case-insensitive)
  const lc = Object.fromEntries(Object.entries(row).map(([k,v])=>[String(k).toLowerCase(), v]));
  for (const k of preferKeys) {
    const v = lc[String(k).toLowerCase()];
    if (v != null && String(v).trim().length) return String(v).trim();
  }

  // 2) common "value" style columns
  for (const k of ['value','val','text','str','name']) {
    const v = lc[k];
    if (v != null && String(v).trim().length) return String(v).trim();
  }

  // 3) best-effort: pick first non-empty string-like value that is NOT a timestamp / numeric / uuid-ish
  const badRe = /(^\d{4}-\d{2}-\d{2}t)|(^\d{13}$)|(^\d+\.\d+$)|(^\d+$)|([0-9a-f]{16,})/i;
  for (const v of Object.values(row)) {
    if (v == null) continue;
    const s = String(v).trim();
    if (!s.length) continue;
    if (badRe.test(s)) continue;
    return s;
  }

  // 4) fallback: last resort, return first non-null
  const v = Object.values(row).find(v=>v!=null && String(v).trim().length);
  return v == null ? null : String(v).trim();
}

async function fetchWorkordersForScope(scopePrefix, maxPairs=10) {
  const pairs = pickWorkorderTablesForScope(scopePrefix).slice(0, maxPairs);
  const out = [];

  for (const p of pairs) {
    const lotRows  = p.lot  ? await queryLatestRow(p.lot.dbms,  p.lot.table,  1) : [];
    if (p.lot) await sleep(QUERY_GAP_MS);
    const itemRows = p.item ? await queryLatestRow(p.item.dbms, p.item.table, 1) : [];
    if (p.item) await sleep(QUERY_GAP_MS);

    const lotVal  = lotRows?.[0]  ? extractWorkorderValue(lotRows[0],  ['lotnumber','lot_number','lot','workorder','work_order','wo','id']) : null;
    const itemVal = itemRows?.[0] ? extractWorkorderValue(itemRows[0], ['item','sku','product','material','part','partnumber','part_number']) : null;

    // Prefer showing at least lot if present; item is optional.
    const label = [lotVal, itemVal].filter(Boolean).join(' / ');
    if (label) out.push(label);
  }

  // uniq keep order
  return [...new Set(out)].slice(0, 6);
}

function leafTablesForNamespace(nsBase) {
  // Include: metric, metric/input, processdata, workorder
  const rows = UNS_INDEX.filter(r => r.namespace.startsWith(nsBase + '/'));
  // prefer closest descendants
  const tbls = rows
    .filter(r => !r.namespace.endsWith('/node') && r.table && r.dbms)
    .filter(r => (
      r.namespace.includes('/metric') ||
      r.namespace.includes('/processdata') ||
      r.namespace.includes('/workorder')
    ))
    .map(r => ({ namespace:r.namespace, dbms:r.dbms, table:r.table }));
  // uniq by dbms+table
  const seen = new Set();
  const uniq = [];
  for (const t of tbls) {
    const k = `${t.dbms}.${t.table}`;
    if (seen.has(k)) continue;
    seen.add(k);
    uniq.push(t);
  }
  return uniq;
}

function renderLeafTables(nsBase) {
  const details = document.getElementById('drill-details');
  if (!details) return;
  const tbls = leafTablesForNamespace(nsBase);

  details.innerHTML = `
    <div class="panel" style="margin-top:12px">
      <div class="panel-hdr">
        <div class="panel-title">Leaf details</div>
        <div class="panel-sub">All metric / processdata / workorder tables under <span style="font-family:var(--mono)">${nsBase}</span></div>
      </div>
      <div class="panel-body" id="leaf-tables"></div>
    </div>`;

  const host = document.getElementById('leaf-tables');
  if (!host) return;

  if (!tbls.length) {
    host.innerHTML = `<div style="color:var(--dim);font-family:var(--mono);font-size:11px">No detail tables found under this namespace.</div>`;
    return;
  }

  host.innerHTML = tbls.map((t, i)=>`
    <div style="border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px;background:rgba(255,255,255,0.02)">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--dim)">${t.namespace}</div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--dim)">${t.dbms}.${t.table}</div>
        </div>
        <button class="btn" data-leafload="${i}">Load</button>
      </div>
      <pre id="leaf-pre-${i}" style="margin-top:8px;max-height:260px;overflow:auto;background:rgba(0,0,0,0.35);border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.06);font-size:11px;color:#d7e6ff">Click Load to query latest rows‚Ä¶</pre>
    </div>`).join('');

  host.querySelectorAll('button[data-leafload]').forEach(btn=>{
    btn.onclick = async () => {
      const i = parseInt(btn.getAttribute('data-leafload'), 10);
      const t = tbls[i];
      const pre = document.getElementById(`leaf-pre-${i}`);
      if (!pre) return;
      pre.textContent = 'Loading‚Ä¶';
      const rows = await queryLatestRow(t.dbms, t.table, 20);
      pre.textContent = JSON.stringify(rows, null, 2);
    };
  });
}

async function refreshEnterpriseAndSites(lb, woNow=true) {
  addLog('info', `‚îÄ‚îÄ Rollup refresh (enterprise+sites)  lookback=${lb} ‚îÄ‚îÄ`);

  let entData = await queryProxy(UNS.enterprise.metric.dbms, UNS.enterprise.metric.table, lb);

  const siteResults = {};
  for (const s of SITES) {
    await sleep(QUERY_GAP_MS);
    const d = await queryProxy(UNS.sites[s].metric.dbms, UNS.sites[s].metric.table, lb);
    siteResults[s] = d;
    if (d && d.oee!=null) LAST.siteOee[s] = (+d.oee||0);
    if (d) {
      setOee(`s-oee-${s}`, d.oee);
      setTxt(`s-a-${s}`,   d.availability);
      setTxt(`s-p-${s}`,   d.performance);
      setTxt(`s-q-${s}`,   d.quality);
    }
  }

  if (!entData) {
    const filled = Object.values(siteResults).filter(Boolean);
    if (filled.length) {
      const avg = k => filled.reduce((s, d) => s + (+d[k] || 0), 0) / filled.length;
      entData = { oee: avg('oee'), availability: avg('availability'), performance: avg('performance'), quality: avg('quality') };
      addLog('warn', `Enterprise table empty ‚Äî derived OEE from ${filled.length} sites`);
    }
  }
  if (entData) {
    LAST.entOee = (+entData.oee||0);

    setOee('e-oee',   entData.oee);
    setTxt('e-avail', entData.availability);
    setTxt('e-perf',  entData.performance);
    setTxt('e-qual',  entData.quality);
  }

  // Enterprise-level workorders (sample top) ‚Äî only on WO cadence cycles
  if (woNow) {
    const wo = await fetchWorkordersForScope('Enterprise_B', 3);
    setWorkorderText('e-workorder', wo);
  }

  // Enterprise impact from sites (equal-weight)
  const impactHost = document.getElementById('e-impact');
  if (impactHost) {
    const kids = SITES.map(s=>siteResults[s]).filter(Boolean);
    const res = impactEqualWeight(kids, entData?.oee);
    if (res.items.length === kids.length && res.parentCalc!=null) {
      const rows = SITES.map((s, idx)=>{
        const v = siteResults[s]?.oee;
        const item = res.items[idx];
        if (v==null) return '';
        return `<div class="mini-row"><span>${s}</span><span class="${oeeClass(v)}">${pct(v)}</span><span>${item.contribPP.toFixed(1)}pp</span><span>${(item.deltaPP>=0?'+':'')+item.deltaPP.toFixed(1)}pp</span></div>`;
      }).join('');
      impactHost.innerHTML = `
        <div class="mini-hdr">Impact to Enterprise OEE (equal-weight)</div>
        <div class="mini-grid"><div class="mini-row mini-head"><span>Child</span><span>OEE</span><span>Contrib</span><span>Œî vs parent</span></div>${rows}</div>`;
    }
  }

  // Site-card deltas: Œî vs Enterprise (equal-weight across sites)
  if (entData?.oee != null) {
    const entOee  = +entData.oee || 0;
    const nSites  = SITES.length || 1;
    for (const s of SITES) {
      const d = siteResults[s];
      if (!d || d.oee == null) continue;
      const diff     = (+d.oee||0) - entOee;
      const dEntPP   = diff / nSites * 100;
      setDelta(`dl-s-${s}`, `Œî Ent: ${fmtPP(dEntPP)}`);
    }
  }
}

async function refreshSiteView(lb, woNow=true) {
  const site = VIEW.site;
  if (!site) return;

  // Site rollup (parent)
  const siteRoll = await queryProxy(UNS.sites[site].metric.dbms, UNS.sites[site].metric.table, lb);
  const hero = document.getElementById('drill-hero');
  if (hero && siteRoll) {
    hero.innerHTML = `
      <div class="hero">
        <div class="hero-main">
          <div class="hero-title">${site} ‚Äî Site OEE</div>
          <div class="hero-oee ${oeeClass(siteRoll.oee)}">${pct(siteRoll.oee)}</div>
          <div class="hero-sub">Availability <b>${pct(siteRoll.availability)}</b> ¬∑ Performance <b>${pct(siteRoll.performance)}</b> ¬∑ Quality <b>${pct(siteRoll.quality)}</b></div>
          <div class="hero-sub" id="drill-workorder">Workorder: ‚Äî</div>
        </div>
      </div>`;
  }

  // Workorder for site scope ‚Äî only on WO cadence cycles
  if (woNow) {
    const wo = await fetchWorkordersForScope(`Enterprise_B/${site}`, 5);
    setWorkorderText('drill-workorder', wo);
  }

  // Process cards for the site (queried only when site view visible)
  const procs = Object.keys(UNS.sites[site].processes);
  const results = [];
  for (const p of procs) {
    await sleep(QUERY_GAP_MS);
    const { dbms, table } = UNS.sites[site].processes[p].metric;
    const d = await queryProxy(dbms, table, lb);
    results.push(d);
    const id = `${site}-${p}-dr`;
    if (d) {
      const el = document.getElementById(`po-${id}`);
      if (el) { unsk(el); el.className = el.className.replace(/\bc-\w+/g,'') + ' ' + oeeClass(d.oee); el.textContent = pct(d.oee); }
      const bar = document.getElementById(`pb-${id}`);
      if (bar) { bar.style.width = Math.min((+d.oee||0)*100,100).toFixed(1)+'%'; bar.style.background = oeeBarCol(d.oee); }
      setTxt(`pa-${id}`, d.availability);
      setTxt(`pp-${id}`, d.performance);
      setTxt(`pq-${id}`, d.quality);
    }
  }


  // Per-card deltas: how each process OEE impacts Site + Enterprise (equal-weight chain)
  const siteRef = (siteRoll && siteRoll.oee != null) ? (+siteRoll.oee||0) : (
    results.filter(Boolean).length ? (results.filter(Boolean).reduce((a,x)=>a+(+x.oee||0),0)/results.filter(Boolean).length) : null
  );
  const nProc = procs.length || 1;
  const nSites = SITES.length || 1;

  for (let i=0;i<procs.length;i++){
    const p = procs[i];
    const d = results[i];
    if (!d || siteRef==null || d.oee==null) continue;
    const diff = (+d.oee||0) - siteRef;
    const dSitePP = diff / nProc * 100;
    const dEntPP  = diff / (nProc * nSites) * 100;
    setDelta(`dl-${site}-${p}-dr`, `Œî Site: ${fmtPP(dSitePP)} ¬∑ Œî Ent: ${fmtPP(dEntPP)}`);
  }

  // Impact table vs site rollup
  const impact = impactEqualWeight(results.filter(Boolean), siteRoll?.oee);
  const host = document.getElementById('drill-impact');
  if (host) {
    if (!impact.items.length) { host.innerHTML = ''; return; }
    const rows = procs.map((p, idx)=>{
      const d = results[idx];
      if (!d) return '';
      const it = impact.items[impact.items.length===procs.length ? idx : Math.min(idx, impact.items.length-1)];
      return `<div class="mini-row"><span>${PROC_LABEL[p]}</span><span class="${oeeClass(d.oee)}">${pct(d.oee)}</span><span>${it.contribPP.toFixed(1)}pp</span><span>${(it.deltaPP>=0?'+':'')+it.deltaPP.toFixed(1)}pp</span></div>`;
    }).join('');
    host.innerHTML = `
      <div class="mini-hdr">Impact to ${site} OEE (equal-weight)</div>
      <div class="mini-grid"><div class="mini-row mini-head"><span>Process</span><span>OEE</span><span>Contrib</span><span>Œî vs parent</span></div>${rows}</div>`;
  }
}

async function refreshProcessView(lb, woNow=true) {
  const site = VIEW.site, proc = VIEW.process;
  if (!site || !proc) return;

  // Workorders for process scope ‚Äî only on WO cadence cycles
  if (woNow) {
    const wo = await fetchWorkordersForScope(`Enterprise_B/${site}/${proc}`, 5);
    setWorkorderText('drill-workorder', wo);
  }

  // Get process rollup for parent ref (queried only when visible)
  const parent = await queryProxy(UNS.sites[site].processes[proc].metric.dbms, UNS.sites[site].processes[proc].metric.table, lb);
  const hero = document.getElementById('drill-hero');
  if (hero && parent) {
    hero.innerHTML = `
      <div class="hero">
        <div class="hero-main">
          <div class="hero-title">${site} ‚Äî ${PROC_LABEL[proc]} OEE</div>
          <div class="hero-oee ${oeeClass(parent.oee)}">${pct(parent.oee)}</div>
          <div class="hero-sub">Availability <b>${pct(parent.availability)}</b> ¬∑ Performance <b>${pct(parent.performance)}</b> ¬∑ Quality <b>${pct(parent.quality)}</b></div>
          <div class="hero-sub" id="drill-workorder">Workorder: ‚Äî</div>
        </div>
      </div>`;
  }

  // Build asset list using deriveAssets (case-insensitive, UNS-aware, no undefined helpers)
  const subprocesses = deriveAssets(site, proc);

  // Render cards if grid is empty (renderView may already have populated it)
  const grid = document.getElementById('drill-grid');
  if (grid && !grid.children.length) {
    if (!subprocesses.length) {
      grid.innerHTML = '<div style="padding:14px;color:var(--dim);font-family:var(--mono);font-size:11px;">No asset nodes found in UNS index for this process.</div>';
    } else {
      grid.innerHTML = subprocesses.map(sp=>{
        const id = `${site}-${proc}-${sp.name}-sp`;
        return `
          <div class="pc clickable" data-asset="${sp.name}">
            <div class="pc-name">${sp.name}</div>
            <div class="pc-oee sk c-na" id="po-${id}">--</div>
            <div class="pc-bar-wrap"><div class="pc-bar" id="pb-${id}" style="width:0;background:var(--muted)"></div></div>
            <div class="pc-ape">
              <div class="pcm"><span class="pcm-v sk" id="pa-${id}">--</span><span class="pcm-l">Avail</span></div>
              <div class="pcm"><span class="pcm-v sk" id="pp-${id}">--</span><span class="pcm-l">Perf</span></div>
              <div class="pcm"><span class="pcm-v sk" id="pq-${id}">--</span><span class="pcm-l">Qual</span></div>
            </div>
          </div>`;
      }).join('');
      grid.querySelectorAll('.pc[data-asset]').forEach(el=>{
        el.onclick = () => setView({ level:'asset', site, process: proc, asset: el.getAttribute('data-asset'), leafNs:null });
      });
    }
  }

  // Query each asset metric table and paint values onto cards
  const results = [];
  for (const sp of subprocesses) {
    const id = `${site}-${proc}-${sp.name}-sp`;
    const metricRow = sp.metricRow || (sp.leafNodes && sp.leafNodes[0]) || null;
    if (!metricRow) { results.push(null); continue; }
    await sleep(QUERY_GAP_MS);
    const d = await queryProxy(metricRow.dbms, metricRow.table, lb);
    results.push(d);
    if (d) {
      const el = document.getElementById(`po-${id}`);
      if (el) { unsk(el); el.className = el.className.replace(/\bc-\w+/g,'') + ' ' + oeeClass(d.oee); el.textContent = pct(d.oee); }
      const bar = document.getElementById(`pb-${id}`);
      if (bar) { bar.style.width = Math.min((+d.oee||0)*100,100).toFixed(1)+'%'; bar.style.background = oeeBarCol(d.oee); }
      setTxt(`pa-${id}`, d.availability);
      setTxt(`pp-${id}`, d.performance);
      setTxt(`pq-${id}`, d.quality);
    }
  }

  // Impact to process
  const host = document.getElementById('drill-impact');
  if (host) {
    const impact = impactEqualWeight(results.filter(Boolean), parent?.oee);
    if (!impact.items.length) { host.innerHTML = ''; return; }
    const rows = subprocesses.map((sp, idx)=>{
      const d = results[idx];
      if (!d) return '';
      const it = impact.items[impact.items.length===subprocesses.length ? idx : Math.min(idx, impact.items.length-1)];
      return `<div class="mini-row"><span>${sp.name}</span><span class="${oeeClass(d.oee)}">${pct(d.oee)}</span><span>${it.contribPP.toFixed(1)}pp</span><span>${(it.deltaPP>=0?'+':'')+it.deltaPP.toFixed(1)}pp</span></div>`;
    }).join('');
    host.innerHTML = `
      <div class="mini-hdr">Impact to ${PROC_LABEL[proc]} OEE (equal-weight)</div>
      <div class="mini-grid"><div class="mini-row mini-head"><span>Asset</span><span>OEE</span><span>Contrib</span><span>Œî vs parent</span></div>${rows}</div>`;
  }

  // Per-card deltas: how each asset OEE impacts Process ‚Üí Site ‚Üí Enterprise (equal-weight chain)
  const procRef  = parent?.oee != null ? (+parent.oee||0) : null;
  const siteRef2 = LAST.siteOee[site] != null ? LAST.siteOee[site] : null;
  const entRef   = LAST.entOee != null ? LAST.entOee : null;
  const nAsset   = subprocesses.length || 1;
  const nProc2   = Object.keys(UNS.sites[site].processes).length || 1;
  const nSites   = SITES.length || 1;

  for (let i = 0; i < subprocesses.length; i++) {
    const sp = subprocesses[i];
    const d  = results[i];
    if (!d || d.oee == null) continue;
    const id = `${site}-${proc}-${sp.name}-sp`;
    const v  = +d.oee || 0;
    const dProcPP = procRef  != null ? (v - procRef)  / nAsset           * 100 : null;
    const dSitePP = siteRef2 != null ? (v - siteRef2) / (nAsset * nProc2)           * 100 : null;
    const dEntPP  = entRef   != null ? (v - entRef)   / (nAsset * nProc2 * nSites)  * 100 : null;
    const parts = [];
    if (dProcPP != null) parts.push(`Œî Proc: ${fmtPP(dProcPP)}`);
    if (dSitePP != null) parts.push(`Œî Site: ${fmtPP(dSitePP)}`);
    if (dEntPP  != null) parts.push(`Œî Ent: ${fmtPP(dEntPP)}`);
    if (parts.length) setDelta(`dl-${id}`, parts.join(' ¬∑ '));
  }
}

async function refreshAssetView(lb, woNow=true) {
  // Show leaves under the asset and allow clicking to leaf details
  const site = VIEW.site, proc = VIEW.process, sp = VIEW.asset;
  if (!site || !proc || !sp) return;

  const scope = `Enterprise_B/${site}/${proc}/${sp}`;

  const hero = document.getElementById('drill-hero');
  if (hero && !hero.children.length) {
    hero.innerHTML = `
      <div class="hero">
        <div class="hero-main">
          <div class="hero-title">${site} ‚Äî ${PROC_LABEL[proc]} ‚Äî ${sp}</div>
          <div class="hero-sub" id="drill-workorder">Workorder: ‚Äî</div>
          <div class="hero-sub">Click a leaf to see all metrics &amp; process data.</div>
        </div>
      </div>`;
  }

  // Workorders ‚Äî only on WO cadence cycles
  if (woNow) {
    const wo = await fetchWorkordersForScope(scope, 5);
    setWorkorderText('drill-workorder', wo);
  }

  const grid = document.getElementById('drill-grid');
  if (!grid) return;

  // Leaf metric nodes under this asset (case-insensitive prefix match)
  const scopeNorm = nsNorm(scope);
  const metricNodes = UNS_METRIC
    .filter(r => nsNorm(r.namespace).startsWith(scopeNorm + '/'))
    .filter(r => !r.namespace.toLowerCase().includes('/metric/input/'))
    .filter(r => !r.namespace.toLowerCase().includes('/workorder/'))
    .map(r => ({...r}));

  // Make leaves = distinct immediate metric namespaces (or deepest)
  const leaves = metricNodes
    .map(r => ({ ns:r.namespace.replace(/\/metric$/,'') , metric:r }))
    .reduce((acc, x)=>{
      if (!acc.some(a=>a.ns===x.ns)) acc.push(x);
      return acc;
    }, [])
    .sort((a,b)=>a.ns.localeCompare(b.ns))
    .slice(0, 24); // cap for UI

  // render leaf cards if empty
  if (!grid.children.length) {
    grid.innerHTML = leaves.map(l=>{
      const name = l.ns.split('/').slice(-1)[0];
      const id = `leaf-${btoa(l.ns).replace(/=+/g,'').slice(-12)}`;
      return `
        <div class="pc clickable" data-leafns="${l.ns}">
          <div class="pc-name">${name}</div>
          <div class="pc-oee sk c-na" id="po-${id}">‚Äî%</div>
          <div class="pc-bar-wrap"><div class="pc-bar" id="pb-${id}" style="width:0;background:var(--muted)"></div></div>
          <div class="pc-ape">
            <div class="pcm"><span class="pcm-v sk" id="pa-${id}">‚Äî</span><span class="pcm-l">Avail</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pp-${id}">‚Äî</span><span class="pcm-l">Perf</span></div>
            <div class="pcm"><span class="pcm-v sk" id="pq-${id}">‚Äî</span><span class="pcm-l">Qual</span></div>
          </div>
          <div style="display:none" id="ns-${id}">${l.ns}</div>
        </div>`;
    }).join('');
    grid.querySelectorAll('.pc[data-leafns]').forEach(el=>{
      el.onclick = () => setView({ level:'leaf', site, process: proc, asset: sp, leafNs: el.getAttribute('data-leafns') });
    });
  }

  // paint values ‚Äî paced with inter-query gaps
  const leafResults = [];   // {id, v} for delta calc after loop
  for (const el of grid.querySelectorAll('.pc[data-leafns]')) {
    const ns = el.getAttribute('data-leafns');
    const idNode = el.querySelector('div[id^="ns-"]')?.id;
    const id = idNode ? idNode.replace('ns-','') : null;
    const metric = UNS_METRIC.find(r => nsNorm(r.namespace) === nsNorm(ns + '/metric'));
    if (!metric || !id) continue;
    await sleep(QUERY_GAP_MS);
    const d = await queryProxy(metric.dbms, metric.table, lb);
    leafResults.push({ id, oee: d?.oee ?? null });
    if (d) {
      const oe = document.getElementById(`po-${id}`);
      if (oe) { unsk(oe); oe.className = oe.className.replace(/\bc-\w+/g,'') + ' ' + oeeClass(d.oee); oe.textContent = pct(d.oee); }
      const bar = document.getElementById(`pb-${id}`);
      if (bar) { bar.style.width = Math.min((+d.oee||0)*100,100).toFixed(1)+'%'; bar.style.background = oeeBarCol(d.oee); }
      setTxt(`pa-${id}`, d.availability);
      setTxt(`pp-${id}`, d.performance);
      setTxt(`pq-${id}`, d.quality);
    }
  }

  // Per-card deltas: leaf ‚Üí Asset (avg of leaves) ‚Üí Process ‚Üí Site ‚Üí Enterprise
  const validLeaves = leafResults.filter(x => x.oee != null);
  if (validLeaves.length) {
    const assetRef = validLeaves.reduce((s, x) => s + (+x.oee||0), 0) / validLeaves.length;
    const procNode  = UNS.sites[site]?.processes[proc];
    const procRef   = procNode ? null : null;   // process OEE not queried here; use LAST if available
    const siteRef   = LAST.siteOee[site]  != null ? LAST.siteOee[site]  : null;
    const entRef    = LAST.entOee          != null ? LAST.entOee          : null;
    const nLeaves   = validLeaves.length || 1;
    const nProcs    = Object.keys(UNS.sites[site].processes).length || 1;
    const nSites    = SITES.length || 1;

    for (const { id, oee } of leafResults) {
      if (oee == null) continue;
      const v = +oee || 0;
      const dSubPP  = (v - assetRef) / nLeaves * 100;
      const dSitePP = siteRef != null ? (v - siteRef) / (nLeaves * nProcs)          * 100 : null;
      const dEntPP  = entRef  != null ? (v - entRef)  / (nLeaves * nProcs * nSites) * 100 : null;
      const parts   = [`Œî Sub: ${fmtPP(dSubPP)}`];
      if (dSitePP != null) parts.push(`Œî Site: ${fmtPP(dSitePP)}`);
      if (dEntPP  != null) parts.push(`Œî Ent: ${fmtPP(dEntPP)}`);
      setDelta(`dl-${id}`, parts.join(' ¬∑ '));
    }
  }
}

async function refreshLeafView(lb, woNow=true) {
  const ns = VIEW.leafNs;
  if (!ns) return;

  // show workorder for this leaf scope ‚Äî only on WO cadence cycles
  if (woNow) {
    const wo = await fetchWorkordersForScope(ns, 3);
    // show leaf tables list + lazy load buttons
    renderLeafTables(ns);
    // Render into hero after the metric query below sets drill-workorder
    // (stored for use after hero is built)
    refreshLeafView._lastWo = wo;
  } else {
    renderLeafTables(ns);
  }

  // also show leaf's own OEE in hero
  const metric = UNS_METRIC.find(r => nsNorm(r.namespace) === nsNorm(ns + '/metric'));
  if (metric) {
    const d = await queryProxy(metric.dbms, metric.table, lb);
    const hero = document.getElementById('drill-hero');
    if (hero && d) {
      hero.innerHTML = `
        <div class="hero">
          <div class="hero-main">
            <div class="hero-title">${ns.split('/').slice(-1)[0]} ‚Äî Leaf OEE</div>
            <div class="hero-oee ${oeeClass(d.oee)}">${pct(d.oee)}</div>
            <div class="hero-sub">Availability <b>${pct(d.availability)}</b> ¬∑ Performance <b>${pct(d.performance)}</b> ¬∑ Quality <b>${pct(d.quality)}</b></div>
            <div class="hero-sub" id="drill-workorder">Workorder: ‚Äî</div>
          </div>
        </div>`;
      // Apply last fetched workorder label if available
      if (refreshLeafView._lastWo) setWorkorderText('drill-workorder', refreshLeafView._lastWo);
    }
  }
}

async function refreshCycle(immediate=false) {
  if (paused) return;
  const lb = document.getElementById('lookback').value;

  // Track workorder cadence ‚Äî skip expensive WO queries most cycles
  woCycleCount++;
  const woNow = immediate || (woCycleCount % WO_CADENCE === 0);

  // Always refresh enterprise + sites at scan rate
  await refreshEnterpriseAndSites(lb, woNow);
  await sleep(QUERY_GAP_MS);

  // Refresh only what's visible by view
  if (VIEW.level === 'site')      { await refreshSiteView(lb, woNow);    await sleep(QUERY_GAP_MS); }
  if (VIEW.level === 'process')   { await refreshProcessView(lb, woNow); await sleep(QUERY_GAP_MS); }
  if (VIEW.level === 'asset')     { await refreshAssetView(lb, woNow);   await sleep(QUERY_GAP_MS); }
  if (VIEW.level === 'leaf')      { await refreshLeafView(lb, woNow);    await sleep(QUERY_GAP_MS); }

  if (immediate) addLog('info', 'Immediate refresh complete (view change)');
}

function restart() {
  clearInterval(timerR);
  clearInterval(timerC);
  refreshSec = Math.max(5, parseInt(document.getElementById('interval').value) || 30);
  refreshCycle(true);
  startCountdown();
  timerR = setInterval(() => { refreshCycle(false); startCountdown(); }, refreshSec * 1000);
}

function startCountdown() {
  clearInterval(timerC);
  cdVal = refreshSec;
  const cd = document.getElementById('cd');
  if (cd) cd.textContent = `Next: ${cdVal}s`;
  timerC = setInterval(() => {
    cdVal--;
    const cd2 = document.getElementById('cd');
    if (!cd2) return;
    if (cdVal <= 0) {
      clearInterval(timerC);
      cd2.textContent = 'Fetching‚Ä¶';
    } else {
      cd2.textContent = `Next: ${cdVal}s`;
    }
  }, 1000);
}

function togglePause() {
  paused = !paused;
  const btn = document.getElementById('pause-btn');
  if (paused) {
    if (btn) { btn.textContent = '‚ñ∂ Resume'; btn.classList.add('paused'); }
    clearInterval(timerR);
    clearInterval(timerC);
    const cd = document.getElementById('cd');
    if (cd) cd.textContent = 'PAUSED';
    addLog('warn', 'Dashboard PAUSED');
  } else {
    if (btn) { btn.textContent = '‚è∏ Pause'; btn.classList.remove('paused'); }
    addLog('warn', 'Dashboard RESUMED');
    restart();
  }
}


async function applyConfig() {
  const urlEl = document.getElementById('proxy-url');
  const intEl = document.getElementById('interval');

  const nextProxy = (urlEl && urlEl.value ? urlEl.value.trim() : proxyBase).replace(/\/+$/,'');
  const nextInt   = Math.max(5, parseInt(intEl && intEl.value, 10) || refreshSec);

  const proxyChanged = nextProxy !== proxyBase;

  proxyBase = nextProxy;
  refreshSec = nextInt;

  addLog('info', `Config applied ‚Äî proxyBase=${proxyBase}, interval=${refreshSec}s`);

  if (proxyChanged) {
    addLog('warn', 'Proxy changed ‚Äî reloading UNS from /api/uns');
    await loadUnsIndex();
    // Re-render the current view (asset discovery depends on UNS index)
    renderView();
    // Refresh visible cards immediately with the new proxy
    refreshCycle(true);
  }

  restart();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Init
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initDashboard() {
  await loadUnsIndex();
  buildDOM();
  bindClicks();
  addLog('info', `Dashboard init ‚Äî AnyLog UNS loaded (${SITES.length} sites, 4 processes/site)`);
  renderView();
  restart();
}
initDashboard();
addLog('info', 'Proxy endpoint: POST /api/query  {dbms, sql}');
addLog('info', 'AnyLog command: sql <dbms> <sql>  +  destination: network');
</script>
</body>
</html>
