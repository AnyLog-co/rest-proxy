<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enterprise C SUB-250 â€” SPC Dashboard</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;600;700&family=Barlow+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080e1a;--surf:#0d1626;--panel:#111e30;--bdr:#1c3050;
  --cyan:#00d4ff;--green:#00ff9d;--warn:#ffbe00;--red:#ff3d5a;--blue:#6c9fff;--orange:#ff8c00;
  --text:#c8ddf0;--muted:#4a6580;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;overflow:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.06) 2px,rgba(0,0,0,.06) 4px);}

/* TOP BAR */
.top{flex-shrink:0;background:var(--surf);border-bottom:2px solid var(--bdr);
     padding:8px 16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.logo{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:18px;
      letter-spacing:2px;color:var(--cyan);text-transform:uppercase;white-space:nowrap;margin-right:6px;}
.logo em{color:var(--text);font-style:normal;font-weight:300;}
.grp{display:flex;align-items:center;gap:5px;}
.lbl{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--muted);text-transform:uppercase;white-space:nowrap;}
input.f,select.f{background:var(--bg);border:1px solid var(--bdr);color:var(--cyan);
  font-family:'Share Tech Mono',monospace;font-size:12px;padding:5px 8px;border-radius:3px;outline:none;transition:border-color .15s;}
input.f:focus,select.f:focus{border-color:var(--cyan);}
.w80{width:82px;}.w150{width:155px;}.w100{width:100px;}
.btn{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:1px;
     text-transform:uppercase;padding:6px 14px;border:none;border-radius:3px;cursor:pointer;transition:filter .15s;white-space:nowrap;}
.btn:hover:not(:disabled){filter:brightness(1.15);}
#btnGo{background:var(--cyan);color:var(--bg);}
#btnGo.stop{background:var(--red);color:#fff;}
#btnPause{background:var(--warn);color:var(--bg);}
#btnPause.on{background:var(--green);color:var(--bg);}
#btnPause:disabled{background:var(--bdr);color:var(--muted);cursor:not-allowed;}
.pill{display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;
      font-family:'Share Tech Mono',monospace;font-size:11px;border:1px solid var(--bdr);}
.dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0;}
.dot.ok{background:var(--green);box-shadow:0 0 5px var(--green);animation:pulse 2s infinite;}
.dot.err{background:var(--red);box-shadow:0 0 5px var(--red);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

/* STATUS BAR */
.sbar{flex-shrink:0;background:var(--panel);border-bottom:1px solid var(--bdr);
      padding:4px 16px;display:flex;gap:22px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--muted);flex-wrap:wrap;}
.sbar span{color:var(--text);}

/* MAIN LAYOUT */
.main{flex:1;display:grid;grid-template-columns:1fr 380px;min-height:0;}
.left{overflow-y:auto;padding:14px;}
.right{border-left:2px solid var(--bdr);display:flex;flex-direction:column;overflow:hidden;}

/* â”€â”€ PROCESS BLOCK â”€â”€ */
.pblk{margin-bottom:24px;}
.phdr{background:var(--panel);border:1px solid var(--bdr);border-bottom:2px solid var(--cyan);
      border-radius:6px 6px 0 0;padding:8px 14px;display:flex;justify-content:space-between;align-items:center;gap:12px;}
.pname{font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:15px;
       letter-spacing:2px;text-transform:uppercase;color:var(--cyan);}
.phdr-right{display:flex;align-items:center;gap:8px;}

/* Bottleneck badge on process header */
.bnbadge{font-family:'Share Tech Mono',monospace;font-size:10px;padding:3px 10px;border-radius:3px;white-space:nowrap;}
.bnbadge.none{border:1px solid var(--green);color:var(--green);background:rgba(0,255,157,.06);}
.bnbadge.low {border:1px solid var(--warn); color:var(--warn); background:rgba(255,190,0,.08);}
.bnbadge.high{border:1px solid var(--red);  color:var(--red);  background:rgba(255,61,90,.1);animation:pulse 1.5s infinite;}

/* Charts grid under each process */
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(330px,1fr));
       gap:1px;background:var(--bdr);border:1px solid var(--bdr);border-top:none;
       border-radius:0 0 6px 6px;overflow:hidden;}
.ccell{background:var(--surf);padding:10px;}

/* Chart header row */
.chdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;}
.cinfo{}
.cname{font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:13px;letter-spacing:.5px;color:var(--text);}
.ctbl{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--muted);margin-top:1px;}
.cstats{display:flex;gap:10px;}
.stat{text-align:right;}
.sv{font-family:'Share Tech Mono',monospace;font-size:11px;line-height:1.3;}
.sv.u{color:var(--red);}.sv.m{color:var(--green);}.sv.l{color:var(--red);}.sv.n{color:var(--muted);}
.sk{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}

/* Bottleneck row inside a process â€” the identified bottleneck metric */
.bn-metric-row{background:rgba(255,61,90,.06);border:1px solid rgba(255,61,90,.3);
               border-radius:4px;padding:6px 10px;margin:0 0 1px;display:flex;align-items:center;gap:8px;font-size:11px;}
.bn-metric-row.warn{background:rgba(255,190,0,.06);border-color:rgba(255,190,0,.3);}
.bn-label{font-family:'Share Tech Mono',monospace;font-size:9px;padding:2px 6px;border-radius:2px;white-space:nowrap;}
.bn-label.high{background:rgba(255,61,90,.2);border:1px solid var(--red);color:var(--red);}
.bn-label.warn{background:rgba(255,190,0,.15);border:1px solid var(--warn);color:var(--warn);}
.bn-desc{color:var(--text);flex:1;}
.bn-val{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--muted);}

/* â”€â”€ RIGHT PANEL â”€â”€ */
.rsec{flex-shrink:0;}
.rsec.grow{flex:1;min-height:0;display:flex;flex-direction:column;}
.rhdr{padding:8px 14px;border-bottom:1px solid var(--bdr);display:flex;justify-content:space-between;align-items:center;
      font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);background:var(--panel);}
.rbody{overflow-y:auto;}
.rbody.grow{flex:1;min-height:0;}

/* â”€â”€ ALERT PANEL â”€â”€ */
.proc-alerts{border-bottom:1px solid rgba(255,255,255,.06);}
.proc-alert-hdr{padding:5px 12px;background:rgba(0,0,0,.25);
                font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:11px;
                letter-spacing:1.5px;text-transform:uppercase;color:var(--cyan);
                display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;}
.proc-alert-hdr:hover{background:rgba(0,212,255,.05);}
.proc-alert-body{}
.arow{padding:6px 12px;border-bottom:1px solid rgba(255,255,255,.04);display:grid;grid-template-columns:62px 1fr;gap:7px;align-items:start;}
.arow:hover{background:rgba(255,255,255,.02);}
.sev{font-family:'Share Tech Mono',monospace;font-size:9px;padding:2px 4px;border-radius:2px;text-align:center;font-weight:700;letter-spacing:.5px;}
.sev.critical{background:rgba(255,61,90,.2);border:1px solid var(--red);color:var(--red);}
.sev.warning {background:rgba(255,190,0,.15);border:1px solid var(--warn);color:var(--warn);}
.sev.minor   {background:rgba(108,159,255,.1);border:1px solid var(--blue);color:var(--blue);}
.atag{font-size:10px;color:var(--cyan);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.amsg{font-size:10px;color:var(--text);margin-top:1px;}
.arule{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--muted);margin-top:1px;}
.no-alerts{padding:8px 12px;font-size:10px;color:var(--muted);font-family:'Share Tech Mono',monospace;}

/* â”€â”€ LOG â”€â”€ */
.lrow{font-family:'Share Tech Mono',monospace;font-size:10px;padding:3px 10px;
      border-bottom:1px solid rgba(255,255,255,.025);
      display:grid;grid-template-columns:60px 36px 1fr 52px 46px;gap:4px;align-items:center;}
.lrow:hover{background:rgba(255,255,255,.025);}
.lt{color:var(--muted);}.lk{font-weight:700;}
.lk.REST{color:var(--cyan);}.lk.SQL{color:var(--green);}.lk.ERR{color:var(--red);}.lk.INFO{color:var(--warn);}
.lm{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text);}
.lr{text-align:right;}.lr.ok{color:var(--green);}.lr.zero{color:var(--warn);}.lr.err{color:var(--red);}
.ld{color:var(--muted);text-align:right;}
.empty{padding:20px;text-align:center;color:var(--muted);font-size:11px;}
.clr{font-size:9px;background:none;border:1px solid var(--bdr);color:var(--muted);
     padding:2px 7px;border-radius:3px;cursor:pointer;font-family:'Share Tech Mono',monospace;}
.clr:hover{border-color:var(--muted);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="top">
  <div class="logo">Enterprise C <em>/ SUB-250 SPC</em></div>
  <div class="grp"><span class="lbl">Proxy URL</span>
    <input class="f w150" id="cfgProxy" value="http://localhost:8080"></div>
  <div class="grp"><span class="lbl">DB</span>
    <input class="f w150" id="cfgDb" value="manufacturing_historian"></div>
  <div class="grp"><span class="lbl">Lookback</span>
    <select class="f w100" id="cfgLook">
      <option value="5 minutes">5 min</option>
      <option value="15 minutes" selected>15 min</option>
      <option value="30 minutes">30 min</option>
      <option value="1 hour">1 hr</option>
      <option value="4 hours">4 hr</option>
      <option value="24 hours">24 hr</option>
    </select></div>
  <div class="grp"><span class="lbl">Poll</span>
    <select class="f w100" id="cfgPoll">
      <option value="5000">5 s</option>
      <option value="10000" selected>10 s</option>
      <option value="30000">30 s</option>
      <option value="60000">1 min</option>
    </select></div>
  <button class="btn" id="btnGo">âš¡ CONNECT</button>
  <button class="btn" id="btnPause" disabled>â¸ PAUSE</button>
  <div class="pill"><div class="dot" id="dot"></div><span id="connLbl">Disconnected</span></div>
</div>

<!-- STATUS BAR -->
<div class="sbar">
  <div>PROXY <span id="stProxy">â€”</span></div>
  <div>DB <span id="stDb">â€”</span></div>
  <div>QUERIES <span id="stQ">0</span></div>
  <div>ROWS <span id="stR">0</span></div>
  <div>ERRORS <span id="stE">0</span></div>
  <div>LAST POLL <span id="stLast">â€”</span></div>
  <div>NEXT POLL <span id="stNext">â€”</span></div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- LEFT: Trend charts by process -->
  <div class="left" id="chartsPane">
    <div class="empty" style="margin-top:80px;font-size:14px;line-height:2.2;">
      Start the proxy:<br>
      <code style="color:var(--green);font-size:12px;">./start_rest_proxy.sh</code><br>
      then click âš¡ CONNECT
    </div>
  </div>

  <!-- RIGHT: Alerts by process + Log -->
  <div class="right">
    <div class="rsec" style="flex-shrink:0;">
      <div class="rhdr">ğŸš¨ Special Cause Alerts â€” by Process
        <span id="aTotalBadge" style="font-size:10px;"></span>
      </div>
    </div>
    <div class="rsec" style="flex:0 0 55%;overflow:hidden;display:flex;flex-direction:column;">
      <div class="rbody" id="alertsPane" style="flex:1;overflow-y:auto;">
        <div class="empty">No alerts yet</div>
      </div>
    </div>

    <div class="rsec grow">
      <div class="rhdr">ğŸ“‹ API / Query Log
        <button class="clr" onclick="clearLog()">CLEAR</button>
      </div>
      <div class="rbody grow" id="logPane">
        <div class="empty">Log appears after connection</div>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROCESS & TABLE DEFINITIONS  â€”  real manufacturing_historian tables
// Schema: timestamp (timestamptz), value (float)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROCESSES = [
  {
    key: 'temperature',
    name: 'Temperature Control',
    metrics: [
      { table:'sub_tic_250_001_pv_celsius', label:'Reactor Temp TIC-001 PV', unit:'Â°C', flowRole:'pv' },
      { table:'sub_tic_250_001_sp_celsius', label:'Reactor Temp TIC-001 SP', unit:'Â°C', flowRole:'sp' },
      { table:'sub_tic_250_002_pv_celsius', label:'Jacket Temp TIC-002 PV',  unit:'Â°C', flowRole:'pv' },
      { table:'sub_tic_250_002_sp_celsius', label:'Jacket Temp TIC-002 SP',  unit:'Â°C', flowRole:'sp' },
      { table:'sub_ti_250_001_pv_celsius',  label:'Temp Probe TI-001',       unit:'Â°C', flowRole:'sensor' },
      { table:'sub_ti_250_002_pv_celsius',  label:'Temp Probe TI-002',       unit:'Â°C', flowRole:'sensor' }
    ]
  },
  {
    key: 'ph_do',
    name: 'pH & Dissolved Oxygen',
    metrics: [
      { table:'sub_aic_250_003_pv_ph',      label:'pH AIC-003 PV',    unit:'pH', flowRole:'pv' },
      { table:'sub_aic_250_003_sp_ph',      label:'pH AIC-003 SP',    unit:'pH', flowRole:'sp' },
      { table:'sub_aic_250_001_pv_percent', label:'DO% AIC-001 PV',   unit:'%',  flowRole:'pv' },
      { table:'sub_aic_250_001_sp_percent', label:'DO% AIC-001 SP',   unit:'%',  flowRole:'sp' }
    ]
  },
  {
    key: 'agitation',
    name: 'Agitation & Gas Flow',
    metrics: [
      { table:'sub_sic_250_008_pv_rpm',  label:'Agitator SIC-008 PV',  unit:'RPM',  flowRole:'pv' },
      { table:'sub_sic_250_008_sp_rpm',  label:'Agitator SIC-008 SP',  unit:'RPM',  flowRole:'sp' },
      { table:'sub_fic_250_001_pv_slpm', label:'Gas Flow FIC-001 PV',  unit:'SLPM', flowRole:'pv' },
      { table:'sub_fic_250_001_sp_slpm', label:'Gas Flow FIC-001 SP',  unit:'SLPM', flowRole:'sp' },
      { table:'sub_fic_250_002_pv_slpm', label:'Gas Flow FIC-002 PV',  unit:'SLPM', flowRole:'pv' },
      { table:'sub_fic_250_003_pv_slpm', label:'Gas Flow FIC-003 PV',  unit:'SLPM', flowRole:'pv' }
    ]
  },
  {
    key: 'pressure',
    name: 'Pressure & Valves',
    metrics: [
      { table:'sub_pic_250_001_pv_psi',     label:'Headspace Pressure PV',   unit:'PSI', flowRole:'pv' },
      { table:'sub_pic_250_001_sp_psi',     label:'Headspace Pressure SP',   unit:'PSI', flowRole:'sp' },
      { table:'sub_fcv_250_001_pv_percent', label:'Flow Valve FCV-001',      unit:'%',   flowRole:'actuator' },
      { table:'sub_fcv_250_002_pv_percent', label:'Flow Valve FCV-002',      unit:'%',   flowRole:'actuator' },
      { table:'sub_fcv_250_003_pv_percent', label:'Flow Valve FCV-003',      unit:'%',   flowRole:'actuator' }
    ]
  },
  {
    key: 'feed_harvest',
    name: 'Feed & Harvest Pumps',
    metrics: [
      { table:'sub_sic_250_003_pv_l_per_min',  label:'Feed Pump SIC-003 PV',    unit:'L/min',  flowRole:'pv' },
      { table:'sub_sic_250_003_sp_l_per_min',  label:'Feed Pump SIC-003 SP',    unit:'L/min',  flowRole:'sp' },
      { table:'sub_sic_250_004_pv_l_per_min',  label:'Harvest Pump SIC-004 PV', unit:'L/min',  flowRole:'pv' },
      { table:'sub_sic_250_005_pv_ml_per_min', label:'Base Pump SIC-005 PV',    unit:'mL/min', flowRole:'pv' },
      { table:'sub_sic_250_006_pv_ml_per_min', label:'Acid Pump SIC-006 PV',    unit:'mL/min', flowRole:'pv' },
      { table:'sub_wi_250_001_pv_kg',          label:'Vessel Weight WI-001',    unit:'kg',     flowRole:'sensor' }
    ]
  },
  {
    key: 'tff',
    name: 'TFF Process',
    metrics: [
      { table:'tff_ti8r_celsius',  label:'TFF Temperature',        unit:'Â°C',    flowRole:'sensor' },
      { table:'tff_pi7f_psig',     label:'TFF Inlet Pressure',     unit:'PSIG',  flowRole:'pv' },
      { table:'tff_dpi7m_psig',    label:'TFF Trans-Membrane Î”P',  unit:'PSIG',  flowRole:'pv' },
      { table:'tff_tmp7m_psig',    label:'TFF TMP',                unit:'PSIG',  flowRole:'pv' },
      { table:'tff_fi7f_lpm',      label:'TFF Feed Flow',          unit:'LPM',   flowRole:'pv' },
      { table:'tff_fx7f_lmh',      label:'TFF Flux',               unit:'LMH',   flowRole:'pv' },
      { table:'tff_cm',            label:'TFF Conductivity',       unit:'mS/cm', flowRole:'sensor' },
      { table:'tff_uv8r_au',       label:'TFF UV Absorbance',      unit:'AU',    flowRole:'sensor' },
      { table:'tff_wi17k_kg',      label:'TFF Weight',             unit:'kg',    flowRole:'sensor' }
    ]
  },
  {
    key: 'chromatography',
    name: 'Chromatography',
    metrics: [
      { table:'chrom_chr01_pt002_pv', label:'Pressure PT-002',  unit:'PSI',    flowRole:'pv' },
      { table:'chrom_chr01_pt003_pv', label:'Pressure PT-003',  unit:'PSI',    flowRole:'pv' },
      { table:'chrom_chr01_tt001_pv', label:'Temp TT-001',      unit:'Â°C',     flowRole:'sensor' },
      { table:'chrom_chr01_at001_pv', label:'UV AT-001',        unit:'AU',     flowRole:'sensor' },
      { table:'chrom_chr01_at002_pv', label:'UV AT-002',        unit:'AU',     flowRole:'sensor' },
      { table:'chrom_chr01_at003_pv', label:'Conductivity',     unit:'mS/cm',  flowRole:'sensor' },
      { table:'chrom_chr01_ft001_pv', label:'Flow FT-001',      unit:'mL/min', flowRole:'pv' },
      { table:'chrom_chr01_p001a_pv', label:'Pump P001A',       unit:'%',      flowRole:'actuator' },
      { table:'chrom_chr01_p001b_pv', label:'Pump P001B',       unit:'%',      flowRole:'actuator' }
    ]
  }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_PTS   = 150;
const MIN_SPC   = 20;
const MAX_LOG   = 300;
const MAX_ALERT = 200;

const S = {
  running:false, paused:false,
  timer:null, cdTimer:null,
  queries:0, rows:0, errors:0,
  logs:[], alerts:[],   // alerts: {sev, procKey, procName, tag, table, msg, rule, ts}
  history:{}            // table -> {ts[], vals[], mean, std, ucl, lcl, sigma1H, sigma1L, sigma2H, sigma2L}
};

PROCESSES.forEach(p => p.metrics.forEach(m => {
  S.history[m.table] = { ts:[], vals:[], mean:null, std:null, ucl:null, lcl:null,
                         sigma1H:null, sigma1L:null, sigma2H:null, sigma2L:null };
}));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REST PROXY API  â€”  per README.md
//   GET  {proxy}/health
//   POST {proxy}/api/query   body: {dbms, sql}   response: {Query:[{timestamp,value},...]}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const proxy = () => document.getElementById('cfgProxy').value.trim().replace(/\/$/,'');
const db    = () => document.getElementById('cfgDb').value.trim();

async function apiHealth() {
  const t0 = Date.now();
  try {
    const r = await fetch(`${proxy()}/health`);
    const dur = Date.now()-t0;
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const d = await r.json();
    log('REST','GET /health',`${d.status||'ok'} node:${d.anylog_node||'?'}`,1,dur);
    return d;
  } catch(e) {
    log('ERR','GET /health',e.message,0,Date.now()-t0);
    S.errors++; sbar(); return null;
  }
}

async function apiQuery(table, sql) {
  const t0 = Date.now();
  try {
    const r = await fetch(`${proxy()}/api/query`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({dbms:db(), sql})
    });
    const dur = Date.now()-t0;
    if (!r.ok){
      const txt=await r.text();
      log('ERR',`/api/query â†’ ${table}`,`HTTP ${r.status}: ${txt.slice(0,60)}`,0,dur);
      S.errors++; sbar(); return null;
    }
    const data = await r.json();
    const rows = Array.isArray(data?.Query) ? data.Query : Array.isArray(data) ? data : [];
    log('SQL',`/api/query â†’ ${table}`,'OK',rows.length,dur);
    S.queries++; S.rows+=rows.length; sbar();
    return rows;
  } catch(e) {
    log('ERR',`/api/query â†’ ${table}`,e.message,0,Date.now()-t0);
    S.errors++; sbar(); return null;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONNECT / DISCONNECT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btnGo').addEventListener('click', async ()=>{
  if (S.running){ stopAll(); return; }
  log('INFO','CONNECT',`Testing ${proxy()}/healthâ€¦`,0,0);
  setDot('');
  const h = await apiHealth();
  if (!h){
    setDot('err');
    document.getElementById('connLbl').textContent='Failed';
    log('ERR','CONNECT','Cannot reach proxy â€” run: ./start_rest_proxy.sh',0,0);
    return;
  }
  setDot('ok');
  document.getElementById('connLbl').textContent = proxy();
  document.getElementById('stProxy').textContent = proxy();
  document.getElementById('stDb').textContent    = db();
  document.getElementById('btnGo').textContent   = 'â¹ DISCONNECT';
  document.getElementById('btnGo').classList.add('stop');
  document.getElementById('btnPause').disabled   = false;
  S.running=true; S.paused=false;
  buildLayout();
  startPolling();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PAUSE / RESUME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btnPause').addEventListener('click',()=>{
  if (!S.running) return;
  S.paused=!S.paused;
  const btn=document.getElementById('btnPause');
  if (S.paused){
    btn.textContent='â–¶ RESUME'; btn.classList.add('on');
    clearInterval(S.timer); clearInterval(S.cdTimer);
    document.getElementById('stNext').textContent='PAUSED';
    log('INFO','PAUSE','Polling suspended',0,0);
  } else {
    btn.textContent='â¸ PAUSE'; btn.classList.remove('on');
    log('INFO','RESUME','Polling resumed',0,0);
    startPolling();
  }
});

function stopAll(){
  S.running=false; S.paused=false;
  clearInterval(S.timer); clearInterval(S.cdTimer);
  setDot('');
  document.getElementById('connLbl').textContent  ='Disconnected';
  document.getElementById('btnGo').textContent    ='âš¡ CONNECT';
  document.getElementById('btnGo').classList.remove('stop');
  document.getElementById('btnPause').disabled    =true;
  document.getElementById('btnPause').classList.remove('on');
  document.getElementById('btnPause').textContent ='â¸ PAUSE';
  document.getElementById('stNext').textContent   ='â€”';
  log('INFO','DISCONNECT','Stopped',0,0);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// POLLING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startPolling(){
  clearInterval(S.timer); clearInterval(S.cdTimer);
  pollAll();
  const iv=parseInt(document.getElementById('cfgPoll').value);
  S.timer=setInterval(pollAll,iv);
  let rem=iv/1000;
  S.cdTimer=setInterval(()=>{
    if (!S.paused){rem--;if(rem<=0)rem=iv/1000;}
    document.getElementById('stNext').textContent=S.paused?'PAUSED':`${rem}s`;
  },1000);
}

async function pollAll(){
  if (!S.running||S.paused) return;
  document.getElementById('stLast').textContent=now();
  const look=document.getElementById('cfgLook').value;
  for (const proc of PROCESSES){
    for (const m of proc.metrics){
      const sql=`SELECT value, timestamp FROM ${m.table} WHERE timestamp >= NOW() - ${look} ORDER BY timestamp ASC`;
      const rows=await apiQuery(m.table,sql);
      if (rows&&rows.length>0){
        const h=S.history[m.table];
        rows.forEach(r=>{
          const ts=new Date(r.timestamp), val=parseFloat(r.value);
          if (!isNaN(val)&&!h.ts.some(t=>Math.abs(t-ts)<500)){
            h.ts.push(ts); h.vals.push(val);
          }
        });
        while(h.ts.length>MAX_PTS){h.ts.shift();h.vals.shift();}
        calcSPC(h);
        detectAlerts(h,m,proc);
        redrawChart(m);
      }
    }
    updateBnBadge(proc);
  }
  renderAlerts();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SPC MATH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcSPC(h){
  if (h.vals.length<MIN_SPC){h.mean=h.std=h.ucl=h.lcl=h.sigma1H=h.sigma1L=h.sigma2H=h.sigma2L=null;return;}
  const n=h.vals.length;
  const mean=h.vals.reduce((a,b)=>a+b,0)/n;
  const std=Math.sqrt(h.vals.reduce((s,v)=>s+Math.pow(v-mean,2),0)/n);
  h.mean=mean; h.std=std;
  h.ucl=mean+3*std;   h.lcl=mean-3*std;
  h.sigma2H=mean+2*std; h.sigma2L=mean-2*std;
  h.sigma1H=mean+std;   h.sigma1L=mean-std;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ALERT DETECTION  â€” Western Electric Rules
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectAlerts(h,m,proc){
  if (!h.ucl) return;
  const v=h.vals.at(-1), ts=new Date();
  const push=(sev,msg,rule)=>{
    S.alerts.unshift({sev,procKey:proc.key,procName:proc.name,tag:m.label,table:m.table,unit:m.unit,msg,rule,ts});
    if (S.alerts.length>MAX_ALERT) S.alerts.pop();
  };
  // Rule 1 â€” beyond 3Ïƒ (CRITICAL)
  if (v>h.ucl) push('critical',`${v.toFixed(3)} ${m.unit} > UCL ${h.ucl.toFixed(3)}`,'Rule 1: Beyond 3Ïƒ upper limit');
  else if (v<h.lcl) push('critical',`${v.toFixed(3)} ${m.unit} < LCL ${h.lcl.toFixed(3)}`,'Rule 1: Beyond 3Ïƒ lower limit');
  // Rule 2 â€” 8 pts same side (WARNING)
  if (h.vals.length>=8){
    const r8=h.vals.slice(-8);
    if (r8.every(x=>x>h.mean)) push('warning','8 consecutive pts above mean','Rule 2: Process shift upward');
    else if (r8.every(x=>x<h.mean)) push('warning','8 consecutive pts below mean','Rule 2: Process shift downward');
  }
  // Rule 3 â€” 6 pt trend (WARNING)
  if (h.vals.length>=6){
    const r6=h.vals.slice(-6);
    if (r6.every((x,i)=>i===0||x>r6[i-1])) push('warning','6 pts consecutive rising','Rule 3: Upward trend');
    else if (r6.every((x,i)=>i===0||x<r6[i-1])) push('warning','6 pts consecutive falling','Rule 3: Downward trend');
  }
  // Rule 4 â€” 2 of 3 beyond 2Ïƒ (MINOR)
  if (h.vals.length>=3&&h.std){
    if (h.vals.slice(-3).filter(x=>Math.abs(x-h.mean)>2*h.std).length>=2)
      push('minor','2 of 3 pts beyond 2Ïƒ','Rule 4: Increased variation');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BOTTLENECK ANALYSIS â€” per process
// A bottleneck is the metric with the highest deviation from setpoint
// or highest coefficient of variation among PV metrics
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getBottleneck(proc){
  let worst=null, worstScore=-1;
  proc.metrics.forEach(m=>{
    const h=S.history[m.table];
    if (!h.vals.length) return;
    let score=0, detail='';
    if (h.std&&h.mean&&Math.abs(h.mean)>0.001){
      const cv=(h.std/Math.abs(h.mean))*100;
      score+=cv;
      detail=`CV=${cv.toFixed(1)}%`;
    }
    // Add score for each alert on this table
    const alertsOnThis=S.alerts.filter(a=>a.table===m.table);
    const critCount=alertsOnThis.filter(a=>a.sev==='critical').length;
    const warnCount=alertsOnThis.filter(a=>a.sev==='warning').length;
    score+=critCount*30+warnCount*10;
    if (critCount>0) detail+=(detail?' ':'')+`${critCount} crit`;

    if (score>worstScore){worstScore=score;worst={m,score,detail};}
  });
  return worst;
}

function bnLevel(score){
  if (score>40) return 'high';
  if (score>15) return 'low';
  return 'none';
}

function updateBnBadge(proc){
  const badge=document.getElementById(`bn_${proc.key}`);
  const bnRow=document.getElementById(`bnrow_${proc.key}`);
  if (!badge) return;
  const bn=getBottleneck(proc);
  if (!bn||bn.score<1){
    badge.className='bnbadge none'; badge.textContent='âœ“ FLOW NORMAL';
    if (bnRow) bnRow.style.display='none';
    return;
  }
  const lvl=bnLevel(bn.score);
  if (lvl==='high'){
    badge.className='bnbadge high';
    badge.textContent=`âš  BOTTLENECK: ${bn.m.label}`;
  } else {
    badge.className='bnbadge low';
    badge.textContent=`â–³ WATCH: ${bn.m.label}`;
  }
  if (bnRow){
    bnRow.style.display='flex';
    bnRow.className=`bn-metric-row ${lvl==='high'?'':'warn'}`;
    bnRow.innerHTML=`
      <span class="bn-label ${lvl==='high'?'high':'warn'}">${lvl.toUpperCase()}</span>
      <span class="bn-desc">${bn.m.label} (${bn.m.unit}) â€” ${bn.detail||'high variability'}</span>
      <span class="bn-val">${bn.m.table}</span>`;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LAYOUT â€” built once on connect
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildLayout(){
  const pane=document.getElementById('chartsPane');
  pane.innerHTML='';
  PROCESSES.forEach(proc=>{
    const blk=document.createElement('div');
    blk.className='pblk';
    blk.innerHTML=`
      <div class="phdr">
        <span class="pname">${proc.name}</span>
        <div class="phdr-right">
          <span class="bnbadge none" id="bn_${proc.key}">âœ“ FLOW NORMAL</span>
        </div>
      </div>
      <div class="bn-metric-row" id="bnrow_${proc.key}" style="display:none;border-radius:0;border-top:none;border-left:1px solid var(--bdr);border-right:1px solid var(--bdr);"></div>
      <div class="cgrid" id="grid_${proc.key}"></div>`;
    pane.appendChild(blk);
    const grid=blk.querySelector(`#grid_${proc.key}`);
    proc.metrics.forEach(m=>{
      const cell=document.createElement('div');
      cell.className='ccell';
      cell.innerHTML=`
        <div class="chdr">
          <div class="cinfo">
            <div class="cname">${m.label}</div>
            <div class="ctbl">${m.table}</div>
          </div>
          <div class="cstats">
            <div class="stat"><div class="sv u" id="ucl_${m.table}">â€”</div><div class="sk">UCL</div></div>
            <div class="stat"><div class="sv m" id="avg_${m.table}">â€”</div><div class="sk">MEAN</div></div>
            <div class="stat"><div class="sv l" id="lcl_${m.table}">â€”</div><div class="sk">LCL</div></div>
          </div>
        </div>
        <div id="plt_${m.table}" style="height:160px"></div>`;
      grid.appendChild(cell);
    });
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHART DRAWING â€” trend line + Ïƒ band markers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function redrawChart(m){
  const h=S.history[m.table];
  const id=`plt_${m.table}`;
  const el=document.getElementById(id);
  if (!el||!h.ts.length) return;

  // Update stat labels
  const f=v=>v!==null?v.toFixed(3):'â€”';
  document.getElementById(`ucl_${m.table}`).textContent=f(h.ucl);
  document.getElementById(`avg_${m.table}`).textContent=f(h.mean);
  document.getElementById(`lcl_${m.table}`).textContent=f(h.lcl);

  // Colour each data point by zone
  const colors=h.vals.map(v=>{
    if (!h.ucl) return '#00d4ff';
    if (v>h.ucl||v<h.lcl)             return '#ff3d5a';  // beyond 3Ïƒ â€” red
    if (h.std&&Math.abs(v-h.mean)>2*h.std) return '#ff8c00';  // beyond 2Ïƒ â€” orange
    if (h.std&&Math.abs(v-h.mean)>h.std)   return '#ffbe00';  // beyond 1Ïƒ â€” yellow
    return '#00d4ff';                                           // within 1Ïƒ â€” cyan
  });

  // Marker sizes â€” slightly larger for out-of-control points
  const sizes=h.vals.map(v=>{
    if (!h.ucl) return 4;
    if (v>h.ucl||v<h.lcl) return 7;
    if (h.std&&Math.abs(v-h.mean)>2*h.std) return 6;
    return 4;
  });

  const traces=[{
    x:h.ts, y:h.vals, mode:'lines+markers', name:m.label,
    line:{color:'rgba(0,212,255,0.6)',width:1.5},
    marker:{size:sizes, color:colors, symbol:'circle',
            line:{color:colors.map(c=>c==='#00d4ff'?'transparent':c),width:1.5}},
    hovertemplate:`<b>%{y:.3f} ${m.unit}</b><br>%{x}<extra>${m.label}</extra>`
  }];

  // Reference band lines â€” only when we have enough data
  if (h.ucl!==null){
    const x0=h.ts[0], x1=h.ts.at(-1);
    const rl=(y,col,dash,name,w=1)=>({
      x:[x0,x1],y:[y,y],mode:'lines',name,showlegend:false,hoverinfo:'skip',
      line:{color:col,width:w,dash}
    });
    // Â±3Ïƒ UCL/LCL â€” dashed red
    traces.push(rl(h.ucl, '#ff3d5a','dash','UCL',1.5));
    traces.push(rl(h.lcl, '#ff3d5a','dash','LCL',1.5));
    // Â±2Ïƒ â€” dotted orange
    traces.push(rl(h.sigma2H,'#ff8c00','dot','+2Ïƒ',1));
    traces.push(rl(h.sigma2L,'#ff8c00','dot','-2Ïƒ',1));
    // Â±1Ïƒ â€” dotted yellow (normal variation range)
    traces.push(rl(h.sigma1H,'#ffbe00','dot','+1Ïƒ',1));
    traces.push(rl(h.sigma1L,'#ffbe00','dot','-1Ïƒ',1));
    // Mean â€” dotted green
    traces.push(rl(h.mean,'#00ff9d','dot','Mean',1.5));

    // Shaded normal variation band (Â±1Ïƒ) â€” filled area
    traces.push({
      x:[...h.ts,...h.ts.slice().reverse()],
      y:[...Array(h.ts.length).fill(h.sigma1H),...Array(h.ts.length).fill(h.sigma1L).reverse()],
      fill:'toself', fillcolor:'rgba(255,190,0,0.05)',
      line:{color:'transparent'}, hoverinfo:'skip', showlegend:false, name:'Normal band'
    });
  }

  const layout={
    height:160, margin:{l:42,r:6,t:4,b:24},
    paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
    font:{color:'#4a6580',size:9,family:'Share Tech Mono'},
    xaxis:{gridcolor:'rgba(255,255,255,0.04)',linecolor:'#1c3050',zeroline:false,tickcolor:'#1c3050'},
    yaxis:{gridcolor:'rgba(255,255,255,0.04)',linecolor:'#1c3050',zeroline:false,tickcolor:'#1c3050'},
    showlegend:false, hovermode:'closest'
  };

  el._p
    ? Plotly.react(id,traces,layout,{responsive:true,displayModeBar:false})
    : Plotly.newPlot(id,traces,layout,{responsive:true,displayModeBar:false}).then(()=>el._p=true);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ALERTS RENDER â€” grouped by process, sorted criticalâ†’warningâ†’minor
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAlerts(){
  const pane=document.getElementById('alertsPane');
  const sevOrder={critical:0,warning:1,minor:2};

  // Total count badge
  document.getElementById('aTotalBadge').textContent=S.alerts.length?`${S.alerts.length} total`:'';

  if (!S.alerts.length){
    pane.innerHTML='<div class="empty">No special cause alerts detected</div>';
    return;
  }

  // Group by process, preserving PROCESSES order
  const byProc={};
  PROCESSES.forEach(p=>{byProc[p.key]=[];});
  S.alerts.forEach(a=>{ if (byProc[a.procKey]) byProc[a.procKey].push(a); });

  let html='';
  PROCESSES.forEach(proc=>{
    const alerts=byProc[proc.key];
    if (!alerts.length) return;

    // Sort within process: critical first
    alerts.sort((a,b)=>sevOrder[a.sev]-sevOrder[b.sev]);

    // Count badge
    const crits=alerts.filter(a=>a.sev==='critical').length;
    const warns=alerts.filter(a=>a.sev==='warning').length;
    const badgeTxt=[crits?`<span style="color:var(--red)">${crits} CRIT</span>`:'',
                    warns?`<span style="color:var(--warn)">${warns} WARN</span>`:'']
                   .filter(Boolean).join(' ');

    html+=`<div class="proc-alerts">
      <div class="proc-alert-hdr" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'':'none'">
        <span>${proc.name}</span>
        <span style="font-size:10px;font-family:'Share Tech Mono',monospace;">${badgeTxt||alerts.length+' alerts'}</span>
      </div>
      <div class="proc-alert-body">
        ${alerts.slice(0,20).map(a=>`
          <div class="arow">
            <div class="sev ${a.sev}">${a.sev.toUpperCase()}</div>
            <div>
              <div class="atag">${a.tag}</div>
              <div class="amsg">${a.msg}</div>
              <div class="arule">${a.rule} Â· ${now(a.ts)}</div>
            </div>
          </div>`).join('')}
        ${alerts.length>20?`<div class="no-alerts">+ ${alerts.length-20} moreâ€¦</div>`:''}
      </div>
    </div>`;
  });

  pane.innerHTML=html||'<div class="empty">No alerts</div>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(kind,call,result,rows,durMs){
  S.logs.unshift({ts:new Date(),kind,call,result,rows,dur:durMs});
  if (S.logs.length>MAX_LOG) S.logs.pop();
  renderLog();
}

function renderLog(){
  const pane=document.getElementById('logPane');
  if (!S.logs.length){pane.innerHTML='<div class="empty">No entries</div>';return;}
  pane.innerHTML=S.logs.map(e=>{
    const isErr=e.kind==='ERR';
    const rowCls=isErr?'err':e.rows>0?'ok':'zero';
    const rowTxt=isErr?'ERR':`${e.rows}r`;
    const disp=e.kind==='SQL'?`â†’ ${e.call.split('â†’')[1]?.trim()||e.call}`:e.call;
    const full=(e.call+'|'+e.result).replace(/"/g,'&quot;');
    return `<div class="lrow" title="${full}">
      <span class="lt">${now(e.ts)}</span>
      <span class="lk ${e.kind}">${e.kind}</span>
      <span class="lm">${disp}</span>
      <span class="lr ${rowCls}">${rowTxt}</span>
      <span class="ld">${e.dur>0?e.dur+'ms':''}</span>
    </div>`;
  }).join('');
}

function clearLog(){S.logs=[];renderLog();}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDot(cls){
  document.getElementById('dot').className='dot'+(cls?' '+cls:'');
}
function sbar(){
  document.getElementById('stQ').textContent=S.queries;
  document.getElementById('stR').textContent=S.rows;
  document.getElementById('stE').textContent=S.errors;
}
function now(d=new Date()){
  return d.toLocaleTimeString('en-US',{hour12:false});
}
</script>
</body>
</html>
