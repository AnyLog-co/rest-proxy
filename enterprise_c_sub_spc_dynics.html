<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enterprise C SUB-250 â€” SPC Control Charts Â· Dynics</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Chakra+Petch:wght@300;400;600;700&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Rajdhani',sans-serif;background:#08101a;color:#c9d6e3;}

.wrap{height:100vh;display:flex;flex-direction:column;padding:9px;gap:7px;max-width:2100px;margin:0 auto;}

/* â”€â”€ Top bar â”€â”€ */
.top{
  background:linear-gradient(90deg,#0c1d30 0%,#091624 100%);
  border:1px solid #1c3850;padding:9px 14px;border-radius:10px;
  display:flex;align-items:center;gap:9px;flex-wrap:wrap;
  box-shadow:0 2px 20px rgba(0,0,0,.6);
}
.logo{color:#00d4ff;font-weight:700;font-size:16px;font-family:'Chakra Petch',sans-serif;
  display:flex;align-items:baseline;gap:7px;white-space:nowrap;
  text-shadow:0 0 14px rgba(0,212,255,.45);}
.logo em{font-style:normal;color:#3a6a8a;font-size:10px;font-weight:500;}
.grp{display:flex;align-items:center;gap:5px;}
.lbl{color:#3a6a8a;font-size:10px;white-space:nowrap;font-family:'Share Tech Mono',monospace;
  text-transform:uppercase;letter-spacing:.5px;}
input.f,select.f{
  padding:5px 8px;border-radius:5px;border:1px solid #1c3850;
  background:#091624;color:#c9d6e3;font-size:10px;outline:none;
  font-family:'Share Tech Mono',monospace;transition:border-color .2s,box-shadow .2s;}
input.f:focus,select.f:focus{border-color:#00d4ff;box-shadow:0 0 0 2px rgba(0,212,255,.15);}
.w80{width:80px;}.w150{width:152px;}.w105{width:108px;}.w90{width:93px;}
.btn{padding:5px 12px;border:1px solid transparent;border-radius:6px;cursor:pointer;
  font-size:10px;font-weight:700;font-family:'Chakra Petch',sans-serif;
  transition:.15s;white-space:nowrap;letter-spacing:.5px;text-transform:uppercase;}
.btn:hover:not(:disabled){filter:brightness(1.15);transform:translateY(-1px);}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
#btnGo{background:#00d4ff;color:#08101a;border-color:#00d4ff;}
#btnGo.stop{background:#f44336;color:#fff;border-color:#f44336;}
#btnPause{background:transparent;color:#FF9800;border-color:#FF9800;}
#btnPause.on{background:#4CAF50;color:#fff;border-color:#4CAF50;}
.pill{display:flex;align-items:center;gap:7px;padding:4px 9px;border-radius:14px;
  background:#091624;border:1px solid #1c3850;font-size:10px;color:#3a6a8a;margin-left:auto;
  font-family:'Share Tech Mono',monospace;}
.dot{width:8px;height:8px;border-radius:50%;background:#1e3a5a;flex-shrink:0;}
.dot.ok{background:#4CAF50;box-shadow:0 0 5px #4CAF50;animation:pulse 2s infinite;}
.dot.err{background:#f44336;box-shadow:0 0 5px #f44336;animation:pulse 1s infinite;}
.dot.pend{background:#FF9800;box-shadow:0 0 5px #FF9800;animation:pulse .5s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}

/* â”€â”€ Status bar â”€â”€ */
.sbar{background:#091421;border:1px solid #182e44;border-radius:7px;padding:6px 13px;
  display:flex;gap:18px;flex-wrap:wrap;font-size:10px;color:#3a6a8a;
  font-family:'Share Tech Mono',monospace;}
.sbar span{color:#00d4ff;font-weight:700;}

/* â”€â”€ Main â”€â”€ */
.main{flex:1;min-height:0;display:grid;grid-template-columns:1fr 405px;gap:8px;}
.left{min-height:0;overflow-y:auto;padding-right:3px;}
.right{min-height:0;display:flex;flex-direction:column;gap:7px;overflow:hidden;}

/* â”€â”€ Right sections â”€â”€ */
.rsec{background:#091421;border:1px solid #182e44;border-radius:9px;
  overflow:hidden;display:flex;flex-direction:column;}
.rhdr{padding:7px 11px;border-bottom:1px solid #182e44;
  color:#00d4ff;font-weight:700;font-size:10px;letter-spacing:.8px;text-transform:uppercase;
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  font-family:'Chakra Petch',sans-serif;background:linear-gradient(90deg,#0c1d30,#091624);}

/* â”€â”€ Chart range bar â”€â”€ */
.rng-bar{display:flex;align-items:center;gap:8px;padding:6px 10px;
  background:#091421;border-bottom:1px solid #182e44;font-size:10px;
  font-family:'Share Tech Mono',monospace;color:#3a6a8a;flex-shrink:0;}
.rng-bar input[type=range]{flex:1;accent-color:#00d4ff;height:3px;cursor:pointer;}
.rng-val{color:#00d4ff;font-weight:700;min-width:38px;text-align:right;}

/* â”€â”€ Process block â”€â”€ */
.pblk{margin-bottom:9px;border-radius:9px;overflow:hidden;border:1px solid #182e44;}
.phdr{background:#0c1d30;padding:8px 13px;display:flex;justify-content:space-between;
  align-items:center;gap:10px;border-left:4px solid #00d4ff;}
.pname{font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;
  color:#c9d6e3;font-family:'Chakra Petch',sans-serif;}
.phdr-right{display:flex;align-items:center;gap:7px;}
.bnbadge{font-size:9px;padding:2px 9px;border-radius:10px;font-weight:700;white-space:nowrap;
  font-family:'Share Tech Mono',monospace;}
.bnbadge.none{background:#0e2a0e;color:#2ea043;border:1px solid #183818;}
.bnbadge.low{background:#281e00;color:#e3b341;border:1px solid #483800;animation:pulse 3s infinite;}
.bnbadge.high{background:#280a0a;color:#f85149;border:1px solid #501818;animation:pulse 1.2s infinite;}
.bn-row{background:#190808;border-left:4px solid #f44336;padding:6px 11px;
  font-size:10px;display:flex;gap:7px;align-items:center;font-family:'Share Tech Mono',monospace;}
.bn-row.warn{background:#181200;border-left-color:#FF9800;}
.bn-lbl{font-size:8px;font-weight:800;text-transform:uppercase;padding:2px 5px;border-radius:3px;}
.bn-lbl.high{background:#f44336;color:#fff;}
.bn-lbl.warn{background:#FF9800;color:#fff;}
.bn-desc{flex:1;color:#c9d6e3;font-size:9px;}
.bn-val{font-size:9px;color:#3a6a8a;max-width:135px;overflow:hidden;text-overflow:ellipsis;}

/* â”€â”€ Cell grid â”€â”€ */
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(330px,1fr));
  gap:9px;padding:9px;background:#08101a;}
.ccell{background:#091421;border:1px solid #182e44;border-radius:7px;padding:10px;overflow:hidden;
  transition:border-color .2s;}
.ccell:hover{border-color:#00d4ff33;}
.ccell.crit-hi{border-color:#f8514988 !important;box-shadow:0 0 10px rgba(248,81,73,.12);}
.ccell.warn-hi{border-color:#e3b34188 !important;}
.chdr{display:flex;justify-content:space-between;align-items:flex-start;gap:9px;margin-bottom:4px;}
.cname{font-weight:700;color:#c9d6e3;font-size:11px;line-height:1.25;}
.ctbl{font-size:8px;color:#1e3a5a;margin-top:2px;font-family:'Share Tech Mono',monospace;}
.cstats{display:flex;gap:8px;flex-shrink:0;}
.stat{text-align:right;}
.sv{font-family:'Share Tech Mono',monospace;font-size:10px;font-weight:700;line-height:1.2;}
.sv.u{color:#f44336;}.sv.l{color:#f44336;}.sv.m{color:#00d4ff;}.sv.n{color:#1e3a5a;}
.sk{font-size:8px;color:#1e3a5a;text-transform:uppercase;letter-spacing:.4px;}
.sv-last{font-family:'Share Tech Mono',monospace;font-size:11px;font-weight:700;}
.sv-last.ok{color:#00d4ff;}.sv-last.w{color:#e3b341;}.sv-last.c{color:#f85149;}.sv-last.n{color:#1e3a5a;}
.crange{font-size:8px;color:#1e3a5a;font-family:'Share Tech Mono',monospace;margin-bottom:2px;}

/* â”€â”€ Alerts â”€â”€ */
.proc-alerts{border-bottom:1px solid #182e44;}
.proc-alert-hdr{padding:6px 10px;background:#0c1d30;cursor:pointer;user-select:none;
  font-weight:700;font-size:10px;color:#c9d6e3;display:flex;justify-content:space-between;
  align-items:center;font-family:'Chakra Petch',sans-serif;letter-spacing:.5px;}
.proc-alert-hdr:hover{background:#0f2438;}
.arow{padding:7px 10px;border-bottom:1px solid #0e1e2d;display:grid;grid-template-columns:76px 1fr;gap:7px;}
.sev{font-size:8px;font-weight:800;border-radius:3px;padding:2px 4px;text-align:center;
  text-transform:uppercase;font-family:'Share Tech Mono',monospace;}
.sev.critical{background:#290a0a;color:#f85149;border:1px solid #501818;}
.sev.warning{background:#291e00;color:#e3b341;border:1px solid #503800;}
.sev.minor{background:#0a1a29;color:#58a6ff;border:1px solid #183850;}
.atag{font-size:10px;font-weight:700;color:#c9d6e3;font-family:'Chakra Petch',sans-serif;}
.amsg{font-size:9px;color:#8b949e;margin-top:1px;}
.arule{font-size:8px;color:#1e3a5a;margin-top:1px;font-family:'Share Tech Mono',monospace;}
.no-alerts{padding:7px 10px;font-size:10px;color:#1e3a5a;}
.empty{padding:18px;text-align:center;color:#1e3a5a;font-size:11px;}

/* â”€â”€ Log panel â€” same mechanism as enterprise_c_spc.html â”€â”€ */
.log-panel{background:#0d1117;border-radius:9px;overflow:hidden;margin:5px;}
.log-header{display:flex;align-items:center;gap:9px;padding:8px 13px;cursor:pointer;
  background:#161b22;border-bottom:1px solid #30363d;user-select:none;}
.log-header:hover{background:#1c2128;}
.log-title{color:#e6edf3;font-size:11px;font-weight:700;flex:1;font-family:'Chakra Petch',sans-serif;}
.log-stats{display:flex;gap:7px;flex-wrap:wrap;}
.log-stat{font-size:9px;font-weight:700;padding:2px 6px;border-radius:7px;}
.ls-total{background:#21262d;color:#8b949e;}
.ls-ok{background:#1a3a1a;color:#3fb950;}
.ls-err{background:#3a1a1a;color:#f85149;}
.ls-rows{background:#1a2a3a;color:#58a6ff;}
.log-caret{color:#8b949e;font-size:10px;transition:transform .2s;}
.log-caret.open{transform:rotate(180deg);}
.log-toolbar{display:flex;gap:5px;align-items:center;padding:6px 13px;
  background:#161b22;border-bottom:1px solid #30363d;}
.log-toolbar input{flex:1;padding:3px 6px;border-radius:4px;border:1px solid #30363d;
  background:#0d1117;color:#e6edf3;font-size:9px;font-family:'Share Tech Mono',monospace;}
.log-filter-btn{padding:2px 7px;border:none;border-radius:4px;font-size:9px;font-weight:700;
  cursor:pointer;background:#21262d;color:#8b949e;transition:.15s;}
.log-filter-btn.active{background:#1f6feb;color:#fff;}
.log-filter-btn:hover:not(.active){background:#30363d;}
.log-clear{padding:2px 7px;border:none;border-radius:4px;font-size:9px;cursor:pointer;
  background:#3a1a1a;color:#f85149;}
.log-clear:hover{background:#5a2020;}
.log-body{max-height:280px;overflow-y:auto;font-family:'Share Tech Mono','Consolas',monospace;}
.log-entry{display:grid;grid-template-columns:62px 40px 46px 70px 1fr 55px 58px;
  align-items:center;padding:3px 0;border-bottom:1px solid #161b22;font-size:9px;}
.log-entry:hover{background:#161b22;}
.log-entry.hidden{display:none;}
.log-entry.log-err{border-left:2px solid #f85149;}
.log-entry.log-ok{border-left:2px solid transparent;}
.le-time{color:#8b949e;padding-left:9px;white-space:nowrap;}
.le-method{font-weight:700;text-align:center;}
.le-method.m-get{color:#3fb950;}.le-method.m-post{color:#58a6ff;}
.le-status{text-align:center;}
.le-status.s-ok{color:#3fb950;}.le-status.s-err{color:#f85149;font-weight:700;}
.le-dur{color:#e3b341;text-align:right;padding-right:5px;}
.le-path{color:#79c0ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:0 4px;}
.le-detail{color:#8b949e;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:8px;}
.le-rows{color:#a5d6ff;text-align:right;padding-right:9px;white-space:nowrap;font-size:8px;}
.log-col-header{display:grid;grid-template-columns:62px 40px 46px 70px 1fr 55px 58px;
  padding:4px 0;background:#161b22;font-size:8px;color:#484f58;
  font-family:'Share Tech Mono',monospace;border-bottom:1px solid #30363d;
  text-transform:uppercase;letter-spacing:.4px;}
.log-col-header span:first-child{padding-left:9px;}
.row-summary{border-top:1px solid #30363d;padding:7px 13px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
.row-summary-title{color:#484f58;font-size:8px;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap;}
.row-tbl{display:flex;align-items:center;gap:4px;font-family:'Share Tech Mono',monospace;font-size:9px;}
.row-tbl-name{color:#79c0ff;}.row-tbl-cnt{color:#3fb950;font-weight:700;}.row-tbl-sep{color:#30363d;}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:#091421;}
::-webkit-scrollbar-thumb{background:#1c3850;border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:#00d4ff33;}
</style>
</head>
<body>
<div class="wrap">

<!-- TOP BAR -->
<div class="top">
  <div class="logo">Enterprise C <span style="color:#1c3850;margin:0 3px;">/</span> SUB-250 <em>SPC Â· Dynics</em></div>

  <div class="grp"><span class="lbl">Proxy</span>
    <input class="f w150" id="cfgProxy" value="http://localhost:8080"></div>

  <div class="grp"><span class="lbl">DB</span>
    <input class="f w105" id="cfgDb" value="manufacturing_historian"></div>

  <div class="grp"><span class="lbl">Trend Window</span>
    <select class="f w90" id="cfgLook">
      <option value="5 minutes">5 min</option>
      <option value="15 minutes">15 min</option>
      <option value="30 minutes">30 min</option>
      <option value="1 hour" selected>1 hr</option>
      <option value="4 hours">4 hr</option>
      <option value="8 hours">8 hr</option>
      <option value="24 hours">24 hr</option>
    </select></div>

  <div class="grp"><span class="lbl">Baseline (Ïƒ)</span>
    <select class="f w90" id="cfgBaseline">
      <option value="30 minutes">30 min</option>
      <option value="1 hour">1 hr</option>
      <option value="2 hours">2 hr</option>
      <option value="4 hours" selected>4 hr</option>
      <option value="8 hours">8 hr</option>
      <option value="24 hours">24 hr</option>
    </select></div>

  <div class="grp"><span class="lbl">Plot Rate</span>
    <select class="f w90" id="cfgPoll">
      <option value="5000">5 s</option>
      <option value="10000" selected>10 s</option>
      <option value="30000">30 s</option>
      <option value="60000">1 min</option>
      <option value="120000">2 min</option>
    </select></div>

  <button class="btn" id="btnGo">âš¡ CONNECT</button>
  <button class="btn" id="btnPause" disabled>â¸ PAUSE</button>

  <div class="pill"><div class="dot" id="dot"></div><span id="connLbl">Disconnected</span></div>
</div>

<!-- STATUS BAR -->
<div class="sbar">
  <div>PROXY <span id="stProxy">â€”</span></div>
  <div>DB <span id="stDb">â€”</span></div>
  <div>DATA SRC <span style="color:#a78bfa;">dynics-proveit</span></div>
  <div>SENSORS <span id="stSensors">29</span></div>
  <div>QUERIES <span id="stQ">0</span></div>
  <div>ROWS <span id="stR">0</span></div>
  <div>ERRORS <span id="stE">0</span></div>
  <div>LAST POLL <span id="stLast">â€”</span></div>
  <div>NEXT POLL <span id="stNext">â€”</span></div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- LEFT: Charts -->
  <div class="left" id="chartsPane">
    <div class="empty" style="margin-top:60px;font-size:12px;line-height:2.5;font-family:'Share Tech Mono',monospace;">
      <div style="color:#00d4ff;font-size:14px;margin-bottom:10px;font-family:'Chakra Petch',sans-serif;">
        âš¡ Enterprise C / SUB-250 â€” SPC Control Charts
      </div>
      1. Start the MCP Web Bridge:<br>
      <code style="color:#3fb950;font-size:10px;">python3 mcp_web_bridge.py</code><br>
      2. Click <strong style="color:#00d4ff;">âš¡ CONNECT</strong> to start live SPC charts<br>
      <div style="color:#1e3a5a;font-size:9px;margin-top:14px;">
        Data: dynics-proveit Â· 29 analog sensors Â· 7 process groups
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right">

    <div class="rsec" style="flex-shrink:0;">
      <div class="rhdr">ğŸš¨ Special Cause Alerts â€” by Process
        <span id="aTotalBadge" style="font-size:9px;font-family:'Share Tech Mono',monospace;color:#f85149;"></span>
      </div>
    </div>

    <div class="rsec" style="flex:0 0 40%;overflow:hidden;display:flex;flex-direction:column;">
      <div style="flex:1;overflow-y:auto;" id="alertsPane">
        <div class="empty">No alerts yet</div>
      </div>
    </div>

    <div class="rsec" style="flex:1;overflow:hidden;">
      <div class="rhdr">ğŸ“‹ API / Query Log</div>
      <div style="padding:0;overflow:hidden;flex:1;">
        <div class="log-panel">
          <div class="log-header" onclick="toggleLogOpen()">
            <span class="log-caret" id="logCaret">â–¾</span>
            <div class="log-title">API Call Log</div>
            <div class="log-stats">
              <span class="log-stat ls-total" id="log-total">0 calls</span>
              <span class="log-stat ls-ok"    id="log-ok">0 ok</span>
              <span class="log-stat ls-err"   id="log-err">0 err</span>
              <span class="log-stat ls-rows"  id="log-rows">0 rows</span>
            </div>
          </div>
          <div id="logInner" style="display:none;">
            <div class="log-toolbar">
              <input id="logSearch" placeholder="Filter (table / path / SQL)..." oninput="filterLog()"/>
              <button class="log-filter-btn active" id="lf-all"   onclick="setLogFilter('all')">All</button>
              <button class="log-filter-btn"        id="lf-get"   onclick="setLogFilter('get')">GET</button>
              <button class="log-filter-btn"        id="lf-post"  onclick="setLogFilter('post')">POST</button>
              <button class="log-filter-btn"        id="lf-error" onclick="setLogFilter('error')">Errors</button>
              <button class="log-clear" onclick="clearLog()">Clear</button>
            </div>
            <div class="log-col-header">
              <span>Time</span><span>Verb</span><span>Status</span><span>Dur</span>
              <span>Path / Cmd</span><span>Rows</span><span>Table</span>
            </div>
            <div class="log-body" id="logBody"></div>
            <div class="row-summary">
              <div class="row-summary-title">Rows by table</div>
              <div id="rowSumContent" style="flex:1;min-width:170px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

</div>
<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCESS & SENSOR DEFINITIONS
// Exact table names verified from manufacturing_historian via listTables
// Data source: dynics-proveit via web bridge
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROCESSES = [
  {
    key:'temperature', name:'Temperature Control', icon:'ğŸŒ¡ï¸', color:'#00d4ff',
    metrics:[
      {table:'sub_tic_250_001_pv_celsius', label:'Reactor Temp TIC-001 PV', unit:'Â°C',    flowRole:'pv'},
      {table:'sub_tic_250_001_sp_celsius', label:'Reactor Temp TIC-001 SP', unit:'Â°C',    flowRole:'sp'},
      {table:'sub_tic_250_002_pv_celsius', label:'Jacket Temp TIC-002 PV',  unit:'Â°C',    flowRole:'pv'},
      {table:'sub_tic_250_002_sp_celsius', label:'Jacket Temp TIC-002 SP',  unit:'Â°C',    flowRole:'sp'},
      {table:'sub_ti_250_001_pv_celsius',  label:'Temp Probe TI-001',       unit:'Â°C',    flowRole:'sensor'},
      {table:'sub_ti_250_002_pv_celsius',  label:'Temp Probe TI-002',       unit:'Â°C',    flowRole:'sensor'}
    ]
  },
  {
    key:'ph_do', name:'pH & Dissolved Oxygen', icon:'ğŸ§ª', color:'#a78bfa',
    metrics:[
      {table:'sub_aic_250_001_pv_percent', label:'DO% AIC-001 PV',          unit:'%',     flowRole:'pv'},
      {table:'sub_aic_250_001_sp_percent', label:'DO% AIC-001 SP',          unit:'%',     flowRole:'sp'},
      {table:'sub_aic_250_003_pv_ph',      label:'pH AIC-003 PV',           unit:'pH',    flowRole:'pv'},
      {table:'sub_aic_250_003_sp_ph',      label:'pH AIC-003 SP',           unit:'pH',    flowRole:'sp'}
    ]
  },
  {
    key:'gas_flow', name:'Gas Flow Control', icon:'ğŸ’¨', color:'#58a6ff',
    metrics:[
      {table:'sub_fic_250_001_pv_slpm',    label:'Air Flow FIC-001 PV',     unit:'sLpm',  flowRole:'pv'},
      {table:'sub_fic_250_001_sp_slpm',    label:'Air Flow FIC-001 SP',     unit:'sLpm',  flowRole:'sp'},
      {table:'sub_fic_250_002_pv_slpm',    label:'Oâ‚‚ Flow FIC-002 PV',     unit:'sLpm',  flowRole:'pv'},
      {table:'sub_fic_250_002_sp_slpm',    label:'Oâ‚‚ Flow FIC-002 SP',     unit:'sLpm',  flowRole:'sp'},
      {table:'sub_fic_250_003_pv_slpm',    label:'COâ‚‚ Flow FIC-003 PV',    unit:'sLpm',  flowRole:'pv'},
      {table:'sub_fic_250_003_sp_slpm',    label:'COâ‚‚ Flow FIC-003 SP',    unit:'sLpm',  flowRole:'sp'}
    ]
  },
  {
    key:'valves', name:'Flow Control Valves', icon:'ğŸ”§', color:'#e3b341',
    metrics:[
      {table:'sub_fcv_250_001_pv_percent', label:'FCV-001 Position PV',     unit:'%',     flowRole:'actuator'},
      {table:'sub_fcv_250_001_sp_percent', label:'FCV-001 Setpoint SP',     unit:'%',     flowRole:'sp'},
      {table:'sub_fcv_250_002_pv_percent', label:'FCV-002 Position PV',     unit:'%',     flowRole:'actuator'},
      {table:'sub_fcv_250_002_sp_percent', label:'FCV-002 Setpoint SP',     unit:'%',     flowRole:'sp'},
      {table:'sub_fcv_250_003_pv_percent', label:'FCV-003 Position PV',     unit:'%',     flowRole:'actuator'},
      {table:'sub_fcv_250_003_sp_percent', label:'FCV-003 Setpoint SP',     unit:'%',     flowRole:'sp'}
    ]
  },
  {
    key:'agitation', name:'Agitation & Pumps', icon:'âš™ï¸', color:'#3fb950',
    metrics:[
      {table:'sub_sic_250_002_pv_eu_1',        label:'Agitator SIC-002 PV',      unit:'EU',     flowRole:'pv'},
      {table:'sub_sic_250_002_sp_eu_1',        label:'Agitator SIC-002 SP',      unit:'EU',     flowRole:'sp'},
      {table:'sub_sic_250_008_pv_rpm',         label:'Agitator SIC-008 PV',      unit:'RPM',    flowRole:'pv'},
      {table:'sub_sic_250_008_sp_rpm',         label:'Agitator SIC-008 SP',      unit:'RPM',    flowRole:'sp'},
      {table:'sub_sic_250_003_pv_l_per_min',   label:'Feed Pump SIC-003 PV',     unit:'L/min',  flowRole:'pv'},
      {table:'sub_sic_250_003_sp_l_per_min',   label:'Feed Pump SIC-003 SP',     unit:'L/min',  flowRole:'sp'},
      {table:'sub_sic_250_004_pv_l_per_min',   label:'Harvest Pump SIC-004 PV',  unit:'L/min',  flowRole:'pv'},
      {table:'sub_sic_250_004_sp_l_per_min',   label:'Harvest Pump SIC-004 SP',  unit:'L/min',  flowRole:'sp'},
      {table:'sub_sic_250_005_pv_ml_per_min',  label:'Base Pump SIC-005 PV',     unit:'mL/min', flowRole:'pv'},
      {table:'sub_sic_250_005_sp_ml_per_min',  label:'Base Pump SIC-005 SP',     unit:'mL/min', flowRole:'sp'},
      {table:'sub_sic_250_006_pv_ml_per_min',  label:'Acid Pump SIC-006 PV',     unit:'mL/min', flowRole:'pv'},
      {table:'sub_sic_250_006_sp_ml_per_min',  label:'Acid Pump SIC-006 SP',     unit:'mL/min', flowRole:'sp'},
      {table:'sub_sic_250_media_pv_l_per_min', label:'Media Pump SIC-MEDIA PV',  unit:'L/min',  flowRole:'pv'},
      {table:'sub_sic_250_media_sp_l_per_min', label:'Media Pump SIC-MEDIA SP',  unit:'L/min',  flowRole:'sp'}
    ]
  },
  {
    key:'pressure', name:'Pressure Control', icon:'ğŸ“Š', color:'#f78166',
    metrics:[
      {table:'sub_pic_250_001_pv_psi',     label:'Headspace PIC-001 PV',    unit:'PSI',   flowRole:'pv'},
      {table:'sub_pic_250_001_sp_psi',     label:'Headspace PIC-001 SP',    unit:'PSI',   flowRole:'sp'}
    ]
  },
  {
    key:'weight', name:'Weight & Level', icon:'âš–ï¸', color:'#ffa657',
    metrics:[
      {table:'sub_wi_250_001_pv_kg',       label:'Vessel Weight WI-001',    unit:'kg',    flowRole:'sensor'}
    ]
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAX_PTS   = 200;
const MIN_SPC   = 3;  // compute UCL/LCL as soon as we have any data
const MAX_ALERT = 400;
const MAX_LOG   = 500;

const S = {
  running:false, paused:false,
  timer:null, cdTimer:null,
  queries:0, rows:0, errors:0,
  alerts:[],
  history:{},
  schema:{},  // cache: table -> {tsCol, valCol}
  polling:false  // prevents overlapping poll cycles
};

let chartViewMinutes = 60;

function initHistory(){
  PROCESSES.forEach(p=>p.metrics.forEach(m=>{
    if(!S.history[m.table])
      S.history[m.table]={ts:[],vals:[],baseVals:[],
        mean:null,std:null,ucl:null,lcl:null,
        sigma1H:null,sigma1L:null,sigma2H:null,sigma2L:null};
  }));
}
initHistory();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROXY / API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const proxy   = ()=>document.getElementById('cfgProxy').value.trim().replace(/\/$/,'');
const db      = ()=>document.getElementById('cfgDb').value.trim();
const lookback= ()=>document.getElementById('cfgLook').value;
// Map trend window selection to a row count for DESC LIMIT queries
// Assumes ~4 samples/min typical IoT rate; capped at MAX_PTS for chart clarity
// Fetch enough rows to compute good SPC statistics AND display the trend chart
// 2000 rows at typical 4 samples/min covers ~8 hours of data
const trendLimit= ()=>2000;
const baseline= ()=>document.getElementById('cfgBaseline').value;

async function apiStatus(){
  const t0=Date.now();
  try{
    const r=await fetch(`${proxy()}/api/status`);
    const dur=Date.now()-t0;
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const d=await r.json();
    logCall({method:'GET',path:'/api/status',status:200,dur,rowCnt:1,type:'status',
      detail:`status:${d.status} mcp:${d.mcp?.connected??d.connected??'?'}`,table:''});
    return d;
  }catch(e){
    logCall({method:'GET',path:'/api/status',status:0,dur:Date.now()-t0,rowCnt:0,
      type:'status',detail:e.message,table:'',error:e});
    S.errors++;sbar();return null;
  }
}

async function apiTrend(table, sql){
  const t0=Date.now();
  try{
    const r=await fetch(`${proxy()}/api/query`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({dbms:db(), sql})
    });
    const dur=Date.now()-t0;
    if(!r.ok){
      const txt=await r.text().catch(()=>'');
      logCall({method:'POST',path:'/api/query',status:r.status,dur,rowCnt:0,type:'trend',
        detail:`${table} | HTTP ${r.status}: ${txt.slice(0,55)}`,table,error:new Error(`HTTP ${r.status}`)});
      S.errors++;sbar();return null;
    }
    const data=await r.json();
    // Handle response shapes: direct array OR {Query:[...]} OR {result:[...]}
    const rows=Array.isArray(data)?data
              :Array.isArray(data?.Query)?data.Query
              :Array.isArray(data?.result)?data.result:[];
    logCall({method:'POST',path:'/api/query',status:200,dur,rowCnt:rows.length,type:'trend',
      detail:sql.slice(0,75),table});
    S.queries++;S.rows+=rows.length;sbar();
    return rows;
  }catch(e){
    logCall({method:'POST',path:'/api/query',status:0,dur:Date.now()-t0,rowCnt:0,type:'trend',
      detail:`${table} | ${e.message}`,table,error:e});
    S.errors++;sbar();return null;
  }
}

// Column names are fixed for all manufacturing_historian tables
// Verified: all sub_* tables have "value" and "timestamp" columns
function discoverSchema(table){
  // Return cached or hardcoded schema â€” no network call needed
  if(!S.schema[table]) S.schema[table]={tsCol:'timestamp', valCol:'value'};
  return Promise.resolve(S.schema[table]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONNECT / DISCONNECT / PAUSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btnGo').addEventListener('click', async()=>{
  if(S.running){stopAll();return;}
  logCall({method:'POST',path:'UI',status:200,dur:0,rowCnt:0,type:'ui',
    detail:`CONNECT: Testing ${proxy()}/api/statusâ€¦`,table:''});
  setDot('pend');
  const h=await apiStatus();
  // Bridge returns status:"running" â€” accept any truthy status value
  if(!h){
    setDot('err');
    document.getElementById('connLbl').textContent='Failed';
    logCall({method:'POST',path:'UI',status:0,dur:0,rowCnt:0,type:'ui',
      detail:'CONNECT: Cannot reach proxy â€” run: python3 mcp_web_bridge.py',table:'',error:new Error('Cannot reach proxy')});
    return;
  }
  setDot('ok');
  document.getElementById('connLbl').textContent=proxy();
  document.getElementById('stProxy').textContent=proxy();
  document.getElementById('stDb').textContent=db();
  document.getElementById('btnGo').textContent='â¹ DISCONNECT';
  document.getElementById('btnGo').classList.add('stop');
  document.getElementById('btnPause').disabled=false;
  S.running=true;S.paused=false;
  buildLayout();
  startPolling();
});

document.getElementById('btnPause').addEventListener('click',()=>{
  if(!S.running) return;
  S.paused=!S.paused;
  const btn=document.getElementById('btnPause');
  if(S.paused){
    btn.textContent='â–¶ RESUME';btn.classList.add('on');
    clearInterval(S.timer);clearInterval(S.cdTimer);
    document.getElementById('stNext').textContent='PAUSED';
    logCall({method:'POST',path:'UI',status:200,dur:0,rowCnt:0,type:'ui',detail:'PAUSE: Polling suspended',table:''});
  }else{
    btn.textContent='â¸ PAUSE';btn.classList.remove('on');
    logCall({method:'POST',path:'UI',status:200,dur:0,rowCnt:0,type:'ui',detail:'RESUME: Polling resumed',table:''});
    startPolling();
  }
});

function stopAll(){
  S.running=false;S.paused=false;
  clearInterval(S.timer);clearInterval(S.cdTimer);
  setDot('');
  document.getElementById('connLbl').textContent='Disconnected';
  document.getElementById('btnGo').textContent='âš¡ CONNECT';
  document.getElementById('btnGo').classList.remove('stop');
  document.getElementById('btnPause').disabled=true;
  document.getElementById('btnPause').classList.remove('on');
  document.getElementById('btnPause').textContent='â¸ PAUSE';
  document.getElementById('stNext').textContent='â€”';
  logCall({method:'POST',path:'UI',status:200,dur:0,rowCnt:0,type:'ui',detail:'DISCONNECT: Stopped',table:''});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPolling(){
  clearInterval(S.timer);clearInterval(S.cdTimer);
  pollAll();
  const iv=parseInt(document.getElementById('cfgPoll').value);
  S.timer=setInterval(pollAll,iv);
  let rem=iv/1000;
  S.cdTimer=setInterval(()=>{
    if(!S.paused){rem--;if(rem<=0)rem=iv/1000;}
    document.getElementById('stNext').textContent=S.paused?'PAUSED':`${rem}s`;
  },1000);
}

// Concurrency-limited pool â€” run at most N queries simultaneously to avoid MCP overload
async function pooled(tasks, concurrency=3){
  const results=[];
  let i=0;
  async function worker(){
    while(i<tasks.length){
      const idx=i++;
      results[idx]=await tasks[idx]();
    }
  }
  await Promise.all(Array.from({length:Math.min(concurrency,tasks.length)},worker));
  return results;
}

async function pollAll(){
  if(!S.running||S.paused) return;
  if(S.polling){return;}  // prevent overlapping polls
  S.polling=true;
  document.getElementById('stLast').textContent=nowStr();
  S.alerts=[];

  // Flatten all metrics across all processes into a single task list
  const allMetrics=[];
  PROCESSES.forEach(proc=>proc.metrics.forEach(m=>allMetrics.push({m,proc})));

  // ONE query per sensor (DESC LIMIT for trend; reuse same rows for Ïƒ baseline)
  // Concurrency=3 so at most 3 simultaneous MCP queries â€” prevents timeout pileup
  await pooled(allMetrics.map(({m,proc})=>async()=>{
    const h=S.history[m.table];
    const sql=`SELECT value, timestamp FROM ${m.table} ORDER BY timestamp DESC LIMIT ${trendLimit()}`;
    const rows=await apiTrend(m.table, sql);
    if(rows&&rows.length>0){
      const chrono=[...rows].reverse();
      h.ts=[];h.vals=[];
      chrono.forEach(r=>{
        const ts=new Date(r.timestamp||r.ts||r.time);
        const val=parseFloat(r.value??r.v);
        if(!isNaN(val)&&!isNaN(ts.getTime())){h.ts.push(ts);h.vals.push(val);}
      });
      // Use all fetched rows as the Ïƒ baseline (larger window = better statistics)
      h.baseVals=[...h.vals];
    } else {
      // No new data â€” keep existing vals for chart, compute SPC from what we have
      if(h.vals.length) h.baseVals=[...h.vals];
    }
    calcSPC(h);
    detectAlerts(m, proc);
    redrawChart(m, proc);
  }), 3);

  // Update bottleneck badges and alerts after all queries done
  PROCESSES.forEach(proc=>updateBnBadge(proc));
  renderAlerts();
  S.polling=false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPC MATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcSPC(h){
  const src=(h.baseVals&&h.baseVals.length>=MIN_SPC)?h.baseVals:h.vals;
  if(src.length<MIN_SPC){
    h.mean=h.std=h.ucl=h.lcl=h.sigma1H=h.sigma1L=h.sigma2H=h.sigma2L=null;return;
  }
  const n=src.length;
  const mean=src.reduce((a,b)=>a+b,0)/n;
  const std=Math.sqrt(src.reduce((s,v)=>s+Math.pow(v-mean,2),0)/n);
  h.mean=mean;h.std=std;
  h.ucl=mean+3*std;    h.lcl=mean-3*std;
  h.sigma2H=mean+2*std; h.sigma2L=mean-2*std;
  h.sigma1H=mean+std;   h.sigma1L=mean-std;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WESTERN ELECTRIC RULES â€” 5 rules
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function detectAlerts(m, proc){
  const h=S.history[m.table];
  if(!h.ucl||!h.vals.length) return;
  const v=h.vals.at(-1);
  const push=(sev,msg,rule)=>{
    S.alerts.push({sev,procKey:proc.key,procName:proc.name,procIcon:proc.icon||'',
      tag:m.label,table:m.table,unit:m.unit,msg,rule,ts:new Date()});
    if(S.alerts.length>MAX_ALERT) S.alerts.pop();
  };
  // Rule 1 â€” beyond 3Ïƒ
  if(v>h.ucl)      push('critical',`${v.toFixed(4)} ${m.unit} > UCL ${h.ucl.toFixed(4)}`,'Rule 1: Beyond 3Ïƒ upper limit');
  else if(v<h.lcl) push('critical',`${v.toFixed(4)} ${m.unit} < LCL ${h.lcl.toFixed(4)}`,'Rule 1: Beyond 3Ïƒ lower limit');
  // Rule 2 â€” 8 consecutive same side
  if(h.vals.length>=8){
    const r8=h.vals.slice(-8);
    if(r8.every(x=>x>h.mean))      push('warning','8 consecutive pts above mean','Rule 2: Process shift â†‘');
    else if(r8.every(x=>x<h.mean)) push('warning','8 consecutive pts below mean','Rule 2: Process shift â†“');
  }
  // Rule 3 â€” 6 consecutive trending
  if(h.vals.length>=6){
    const r6=h.vals.slice(-6);
    if(r6.every((x,i)=>i===0||x>r6[i-1]))      push('warning','6 pts consecutive rising','Rule 3: Upward trend â†‘');
    else if(r6.every((x,i)=>i===0||x<r6[i-1])) push('warning','6 pts consecutive falling','Rule 3: Downward trend â†“');
  }
  // Rule 4 â€” 2 of 3 beyond 2Ïƒ
  if(h.vals.length>=3&&h.std){
    if(h.vals.slice(-3).filter(x=>Math.abs(x-h.mean)>2*h.std).length>=2)
      push('minor','2 of 3 pts beyond 2Ïƒ','Rule 4: Increased variation');
  }
  // Rule 5 â€” 4 of 5 beyond 1Ïƒ
  if(h.vals.length>=5&&h.std){
    if(h.vals.slice(-5).filter(x=>Math.abs(x-h.mean)>h.std).length>=4)
      push('minor','4 of 5 pts beyond 1Ïƒ','Rule 5: Approaching control limit');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOTTLENECK ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getBottleneck(proc){
  let worst=null,worstScore=-1;
  proc.metrics.forEach(m=>{
    const h=S.history[m.table];
    if(!h.vals.length) return;
    let score=0,detail='';
    if(h.std&&h.mean&&Math.abs(h.mean)>0.0001){
      const cv=(h.std/Math.abs(h.mean))*100;
      score+=cv;detail=`CV=${cv.toFixed(1)}%`;
    }
    const al=S.alerts.filter(a=>a.table===m.table);
    const crit=al.filter(a=>a.sev==='critical').length;
    const warn=al.filter(a=>a.sev==='warning').length;
    score+=crit*30+warn*10;
    if(crit>0) detail+=(detail?' ':'')+`${crit} crit`;
    if(score>worstScore){worstScore=score;worst={m,score,detail};}
  });
  return worst;
}

function bnLevel(s){return s>40?'high':s>12?'low':'none';}

function updateBnBadge(proc){
  const badge=document.getElementById(`bn_${proc.key}`);
  const row  =document.getElementById(`bnrow_${proc.key}`);
  if(!badge) return;
  const bn=getBottleneck(proc);
  if(!bn||bn.score<1){
    badge.className='bnbadge none';badge.textContent='âœ“ FLOW NORMAL';
    if(row) row.style.display='none';return;
  }
  const lvl=bnLevel(bn.score);
  badge.className=`bnbadge ${lvl}`;
  badge.textContent=(lvl==='high'?'âš  BOTTLENECK: ':'â–³ WATCH: ')+bn.m.label;
  if(row){
    row.style.display='flex';
    row.className=`bn-row ${lvl==='high'?'':'warn'}`;
    row.innerHTML=`
      <span class="bn-lbl ${lvl==='high'?'high':'warn'}">${lvl.toUpperCase()}</span>
      <span class="bn-desc">${esc(bn.m.label)} (${esc(bn.m.unit)}) â€” ${bn.detail||'high variability'}</span>
      <span class="bn-val">${esc(bn.m.table)}</span>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LAYOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLayout(){
  const pane=document.getElementById('chartsPane');
  pane.innerHTML='';

  // Chart view range slider
  const rng=document.createElement('div');
  rng.className='rng-bar';
  rng.innerHTML=`
    <span>Chart View:</span>
    <input type="range" id="cvsSlider" min="5" max="1440" value="${chartViewMinutes}" step="5"
      oninput="onRangeChange(this.value)"/>
    <span class="rng-val" id="cvsLbl">${fmtMin(chartViewMinutes)}</span>
    <span style="color:#1e3a5a;font-size:9px;">scrollable time window</span>`;
  pane.appendChild(rng);

  PROCESSES.forEach(proc=>{
    const blk=document.createElement('div');
    blk.className='pblk';
    blk.style.borderColor=proc.color+'28';
    blk.innerHTML=`
      <div class="phdr" style="border-left-color:${proc.color}">
        <span class="pname">${proc.icon||''} ${esc(proc.name)}</span>
        <div class="phdr-right">
          <span class="bnbadge none" id="bn_${proc.key}">âœ“ FLOW NORMAL</span>
        </div>
      </div>
      <div class="bn-row" id="bnrow_${proc.key}" style="display:none;"></div>
      <div class="cgrid" id="grid_${proc.key}"></div>`;
    pane.appendChild(blk);

    const grid=blk.querySelector(`#grid_${proc.key}`);
    proc.metrics.forEach(m=>{
      const cell=document.createElement('div');
      cell.className='ccell';
      cell.id=`cell_${m.table}`;
      cell.innerHTML=`
        <div class="chdr">
          <div>
            <div class="cname">${esc(m.label)}</div>
            <div class="ctbl">${esc(m.table)}</div>
          </div>
          <div class="cstats">
            <div class="stat"><div class="sv u" id="ucl_${m.table}">â€”</div><div class="sk">UCL 3Ïƒ</div></div>
            <div class="stat"><div class="sv m" id="avg_${m.table}">â€”</div><div class="sk">Mean</div></div>
            <div class="stat"><div class="sv l" id="lcl_${m.table}">â€”</div><div class="sk">LCL 3Ïƒ</div></div>
            <div class="stat"><div class="sv-last n" id="last_${m.table}">â€”</div><div class="sk">${esc(m.unit)}</div></div>
          </div>
        </div>
        <div class="crange" id="crange_${m.table}"></div>
        <div id="plt_${m.table}" style="height:150px;"></div>`;
      grid.appendChild(cell);
    });
  });
}

function onRangeChange(v){
  chartViewMinutes=parseInt(v);
  document.getElementById('cvsLbl').textContent=fmtMin(chartViewMinutes);
  PROCESSES.forEach(proc=>proc.metrics.forEach(m=>redrawChart(m,proc)));
}

function fmtMin(m){
  if(m<60) return `${m}m`;
  const h=Math.floor(m/60),rem=m%60;
  return rem?`${h}h${rem}m`:`${h}h`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART DRAWING â€” SPC trend + Ïƒ lines + shaded bands
// View window is controlled by the scrollable slider
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function redrawChart(m, proc){
  const h=S.history[m.table];
  const id=`plt_${m.table}`;
  const el=document.getElementById(id);
  if(!el||!h.ts.length) return;

  // Use data's own latest timestamp as reference (data may be historical, not live)
  const dataEnd=h.ts.at(-1);
  const winStart=new Date(dataEnd.getTime()-chartViewMinutes*60*1000);

  // Filter to view window relative to data's own time range
  const visTs=[],visVals=[];
  h.ts.forEach((t,i)=>{if(t>=winStart){visTs.push(t);visVals.push(h.vals[i]);}});
  if(!visTs.length){visTs.push(h.ts.at(-1));visVals.push(h.vals.at(-1));}

  const f=v=>v!=null?v.toFixed(3):'â€”';
  const lastVal=h.vals.at(-1);

  document.getElementById(`ucl_${m.table}`).textContent=f(h.ucl);
  document.getElementById(`avg_${m.table}`).textContent=f(h.mean);
  document.getElementById(`lcl_${m.table}`).textContent=f(h.lcl);

  const lastEl=document.getElementById(`last_${m.table}`);
  if(lastEl&&lastVal!==undefined){
    lastEl.textContent=f(lastVal);
    let cls='n';
    if(h.ucl!=null){
      if(lastVal>h.ucl||lastVal<h.lcl)                            cls='c';
      else if(h.sigma2H&&(lastVal>h.sigma2H||lastVal<h.sigma2L)) cls='w';
      else                                                          cls='ok';
    }
    lastEl.className=`sv-last ${cls}`;
  }

  const rl=document.getElementById(`crange_${m.table}`);
  if(rl&&visTs.length>1)
    rl.textContent=`${visTs[0].toLocaleTimeString()}â€“${visTs.at(-1).toLocaleTimeString()} Â· ${visTs.length} pts Â· Ïƒ-base: ${baseline()}`;

  const cell=document.getElementById(`cell_${m.table}`);
  if(cell){
    const a=S.alerts.find(al=>al.table===m.table);
    cell.classList.remove('crit-hi','warn-hi');
    if(a) cell.classList.add(a.sev==='critical'?'crit-hi':'warn-hi');
  }

  const procColor=(proc&&proc.color)||'#00d4ff';
  const colors=visVals.map(v=>{
    if(!h.ucl) return '#00d4ff';
    if(v>h.ucl||v<h.lcl)                          return '#f85149';
    if(h.std&&Math.abs(v-h.mean)>2*h.std)         return '#e3b341';
    if(h.std&&Math.abs(v-h.mean)>h.std)           return '#58a6ff';
    return '#00d4ff';
  });
  const sizes=visVals.map(v=>{
    if(!h.ucl) return 3;
    if(v>h.ucl||v<h.lcl)              return 8;
    if(h.std&&Math.abs(v-h.mean)>2*h.std) return 5;
    return 3;
  });

  const traces=[{
    x:visTs,y:visVals,mode:'lines+markers',name:m.label,
    line:{color:`${procColor}55`,width:1.5},
    marker:{size:sizes,color:colors,symbol:'circle',
      line:{color:colors.map(c=>c==='#00d4ff'?'transparent':c),width:1.5}},
    hovertemplate:`<b>%{y:.4f} ${esc(m.unit)}</b><br>%{x}<extra>${esc(m.label)}</extra>`
  }];

  if(h.ucl!=null){
    const x0=visTs[0],x1=visTs.at(-1);
    const rl2=(y,col,dash,nm,w)=>({
      x:[x0,x1],y:[y,y],mode:'lines',name:nm,showlegend:false,hoverinfo:'skip',
      line:{color:col,width:w??1,dash}
    });
    traces.push(rl2(h.ucl,    '#f85149','dash','UCL 3Ïƒ',1.5));
    traces.push(rl2(h.lcl,    '#f85149','dash','LCL 3Ïƒ',1.5));
    traces.push(rl2(h.sigma2H,'#e3b341','dot', '+2Ïƒ',1));
    traces.push(rl2(h.sigma2L,'#e3b341','dot', '-2Ïƒ',1));
    traces.push(rl2(h.sigma1H,'#58a6ff','dot', '+1Ïƒ (normal range)',1));
    traces.push(rl2(h.sigma1L,'#58a6ff','dot', '-1Ïƒ (normal range)',1));
    traces.push(rl2(h.mean,   '#00ff9d','dot', 'Mean',1.5));

    // Â±1Ïƒ normal variation band (shaded)
    traces.push({
      x:[...visTs,...[...visTs].reverse()],
      y:[...Array(visTs.length).fill(h.sigma1H),...Array(visTs.length).fill(h.sigma1L).reverse()],
      fill:'toself',fillcolor:`${procColor}08`,
      line:{color:'transparent'},hoverinfo:'skip',showlegend:false,name:'Normal band (Â±1Ïƒ)'
    });
    // 1Ïƒâ€“2Ïƒ warning zone
    traces.push({
      x:[...visTs,...[...visTs].reverse()],
      y:[...Array(visTs.length).fill(h.sigma2H),...Array(visTs.length).fill(h.sigma1H).reverse()],
      fill:'toself',fillcolor:'rgba(227,179,65,0.04)',
      line:{color:'transparent'},hoverinfo:'skip',showlegend:false,name:'Warning zone (1Ïƒâ€“2Ïƒ)'
    });
  }

  const layout={
    height:150, margin:{l:44,r:5,t:2,b:20},
    paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',
    font:{color:'#1e3a5a',size:8,family:'Share Tech Mono'},
    xaxis:{
      gridcolor:'rgba(255,255,255,0.025)',linecolor:'#182e44',zeroline:false,
      tickcolor:'#182e44',tickfont:{size:8},range:[winStart,dataEnd]
    },
    yaxis:{gridcolor:'rgba(255,255,255,0.025)',linecolor:'#182e44',zeroline:false,
      tickcolor:'#182e44',tickfont:{size:8}},
    showlegend:false,hovermode:'closest'
  };

  el._p
    ? Plotly.react(id,traces,layout,{responsive:true,displayModeBar:false})
    : Plotly.newPlot(id,traces,layout,{responsive:true,displayModeBar:false}).then(()=>el._p=true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS RENDER â€” grouped by process, most critical process first
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAlerts(){
  const pane=document.getElementById('alertsPane');
  const sevOrd={critical:0,warning:1,minor:2};
  document.getElementById('aTotalBadge').textContent=S.alerts.length?`${S.alerts.length} total`:'';

  if(!S.alerts.length){
    pane.innerHTML='<div class="empty">âœ“ No special cause alerts detected</div>';return;
  }

  const byProc={};
  PROCESSES.forEach(p=>{byProc[p.key]=[];});
  S.alerts.forEach(a=>{if(byProc[a.procKey]) byProc[a.procKey].push(a);});

  const sorted=[...PROCESSES].sort((a,b)=>{
    const aMin=Math.min(...(byProc[a.key].length?byProc[a.key].map(x=>sevOrd[x.sev]):[99]));
    const bMin=Math.min(...(byProc[b.key].length?byProc[b.key].map(x=>sevOrd[x.sev]):[99]));
    return aMin-bMin;
  });

  let html='';
  sorted.forEach(proc=>{
    const alerts=byProc[proc.key];
    if(!alerts.length) return;
    alerts.sort((a,b)=>sevOrd[a.sev]-sevOrd[b.sev]);
    const crits=alerts.filter(a=>a.sev==='critical').length;
    const warns=alerts.filter(a=>a.sev==='warning').length;
    const badge=[
      crits?`<span style="color:#f85149;">${crits} CRIT</span>`:'',
      warns?`<span style="color:#e3b341;">${warns} WARN</span>`:''
    ].filter(Boolean).join(' ');

    html+=`<div class="proc-alerts">
      <div class="proc-alert-hdr" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'':'none'">
        <span>${proc.icon||''} ${esc(proc.name)}</span>
        <span style="font-size:8px;font-family:'Share Tech Mono',monospace;">${badge||alerts.length+' alerts'}</span>
      </div>
      <div class="proc-alert-body">
        ${alerts.slice(0,30).map(a=>`
        <div class="arow">
          <div class="sev ${a.sev}">${a.sev.toUpperCase()}</div>
          <div>
            <div class="atag">${esc(a.tag)}</div>
            <div class="amsg">${esc(a.msg)}</div>
            <div class="arule">${esc(a.rule)} Â· ${nowStr(a.ts)}</div>
          </div>
        </div>`).join('')}
        ${alerts.length>30?`<div class="no-alerts">+${alerts.length-30} moreâ€¦</div>`:''}
      </div>
    </div>`;
  });
  pane.innerHTML=html||'<div class="empty">No alerts</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOG â€” exact same mechanism as enterprise_c_spc.html
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const callLog=[];
let logStats={total:0,ok:0,err:0,rows:0};
const rowsByTable={};
let logOpen=false;
let logFilter='all';
let nextLogId=0;

function toggleLogOpen(){
  logOpen=!logOpen;
  const inner=document.getElementById('logInner');
  const caret=document.getElementById('logCaret');
  if(inner) inner.style.display=logOpen?'':'none';
  if(caret) caret.classList.toggle('open',logOpen);
  if(logOpen) rebuildLogBody();
}
function setLogFilter(f){
  logFilter=f;
  ['all','get','post','error'].forEach(k=>{
    const b=document.getElementById('lf-'+k);
    if(b) b.classList.toggle('active',k===f);
  });
  applyLogFilters();
}
function filterLog(){applyLogFilters();}
function applyLogFilters(){
  const search=(document.getElementById('logSearch')?.value||'').toLowerCase();
  document.querySelectorAll('#logBody .log-entry').forEach(el=>{
    const method=el.dataset.method||'';
    const ok=el.dataset.ok;
    const srch=el.dataset.search||'';
    let visible=true;
    if(logFilter==='get')    visible=method==='get';
    else if(logFilter==='post')   visible=method==='post';
    else if(logFilter==='error')  visible=ok==='false';
    if(visible&&search) visible=srch.includes(search);
    el.classList.toggle('hidden',!visible);
  });
}
function clearLog(){
  callLog.length=0;logStats={total:0,ok:0,err:0,rows:0};
  for(const k of Object.keys(rowsByTable)) delete rowsByTable[k];
  nextLogId=0;updateLogStats();updateRowSummary();
  const body=document.getElementById('logBody');if(body) body.innerHTML='';
}
function logCall(entry){
  const id=nextLogId++;
  const ok=!entry.error&&entry.status>=200&&entry.status<300;
  const rec={id,ts:new Date(),ok,...entry};
  callLog.unshift(rec);
  if(callLog.length>MAX_LOG) callLog.pop();
  logStats.total++;
  if(ok) logStats.ok++;else logStats.err++;
  logStats.rows+=rec.rowCnt||0;
  if(rec.table&&rec.rowCnt>0) rowsByTable[rec.table]=(rowsByTable[rec.table]||0)+rec.rowCnt;
  updateLogStats();updateRowSummary();
  if(logOpen) prependLogRow(rec);
}
function updateLogStats(){
  setText2('log-total',`${logStats.total} call${logStats.total!==1?'s':''}`);
  setText2('log-ok',   `${logStats.ok} ok`);
  setText2('log-err',  `${logStats.err} err`);
  setText2('log-rows', `${logStats.rows} rows`);
}
function setText2(id,val){const el=document.getElementById(id);if(el) el.textContent=val;}
function updateRowSummary(){
  const el=document.getElementById('rowSumContent');if(!el) return;
  const ent=Object.entries(rowsByTable);
  if(!ent.length){el.innerHTML='<span style="color:#484f58;">â€” No data yet â€”</span>';return;}
  el.innerHTML=ent.sort((a,b)=>b[1]-a[1]).slice(0,12).map(([tbl,cnt])=>
    `<span class="row-tbl"><span class="row-tbl-name">${esc(tbl)}</span><span class="row-tbl-sep">â†’</span><span class="row-tbl-cnt">${Number(cnt).toLocaleString()}</span></span>`
  ).join('<span class="row-tbl-sep" style="margin:0 3px;">|</span>');
}
function rebuildLogBody(){
  const body=document.getElementById('logBody');if(!body) return;
  body.innerHTML=callLog.slice(0,250).map(renderLogRowHtml).join('');
  applyLogFilters();
}
function prependLogRow(rec){
  const body=document.getElementById('logBody');if(!body) return;
  body.insertAdjacentHTML('afterbegin',renderLogRowHtml(rec));
  const nodes=body.querySelectorAll('.log-entry');
  if(nodes.length>250) nodes[nodes.length-1].remove();
  applyLogFilters();
}
function renderLogRowHtml(rec){
  const t=rec.ts.toLocaleTimeString('en-US',{hour12:false});
  const method=(rec.method||'').toUpperCase();
  const mCls=method==='GET'?'m-get':'m-post';
  const stOk=rec.ok?'s-ok':'s-err';
  const dur=rec.dur?`${Math.round(rec.dur)}ms`:'';
  const rows=rec.rowCnt?rec.rowCnt.toLocaleString():'â€”';
  const table=rec.table||'â€”';
  const path=esc(rec.path||'');
  const detail=esc(rec.detail||'');
  const search=(rec.table||'')+' '+(rec.path||'')+' '+(rec.detail||'');
  const okAttr=rec.ok?'true':'false';
  return `<div class="log-entry ${rec.ok?'log-ok':'log-err'}" data-method="${method.toLowerCase()}" data-ok="${okAttr}" data-search="${esc(search).toLowerCase()}">
    <span class="le-time">${t}</span>
    <span class="le-method ${mCls}">${method}</span>
    <span class="le-status ${stOk}">${rec.status||0}</span>
    <span class="le-dur">${dur}</span>
    <span class="le-path" title="${path}">${path}</span>
    <span class="le-rows" title="${detail}">${rows}</span>
    <span class="le-detail" title="${esc(table)}">${esc(table)}</span>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){
  return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function setDot(cls){document.getElementById('dot').className='dot'+(cls?' '+cls:'');}
function sbar(){
  document.getElementById('stQ').textContent=S.queries;
  document.getElementById('stR').textContent=S.rows;
  document.getElementById('stE').textContent=S.errors;
}
function nowStr(d=new Date()){return d.toLocaleTimeString('en-US',{hour12:false});}
</script>
</body>
</html>
